---
description: Work on a single story - loads memory, spawns agents, marks complete when done
argument-hint: <prd-file> <story-id>
---

# Flow Work Story

Process a single story through the Maven 10-Step Workflow with memory loading and agent spawning.

## Arguments

1. **prd-file**: Path to PRD JSON file (e.g., `docs/prd-auth.json`)
2. **story-id**: Story ID to work on (e.g., `US-001`)

## Execution Steps

### 1. Read Story Details

```bash
# Extract story info from PRD
cat <prd-file> | jq '.userStories[] | select(.id == "<story-id>")'
```

Get:
- Story title
- Description
- Acceptance criteria
- mavenSteps array
- mcpTools configuration

### 2. MEMORY LOADING PHASE (CRITICAL)

**Step 2a: Load related PRDs consolidated memory**

```bash
# Get related PRDs
cat <prd-file> | jq '.relatedPRDs'
```

For each related PRD:
1. Find consolidated memory: `docs/consolidated-[feature].md`
2. Read and extract key patterns (architecture, integration points, lessons)
3. Build context summary (~3K tokens max)

**Step 2b: Load previous story memories**

```bash
# Find feature directory and story memories
feature=$(basename <prd-file> .json | sed 's/prd-//')
find docs/$feature/story-*.txt -type f | sort
```

For each previous story memory:
1. Read the memory file
2. Extract: what was built, decisions made, integration points, lessons
3. Build context summary (~10K tokens max total)

### 3. Process Each Maven Step

For each step in `mavenSteps`:

**Determine agent type:**
- Steps 1, 2, 7, 9 → development-agent
- Steps 3, 4, 6 → refactor-agent
- Step 5 → quality-agent
- Steps 8, 10 → security-agent
- Step 11 → design-agent (optional)

**Spawn the agent using natural language:**

```
Use the [agent-type] to work on Step [N] of Maven Workflow for story: [STORY-ID - Story Title]

PRD: <prd-file>
MCPs to use: [from mcpTools.mcpTools.step[N]]

## CONTEXT FROM RELATED PRDs:
[Consolidated memory summaries]

## CONTEXT FROM PREVIOUS STORIES:
[Story memory summaries from this PRD]

## Your Task (Step [N]):
[Acceptance criteria and requirements]

## Quality Standards (ZERO TOLERANCE):
- No 'any' types - use proper TypeScript
- No gradients - use solid professional colors
- No relative imports - use @/ aliases
- Components < 300 lines

When complete, output: [STEP_COMPLETE]
```

**Wait for agent completion** before proceeding to next step.

### 4. Completion Steps (After all steps done)

1. **Run typecheck:**
   ```bash
   pnpm run typecheck
   # or: pnpm tsc
   ```

2. **Update PRD - mark story complete:**
   ```bash
   # Use jq or node to update passes: true
   cat <prd-file> | jq "(.userStories[] | select(.id == \"<story-id>\") | .passes) = true" > tmp.json
   mv tmp.json <prd-file>
   ```

3. **Commit changes:**
   ```bash
   git add -A
   git commit -m "feat: [STORY-ID] [story-title]"
   ```

4. **Output completion marker:**
   ```
   <STORY_COMPLETE>
   ```

## Example Usage

```
/flow-work-story docs/prd-auth.json US-001
```

This will:
1. Load memory from related PRDs
2. Load memory from previous stories in prd-auth
3. Process US-001 through all its mavenSteps
4. Mark US-001 complete and commit
5. Output `<STORY_COMPLETE>`
