#!/bin/bash
# ============================================
# NextMavens Platform - Start All Services
# ============================================

set -e

echo "=========================================="
echo "NextMavens Platform - Starting Services"
echo "=========================================="
echo ""

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if .env exists
if [ ! -f .env ]; then
    echo -e "${RED}Error: .env file not found!${NC}"
    echo "Please create .env from .env.example first"
    exit 1
fi

# Load environment variables
export $(grep -v '^#' .env | xargs)

# Check Docker
echo -e "${YELLOW}Checking Docker installation...${NC}"
if ! command -v docker &> /dev/null; then
    echo -e "${RED}Docker is not installed!${NC}"
    exit 1
fi

# Create logs directory
mkdir -p logs

# ============================================
# Start Supabase Services
# ============================================
echo ""
echo -e "${YELLOW}Starting Supabase services...${NC}"

if [ -f "docker/supabase.yml" ]; then
    # Use docker compose (newer syntax) or docker-compose (older)
    if docker compose version &> /dev/null; then
        docker compose -f docker/supabase.yml up -d
    else
        docker-compose -f docker/supabase.yml up -d
    fi
    echo -e "${GREEN}Supabase services started!${NC}"
else
    echo -e "${RED}docker/supabase.yml not found!${NC}"
fi

# ============================================
# Start Evolution API
# ============================================
echo ""
echo -e "${YELLOW}Starting Evolution API (WhatsApp)...${NC}"

if [ -f "docker/evolution.yml" ]; then
    if docker compose version &> /dev/null; then
        docker compose -f docker/evolution.yml up -d
    else
        docker-compose -f docker/evolution.yml up -d
    fi
    echo -e "${GREEN}Evolution API started!${NC}"
else
    echo -e "${RED}docker/evolution.yml not found!${NC}"
fi

# ============================================
# Wait for services to be healthy
# ============================================
echo ""
echo -e "${YELLOW}Waiting for services to be ready...${NC}"
sleep 10

# ============================================
# Show Service Status
# ============================================
echo ""
echo "=========================================="
echo "Service Status"
echo "=========================================="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAME|supabase|evolution"

echo ""
echo "=========================================="
echo "Access URLs"
echo "=========================================="
echo "Supabase Studio:    http://localhost:8000"
echo "Supabase API:       http://localhost:4003"
echo "Realtime:           http://localhost:4001"
echo "Storage:            http://localhost:4002"
echo "Kong Admin:         http://localhost:8001"
echo "Evolution API:      http://localhost:8080"
echo ""
echo "=========================================="
echo -e "${GREEN}All services started successfully!${NC}"
echo "=========================================="
echo ""
echo "Next steps:"
echo "  1. Visit http://localhost:8000 to access Supabase Studio"
echo "  2. Initialize the database schema"
echo "  3. Start the dashboard: cd dashboard && npm run dev"
echo ""
