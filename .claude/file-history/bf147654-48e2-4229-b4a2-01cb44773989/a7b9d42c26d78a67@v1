// NextMavens Platform API - Organizations Endpoint
// POST /api/orgs - Create organization
// GET /api/orgs - List user's organizations

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { slugify } from '../lib/utils';
import type { Organization, CreateOrganizationInput } from '../types';

const supabaseUrl = process.env.SUPABASE_URL || 'http://localhost:8000';
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

// Helper to get authenticated user
async function getAuthenticatedUser(req: NextRequest) {
  const authHeader = req.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return null;
  }

  const token = authHeader.substring(7);
  const supabase = createClient(supabaseUrl, supabaseServiceKey);
  const { data: { user }, error } = await supabase.auth.getUser(token);

  if (error || !user) {
    return null;
  }

  return user;
}

// GET /api/orgs - List organizations
export async function GET(req: NextRequest) {
  try {
    const user = await getAuthenticatedUser(req);
    if (!user) {
      return NextResponse.json({ error: { code: 'UNAUTHORIZED', message: 'Invalid or missing token' } }, { status: 401 });
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Get organizations where user is a member
    const { data: memberships, error: memberError } = await supabase
      .from('organization_members')
      .select('organization_id, role')
      .eq('user_id', user.id);

    if (memberError) {
      throw memberError;
    }

    const orgIds = memberships?.map(m => m.organization_id) || [];

    if (orgIds.length === 0) {
      return NextResponse.json({ items: [], total: 0 });
    }

    const { data: organizations, error: orgError } = await supabase
      .from('organizations')
      .select('*')
      .in('id', orgIds)
      .order('created_at', { ascending: false });

    if (orgError) {
      throw orgError;
    }

    // Merge membership roles
    const items = organizations?.map(org => ({
      ...org,
      role: memberships?.find(m => m.organization_id === org.id)?.role
    })) || [];

    return NextResponse.json({ items, total: items.length });
  } catch (error: unknown) {
    console.error('Error fetching organizations:', error);
    return NextResponse.json(
      { error: { code: 'INTERNAL_ERROR', message: error instanceof Error ? error.message : 'Failed to fetch organizations' } },
      { status: 500 }
    );
  }
}

// POST /api/orgs - Create organization
export async function POST(req: NextRequest) {
  try {
    const user = await getAuthenticatedUser(req);
    if (!user) {
      return NextResponse.json({ error: { code: 'UNAUTHORIZED', message: 'Invalid or missing token' } }, { status: 401 });
    }

    const body = await req.json() as CreateOrganizationInput;

    // Validate input
    if (!body.name || body.name.trim().length < 2) {
      return NextResponse.json({ error: { code: 'VALIDATION_ERROR', message: 'Name must be at least 2 characters' } }, { status: 400 });
    }

    if (body.name.length > 100) {
      return NextResponse.json({ error: { code: 'VALIDATION_ERROR', message: 'Name must be less than 100 characters' } }, { status: 400 });
    }

    const slug = body.slug || slugify(body.name);

    // Validate slug format
    if (!/^[a-z0-9-]+$/.test(slug)) {
      return NextResponse.json({ error: { code: 'VALIDATION_ERROR', message: 'Slug must contain only lowercase letters, numbers, and hyphens' } }, { status: 400 });
    }

    const supabase = createClient(supabaseUrl, supabaseServiceKey);

    // Check if slug is already taken
    const { data: existing } = await supabase
      .from('organizations')
      .select('id')
      .eq('slug', slug)
      .single();

    if (existing) {
      return NextResponse.json({ error: { code: 'SLUG_TAKEN', message: 'An organization with this slug already exists' } }, { status: 409 });
    }

    // Create organization
    const { data: org, error: orgError } = await supabase
      .from('organizations')
      .insert({
        name: body.name.trim(),
        slug,
        logo_url: body.logo_url,
      })
      .select()
      .single();

    if (orgError) {
      throw orgError;
    }

    // Add creator as owner
    const { error: memberError } = await supabase
      .from('organization_members')
      .insert({
        organization_id: org.id,
        user_id: user.id,
        role: 'owner',
        invited_by: user.id,
      });

    if (memberError) {
      // Rollback organization creation
      await supabase.from('organizations').delete().eq('id', org.id);
      throw memberError;
    }

    return NextResponse.json({ success: true, data: { ...org, role: 'owner' } }, { status: 201 });
  } catch (error: unknown) {
    console.error('Error creating organization:', error);
    return NextResponse.json(
      { error: { code: 'INTERNAL_ERROR', message: error instanceof Error ? error.message : 'Failed to create organization' } },
      { status: 500 }
    );
  }
}
