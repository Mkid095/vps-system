---
project: WhatsApp Integration (Evolution API)
branch: flow/whatsapp-integration
availableMCPs:
  - supabase
  - chrome-devtools
  - web-search-prime
---

# WhatsApp Integration (Evolution API)

## Overview
Self-host Evolution API v2.3.7 via Docker with multi-instance support. One WhatsApp instance per project/client. QR-based number connection, webhook support for real-time messages, and MCP server for Claude integration.

## Technical Approach
- Evolution API v2.3.7 (pinned for stability)
- Multi-instance: `POST /instance/create` with {instanceName, qrcode: true}
- QR endpoint: `GET /instance/connect/qr/{instanceName}` → returns base64
- Status endpoint: `GET /instance/status/{instanceName}` → includes phone number
- Message endpoint: `POST /message/sendText/{instanceName}`
- Webhook → Next.js API route → Supabase insert → Realtime broadcast
- MCP server: stdio wrapper for Claude Desktop

## User Stories

### US-001: Create WhatsApp Instance
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["chrome-devtools"]

As a project owner, I want to create a WhatsApp instance so that my application can send and receive messages.

**Acceptance Criteria:**
- Dashboard form: instance name
- Calls Evolution API: POST /instance/create
- Instance stored in database with status=pending
- Returns instance ID
- Typecheck passes

**Status:** false

### US-002: Display QR Code
**Priority:** 1
**Maven Steps:** [1, 7]
**MCP Tools:** ["chrome-devtools"]

As a project owner, I want to scan a QR code so that I can connect my WhatsApp number.

**Acceptance Criteria:**
- Dashboard calls GET /instance/connect/qr/{instanceName}
- Returns base64 PNG
- Display: `<img src="data:image/png;base64,{base64}">`
- Auto-refresh every 3 seconds until connected
- Typecheck passes

**Status:** false

### US-003: Monitor Connection Status
**Priority:** 1
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a project owner, I want to see connection status so that I know when WhatsApp is ready.

**Acceptance Criteria:**
- Poll GET /instance/status/{instanceName}
- Display: state (open/close), phone number, battery
- Update instance record in database
- Status changes trigger Realtime update
- Typecheck passes

**Status:** false

### US-004: Send WhatsApp Message
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** []

As an application, I want to send WhatsApp messages so that I can notify users.

**Acceptance Criteria:**
- API endpoint: POST /api/whatsapp/send
- Body: {instance_name, number, text, media_url?}
- Validates instance belongs to project
- Calls Evolution API: POST /message/sendText/{instanceName}
- Stores message in database
- Typecheck passes

**Status:** false

### US-005: Receive WhatsApp Messages
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["chrome-devtools"]

As an application, I want to receive incoming WhatsApp messages so that I can process user replies.

**Acceptance Criteria:**
- Evolution API sends webhook to /api/webhooks/whatsapp
- Verify signature: x-hub-signature-256
- Insert message to whatsapp_messages table
- Realtime broadcast to subscribed clients
- Typecheck passes

**Status:** false

### US-006: List Messages
**Priority:** 2
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a developer, I want to view message history so that I can debug conversations.

**Acceptance Criteria:**
- API endpoint: GET /api/whatsapp/messages?instance_id={id}
- Pagination support
- Filter by direction (inbound/outbound)
- Filter by date range
- Typecheck passes

**Status:** false

### US-007: WhatsApp MCP Server
**Priority:** 2
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a Claude Desktop user, I want to interact with WhatsApp via MCP so that I can send messages from AI.

**Acceptance Criteria:**
- stdio-based MCP server: mcp/whatsapp-mcp.ts
- Actions: create-instance, send-message, get-status, get-messages
- Handshake: {"type": "handshake", "version": "1.0"}
- Reads EVOLUTION_API_URL and EVOLUTION_API_KEY from env
- Typecheck passes

**Status:** false

### US-008: Instance Health Check
**Priority:** 2
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a system administrator, I want to monitor instance health so that I can detect disconnections.

**Acceptance Criteria:**
- Cron job checks status every 5 minutes
- Updates last_activity_at timestamp
- Alerts if no activity for 10 minutes
- Auto-reconnect option
- Typecheck passes

**Status:** false

### US-009: Send Media Messages
**Priority:** 3
**Maven Steps:** [1, 7, 10]
**MCP Tools:** []

As an application, I want to send images/documents so that I can share rich content.

**Acceptance Criteria:**
- API supports media_url parameter
- Uploads to Cloudinary first
- Sends Evolution API media message
- Stores message with media_url
- Typecheck passes

**Status:** false

### US-010: Webhook Signature Verification
**Priority:** 1
**Maven Steps:** [1, 10]
**MCP Tools:** []

As a security measure, I want to verify webhook signatures so that only Evolution API can send messages.

**Acceptance Criteria:**
- Compare x-hub-signature-256 header
- Compute HMAC SHA256 with WEBHOOK_SECRET
- Reject invalid signatures with 401
- Log verification failures
- Typecheck passes

**Status:** false
