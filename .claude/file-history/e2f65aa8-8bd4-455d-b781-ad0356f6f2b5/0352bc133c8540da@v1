---
project: API Keys and Authentication
branch: flow/api-keys-auth
availableMCPs:
  - supabase
  - chrome-devtools
  - web-search-prime
---

# API Keys and Authentication

## Overview
Implement secure API key management for project access. Role-based permissions, rate limiting, and key rotation. Integration with Supabase Auth for dashboard users.

## Technical Approach
- API keys stored as SHA256 hashes
- Key prefix for identification
- Scopes: read, write, admin
- Supabase Auth for dashboard
- JWT signing for project-scoped access

## User Stories

### US-001: Generate API Key
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["supabase"]

As a project owner, I want to generate API keys so that my applications can authenticate.

**Acceptance Criteria:**
- Key format: nm_{32-char-base64}
- Hash stored: SHA256(key)
- Prefix stored: first 8 chars
- Full key shown only once on creation
- Typecheck passes

**Status:** false

### US-002: Validate API Key
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["supabase"]

As the API middleware, I want to validate incoming keys so that unauthorized requests are rejected.

**Acceptance Criteria:**
- Middleware extracts Bearer token
- Hashes token and compares to database
- Checks key is_active
- Checks expiration
- Returns 401 if invalid
- Typecheck passes

**Status:** false

### US-003: List API Keys
**Priority:** 2
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a project owner, I want to see all API keys so that I can manage access.

**Acceptance Criteria:**
- Shows name, prefix, scopes, last_used
- Does NOT show full keys
- Shows active/inactive status
- Revoke action available
- Typecheck passes

**Status:** false

### US-004: Revoke API Key
**Priority:** 2
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["supabase"]

As a project owner, I want to revoke keys so that I can disable compromised access.

**Acceptance Criteria:**
- Sets is_active = false
- Cannot be undone
- Revoked keys immediately invalid
- Audit log entry created
- Typecheck passes

**Status:** false

### US-005: Key Scopes
**Priority:** 2
**Maven Steps:** [1, 7, 10]
**MCP Tools:** []

As a project owner, I want to limit key scopes so that keys have minimal permissions.

**Acceptance Criteria:**
- Scopes: read, write, admin
- Keys checked against scope
- Admin required for key management
- Write required for mutations
- Typecheck passes

**Status:** false

### US-006: Key Expiration
**Priority:** 2
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a project owner, I want to set expiration so that keys automatically expire.

**Acceptance Criteria:**
- expires_at timestamp
- Expired keys rejected
- Optional (null = no expiration)
- Dashboard shows expiration
- Typecheck passes

**Status:** false

### US-007: Rate Limiting by Key
**Priority:** 2
**Maven Steps:** [1, 7, 10]
**MCP Tools:** []

As the platform, I want to rate limit by key so that one application cannot abuse resources.

**Acceptance Criteria:**
- Per-key rate limits
- Redis-based counter
- Configurable: requests per minute
- Returns 429 when exceeded
- Retry-After header
- Typecheck passes

**Status:** false

### US-008: Supabase Auth Integration
**Priority:** 1
**Maven Steps:** [1, 7, 10]
**MCP Tools:** ["supabase"]

As a dashboard user, I want to log in with Supabase Auth so that I can access the UI.

**Acceptance Criteria:**
- Email/password login
- Session stored in cookie
- Protected routes check session
- Logout clears session
- Typecheck passes

**Status:** false

### US-009: Project JWT Signing
**Priority:** 3
**Maven Steps:** [1, 7]
**MCP Tools:** []

As the platform, I want to issue project-scoped JWTs so that external services can authenticate.

**Acceptance Criteria:**
- JWT contains project_id and scopes
- Signed with project JWT secret
- Verification endpoint
- Short expiration (1 hour)
- Typecheck passes

**Status:** false

### US-010: Audit Logging
**Priority:** 3
**Maven Steps:** [1, 7]
**MCP Tools:** []

As a security measure, I want to log key usage so that I can detect anomalies.

**Acceptance Criteria:**
- Log every API request
- Record: key_id, endpoint, ip, user_agent
- Store in audit_logs table
- Queryable by project owner
- Typecheck passes

**Status:** false
