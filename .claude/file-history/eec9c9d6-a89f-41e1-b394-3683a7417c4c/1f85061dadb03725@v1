// Organization Access Token Management for MCP
// Generates and validates JWT tokens for organization-level access

import { SignJWT, jwtVerify } from 'jose';

const JWT_SECRET = new TextEncoder().encode(
  process.env.MCP_JWT_SECRET || 'nextmavens-mcp-secret-key-change-in-production'
);

interface OrganizationTokenPayload {
  organization_id: string;
  user_id: string;
  role: string;
  iat: number;
  exp: number;
}

// Generate an access token for an organization
export async function generateOrganizationToken(
  organization_id: string,
  user_id: string,
  role: string = 'admin'
): Promise<string> {
  const now = Math.floor(Date.now() / 1000);
  const payload: OrganizationTokenPayload = {
    organization_id,
    user_id,
    role,
    iat: now,
    exp: now + 60 * 60 * 24 * 30, // 30 days
  };

  const token = await new SignJWT({ ...payload })
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt(payload.iat)
    .setExpirationTime(payload.exp)
    .sign(JWT_SECRET);

  return token;
}

// Verify an organization token
export async function verifyOrganizationToken(
  token: string
): Promise<OrganizationTokenPayload | null> {
  try {
    const { payload } = await jwtVerify(token, JWT_SECRET);
    return payload as unknown as OrganizationTokenPayload;
  } catch {
    return null;
  }
}

// Generate an MCP-specific token with scopes
export async function generateMcpToken(
  organization_id: string,
  user_id: string,
  scopes: string[] = ['read', 'write']
): Promise<{ token: string; scopes: string[] }> {
  const now = Math.floor(Date.now() / 1000);
  const payload = {
    organization_id,
    user_id,
    scopes,
    iat: now,
    exp: now + 60 * 60 * 24 * 365, // 1 year for MCP tokens
    type: 'mcp',
  };

  const token = await new SignJWT(payload)
    .setProtectedHeader({ alg: 'HS256' })
    .setIssuedAt(payload.iat)
    .setExpirationTime(payload.exp)
    .sign(JWT_SECRET);

  return { token, scopes };
}

// Format token for display (show first 8 and last 4 chars)
export function formatTokenForDisplay(token: string): string {
  if (token.length <= 16) return token;
  return `${token.substring(0, 8)}...${token.substring(token.length - 4)}`;
}

// Validate MCP scopes
export function validateMcpScope(requiredScope: string, userScopes: string[]): boolean {
  const scopeHierarchy: Record<string, number> = {
    admin: 3,
    write: 2,
    read: 1,
  };

  const userLevel = userScopes.reduce((max, scope) => {
    return Math.max(max, scopeHierarchy[scope] || 0);
  }, 0);

  const requiredLevel = scopeHierarchy[requiredScope] || 0;

  return userLevel >= requiredLevel;
}
