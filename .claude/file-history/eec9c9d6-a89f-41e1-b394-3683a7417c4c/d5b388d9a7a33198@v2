'use client';

import { useEffect, useState } from 'react';
import { useAuth } from '@/lib/store';
import { api } from '@/lib/api';
import type { Organization, Project } from '@/lib/api';
import { ToastContainer } from '@/components/toast-notifications';

interface VPSStats {
  disk: { used: string; total: string; percent: number };
  cpu: { usage: number };
  ram: { used: string; total: string; percent: number };
  network: { in: string; out: string };
}

interface DashboardStats {
  organizations: number;
  whatsappInstances: number;
  websites: number;
  projects: number;
}

export default function DashboardPage() {
  const { user, loading: authLoading } = useAuth();
  const [organizations, setOrganizations] = useState<Organization[]>([]);
  const [projects, setProjects] = useState<Project[]>([]);
  const [dataLoading, setDataLoading] = useState(false);
  const [vpsStats, setVpsStats] = useState<VPSStats>({
    disk: { used: '--', total: '--', percent: 0 },
    cpu: { usage: 0 },
    ram: { used: '--', total: '--', percent: 0 },
    network: { in: '--', out: '--' },
  });

  useEffect(() => {
    if (user) {
      fetchDashboardData();
      fetchVPSStats();
    }
  }, [user]);

  const fetchDashboardData = async () => {
    setDataLoading(true);
    try {
      const [orgsResponse, projectsResponse] = await Promise.all([
        api.getOrganizations(),
        api.getProjects(),
      ]);
      setOrganizations(orgsResponse.items);
      setProjects(projectsResponse.items);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setDataLoading(false);
    }
  };

  const fetchVPSStats = async () => {
    try {
      const response = await fetch('/api/vps/stats');
      if (response.ok) {
        const stats = await response.json();
        setVpsStats(stats);
      }
    } catch (error) {
      console.error('Failed to fetch VPS stats:', error);
    }
  };

  const stats: DashboardStats = {
    organizations: organizations.length,
    whatsappInstances: 0, // Will be calculated when WhatsApp API is ready
    websites: projects.filter(p => p.status === 'active').length,
    projects: projects.length,
  };

  if (authLoading) {
    return (
      <div className="page-loading">
        <div className="spinner"></div>
        <span className="sr-only">Loading...</span>
      </div>
    );
  }

  return (
    <div className="dashboard-page">
      {/* Header */}
      <div className="page-header">
        <div>
          <h1 className="page-title">Dashboard</h1>
          <p className="page-subtitle">
            Welcome to NEXT MAVENS VPS
          </p>
        </div>
        <div className="header-actions">
          <a href="/databases" className="btn btn-primary">
            <span className="mono">[+]</span>
            <span>New Project</span>
          </a>
        </div>
      </div>

      {/* Stats Grid */}
      <div className="stats-grid">
        <StatCard
          title="Organizations"
          value={stats.organizations}
          icon="[O]"
          href="/databases"
        />
        <StatCard
          title="Projects"
          value={stats.projects}
          icon="[P]"
          href="/databases"
        />
        <StatCard
          title="Websites"
          value={stats.websites}
          icon="[W]"
          href="/deploy"
        />
        <StatCard
          title="WhatsApp"
          value={stats.whatsappInstances}
          icon="[C]"
          href="/whatsapp"
        />
      </div>

      {/* VPS Stats Section */}
      <div className="vps-section">
        <h2 className="section-title">System Resources</h2>
        <div className="vps-stats-grid">
          <VPSStatCard
            title="Disk"
            used={vpsStats.disk.used}
            total={vpsStats.disk.total}
            percent={vpsStats.disk.percent}
            icon="[D]"
          />
          <VPSStatCard
            title="CPU"
            used={`${vpsStats.cpu.usage}%`}
            total="100%"
            percent={vpsStats.cpu.usage}
            icon="[C]"
          />
          <VPSStatCard
            title="RAM"
            used={vpsStats.ram.used}
            total={vpsStats.ram.total}
            percent={vpsStats.ram.percent}
            icon="[R]"
          />
          <NetworkCard
            incoming={vpsStats.network.in}
            outgoing={vpsStats.network.out}
          />
        </div>
      </div>

      {/* Quick Actions */}
      <div className="quick-actions">
        <h2 className="section-title">Quick Actions</h2>
        <div className="actions-grid">
          <QuickActionCard
            title="New Organization"
            description="Create a new organization"
            icon="[O]"
            href="/databases"
          />
          <QuickActionCard
            title="New WhatsApp"
            description="Connect WhatsApp number"
            icon="[C]"
            href="/whatsapp"
          />
          <QuickActionCard
            title="Deploy Site"
            description="Deploy from GitHub"
            icon="[P]"
            href="/deploy"
          />
          <QuickActionCard
            title="Backup"
            description="Manage backups"
            icon="[B]"
            href="/backup"
          />
        </div>
      </div>

      {/* Recent Projects */}
      {projects.length > 0 && (
        <div className="recent-projects">
          <h2 className="section-title">Recent Projects</h2>
          <div className="projects-list">
            {projects.slice(0, 5).map((project) => (
              <ProjectCard key={project.id} project={project} organizations={organizations} />
            ))}
          </div>
        </div>
      )}

      <ToastContainer />
    </div>
  );
}

function StatCard({ title, value, icon, href }: {
  title: string;
  value: number;
  icon: string;
  href: string;
}) {
  return (
    <a href={href} className="stat-card">
      <div className="stat-header">
        <span className="stat-icon mono">{icon}</span>
        <span className="stat-title">{title}</span>
      </div>
      <div className="stat-value mono">{value}</div>
    </a>
  );
}

function VPSStatCard({ title, used, total, percent, icon }: {
  title: string;
  used: string;
  total: string;
  percent: number;
  icon: string;
}) {
  return (
    <div className="vps-card">
      <div className="vps-card-header">
        <span className="vps-icon mono">{icon}</span>
        <span className="vps-title">{title}</span>
      </div>
      <div className="vps-values">
        <span className="vps-used mono">{used}</span>
        <span className="text-muted">/</span>
        <span className="vps-total mono">{total}</span>
      </div>
      <div className="vps-progress">
        <div
          className="vps-progress-bar"
          style={{ width: `${Math.min(percent, 100)}%` }}
        />
      </div>
      <div className="vps-percent mono text-muted">{percent}%</div>
    </div>
  );
}

function NetworkCard({ incoming, outgoing }: {
  incoming: string;
  outgoing: string;
}) {
  return (
    <div className="vps-card network-card">
      <div className="vps-card-header">
        <span className="vps-icon mono">[N]</span>
        <span className="vps-title">Network</span>
      </div>
      <div className="network-values">
        <div className="network-item">
          <span className="network-label text-muted">IN</span>
          <span className="network-value mono">{incoming}</span>
        </div>
        <div className="network-item">
          <span className="network-label text-muted">OUT</span>
          <span className="network-value mono">{outgoing}</span>
        </div>
      </div>
    </div>
  );
}

function QuickActionCard({ title, description, icon, href }: {
  title: string;
  description: string;
  icon: string;
  href: string;
}) {
  return (
    <a href={href} className="action-card">
      <span className="action-icon mono">{icon}</span>
      <div className="action-content">
        <div className="action-title">{title}</div>
        <div className="action-description text-muted">{description}</div>
      </div>
    </a>
  );
}

function ProjectCard({ project, organizations }: { project: Project; organizations: Organization[] }) {
  const org = organizations?.find(o => o.id === project.organization_id);
  return (
    <div className="project-card">
      <div className="project-header">
        <span className="project-name mono">{project.slug}</span>
        <ProjectStatus status={project.status} />
      </div>
      <div className="project-org text-muted">{org?.name || 'Unknown'}</div>
    </div>
  );
}

function ProjectStatus({ status }: { status: string }) {
  const statusConfig: Record<string, { label: string; className: string }> = {
    active: { label: 'ACTIVE', className: 'badge-success' },
    provisioning: { label: 'PROVISIONING', className: 'badge-warning' },
    suspended: { label: 'SUSPENDED', className: 'badge-error' },
    archived: { label: 'ARCHIVED', className: 'badge-primary' },
  };

  const config = statusConfig[status] || { label: status.toUpperCase(), className: 'badge-primary' };

  return (
    <span className={`badge ${config.className} mono`}>
      {config.label}
    </span>
  );
}
