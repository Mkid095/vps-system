-- NextMavens Platform - Master Database Schema
-- This schema manages organizations, projects, and their database credentials
-- Run this on the master database to initialize the platform

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- Custom types
CREATE TYPE organization_role AS ENUM ('owner', 'admin', 'member', 'viewer');
CREATE TYPE project_status AS ENUM ('provisioning', 'active', 'suspended', 'archived');
CREATE TYPE whatsapp_instance_status AS ENUM ('pending', 'connecting', 'connected', 'disconnected', 'error');

-- ====================================================================
-- Organizations
-- ====================================================================
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    slug TEXT NOT NULL UNIQUE,
    logo_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_organizations_slug ON organizations(slug);

-- ====================================================================
-- Organization Members
-- ====================================================================
CREATE TABLE organization_members (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    user_id TEXT NOT NULL, -- Supabase Auth user ID
    role organization_role NOT NULL DEFAULT 'member',
    invited_by UUID,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(organization_id, user_id)
);

CREATE INDEX idx_org_members_org_id ON organization_members(organization_id);
CREATE INDEX idx_org_members_user_id ON organization_members(user_id);

-- ====================================================================
-- Projects
-- ====================================================================
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    slug TEXT NOT NULL,
    description TEXT,
    status project_status NOT NULL DEFAULT 'provisioning',
    db_name TEXT UNIQUE, -- Database name in PostgreSQL
    db_user TEXT, -- Database role name
    anon_key TEXT UNIQUE,
    service_role_key TEXT UNIQUE,
    jwt_secret TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT projects_org_slug_unique UNIQUE (organization_id, slug)
);

CREATE INDEX idx_projects_org_id ON projects(organization_id);
CREATE INDEX idx_projects_slug ON projects(slug);
CREATE INDEX idx_projects_status ON projects(status);

-- ====================================================================
-- Project Databases (Credentials Storage)
-- ====================================================================
CREATE TABLE project_databases (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    db_name TEXT NOT NULL UNIQUE,
    db_user TEXT NOT NULL,
    db_password TEXT NOT NULL, -- Encrypted
    db_host TEXT NOT NULL DEFAULT 'db',
    db_port INTEGER NOT NULL DEFAULT 5432,
    connection_pool TEXT DEFAULT 'supavisor',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_project_dbs_project_id ON project_databases(project_id);
CREATE INDEX idx_project_dbs_db_name ON project_databases(db_name);

-- ====================================================================
-- Project Settings
-- ====================================================================
CREATE TABLE project_settings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    key TEXT NOT NULL,
    value JSONB NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(project_id, key)
);

CREATE INDEX idx_project_settings_project_id ON project_settings(project_id);

-- ====================================================================
-- WhatsApp Instances
-- ====================================================================
CREATE TABLE whatsapp_instances (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    instance_name TEXT NOT NULL UNIQUE,
    instance_id TEXT, -- Evolution API instance ID
    status whatsapp_instance_status NOT NULL DEFAULT 'pending',
    phone_number TEXT,
    qr_code_base64 TEXT,
    webhook_url TEXT,
    webhook_secret TEXT,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    connected_at TIMESTAMPTZ,
    last_activity_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(project_id, instance_name)
);

CREATE INDEX idx_whatsapp_instances_project_id ON whatsapp_instances(project_id);
CREATE INDEX idx_whatsapp_instances_status ON whatsapp_instances(status);
CREATE INDEX idx_whatsapp_instances_instance_name ON whatsapp_instances(instance_name);

-- ====================================================================
-- WhatsApp Messages
-- ====================================================================
CREATE TABLE whatsapp_messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    instance_id UUID NOT NULL REFERENCES whatsapp_instances(id) ON DELETE CASCADE,
    message_id TEXT NOT NULL,
    from_number TEXT NOT NULL,
    to_number TEXT NOT NULL,
    message_type TEXT NOT NULL, -- text, image, audio, video, document
    content TEXT,
    media_url TEXT,
    direction TEXT NOT NULL, -- inbound, outbound
    status TEXT DEFAULT 'sent',
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(instance_id, message_id)
);

CREATE INDEX idx_whatsapp_messages_instance_id ON whatsapp_messages(instance_id);
CREATE INDEX idx_whatsapp_messages_from_number ON whatsapp_messages(from_number);
CREATE INDEX idx_whatsapp_messages_created_at ON whatsapp_messages(created_at DESC);

-- ====================================================================
-- API Keys
-- ====================================================================
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    key_hash TEXT NOT NULL, -- SHA256 hash of the key
    key_prefix TEXT NOT NULL, -- First 8 characters for identification
    scopes TEXT[] NOT NULL DEFAULT ARRAY['read', 'write'],
    is_active BOOLEAN NOT NULL DEFAULT true,
    last_used_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    created_by TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_api_keys_project_id ON api_keys(project_id);
CREATE INDEX idx_api_keys_key_hash ON api_keys(key_hash);
CREATE INDEX idx_api_keys_active ON api_keys(is_active) WHERE is_active = true;

-- ====================================================================
-- Audit Logs
-- ====================================================================
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    api_key_id UUID REFERENCES api_keys(id) ON DELETE SET NULL,
    user_id TEXT,
    action TEXT NOT NULL,
    resource_type TEXT NOT NULL,
    resource_id TEXT,
    endpoint TEXT,
    method TEXT,
    status_code INTEGER,
    metadata JSONB DEFAULT '{}',
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_project_id ON audit_logs(project_id);
CREATE INDEX idx_audit_logs_api_key_id ON audit_logs(api_key_id);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);

-- ====================================================================
-- Storage Monitoring
-- ====================================================================
CREATE TABLE storage_metrics (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    metric_type TEXT NOT NULL, -- disk_usage, docker_usage, etc.
    value NUMERIC NOT NULL,
    unit TEXT NOT NULL, -- GB, MB, percentage
    threshold_alerted NUMERIC[] DEFAULT ARRAY[80, 90, 95],
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_storage_metrics_type ON storage_metrics(metric_type);
CREATE INDEX idx_storage_metrics_created_at ON storage_metrics(created_at DESC);

-- ====================================================================
-- Functions
-- ====================================================================

-- Function to generate a safe database name from project ID
CREATE OR REPLACE FUNCTION generate_db_name(project_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN 'project_' || REPLACE(project_id::TEXT, '-', '_');
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Function to generate a safe database role name
CREATE OR REPLACE FUNCTION generate_db_role(project_id UUID)
RETURNS TEXT AS $$
BEGIN
    RETURN 'app_' || REPLACE(project_id::TEXT, '-', '_');
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Function to generate API key
CREATE OR REPLACE FUNCTION generate_api_key()
RETURNS TEXT AS $$
    SELECT encode(gen_random_bytes(32), 'base64');
$$ LANGUAGE sql SECURITY DEFINER;

-- Function to hash API key
CREATE OR REPLACE FUNCTION hash_api_key(key TEXT)
RETURNS TEXT AS $$
    SELECT encode(digest(key, 'sha256'), 'hex');
$$ LANGUAGE sql IMMUTABLE;

-- Function to create project database (admin only)
CREATE OR REPLACE FUNCTION create_project_database(project_id UUID)
RETURNS JSONB AS $$
DECLARE
    v_db_name TEXT;
    v_role_name TEXT;
    v_password TEXT;
    v_project projects;
BEGIN
    -- Get project details
    SELECT * INTO v_project FROM projects WHERE id = project_id;
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Project not found';
    END IF;

    -- Generate database name and role
    v_db_name := generate_db_name(project_id);
    v_role_name := generate_db_role(project_id);
    v_password := encode(gen_random_bytes(24), 'base64');

    -- Create database
    EXECUTE format('CREATE DATABASE %I', v_db_name);

    -- Connect to new database and create role
    EXECUTE format('CREATE ROLE %I WITH LOGIN PASSWORD %L', v_role_name, v_password);

    -- Grant privileges
    EXECUTE format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', v_db_name, v_role_name);

    -- Store credentials
    INSERT INTO project_databases (project_id, db_name, db_user, db_password)
    VALUES (project_id, v_db_name, v_role_name, v_password);

    -- Update project
    UPDATE projects
    SET db_name = v_db_name,
        db_user = v_role_name,
        status = 'active'
    WHERE id = project_id;

    RETURN jsonb_build_object(
        'db_name', v_db_name,
        'db_user', v_role_name,
        'connection_string', format('postgres://%I:%s@db:5432/%I', v_role_name, v_password, v_db_name)
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to update updated_at
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function to execute safe SQL queries for MCP server
-- Only allows SELECT, INSERT, UPDATE operations with safety limits
CREATE OR REPLACE FUNCTION execute_sql(sql_query TEXT)
RETURNS TABLE(
    rows JSONB,
    columns TEXT[],
    affected_rows BIGINT
) AS $$
DECLARE
    normalized_sql TEXT;
    v_rows JSONB := '[]'::jsonb;
    v_columns TEXT[] := ARRAY[]::TEXT[];
    v_affected BIGINT := 0;
    v_result RECORD;
    v_col_name TEXT;
    v_row_data JSONB;
    v_row_json JSONB;
BEGIN
    -- Normalize SQL for validation
    normalized_sql := UPPER(TRIM(sql_query));

    -- Validate SQL type - only allow SELECT, INSERT, UPDATE
    IF normalized_sql NOT LIKE 'SELECT %' AND
       normalized_sql NOT LIKE 'INSERT INTO %' AND
       normalized_sql NOT LIKE 'UPDATE %' THEN
        RAISE EXCEPTION 'Only SELECT, INSERT INTO, and UPDATE queries are allowed';
    END IF;

    -- Block dangerous operations
    IF sql_query ~* '(DROP\s+TABLE|DROP\s+DATABASE|DELETE\s+FROM|TRUNCATE|ALTER\s+TABLE|CREATE\s+TABLE|CREATE\s+DATABASE|GRANT\s+|REVOKE\s+|EXEC\s+|EXECUTE\s+)' THEN
        RAISE EXCEPTION 'Dangerous SQL operation detected';
    END IF;

    -- Additional safety for UPDATE: require WHERE clause
    IF normalized_sql LIKE 'UPDATE %' AND sql_query !~* '\bWHERE\b' THEN
        RAISE EXCEPTION 'UPDATE queries must include a WHERE clause';
    END IF;

    -- Execute based on query type
    IF normalized_sql LIKE 'SELECT %' THEN
        -- Execute SELECT and return results
        -- Use dynamic SQL with FOR loop
        FOR v_result IN EXECUTE sql_query LOOP
            -- Build row JSON
            v_row_json := '{}'::jsonb;

            -- Get column names from the result
            -- This is a simplified approach - for production, use pg_attribute
            SELECT array_agg(a.attname)
            INTO v_columns
            FROM pg_attribute a
            JOIN pg_class c ON c.oid = a.attrelid
            JOIN pg_namespace n ON n.oid = c.relnamespace
            WHERE c.relkind = 'r'
            AND n.nspname = current_schema()
            AND a.attnum > 0
            AND NOT a.attisdropped
            LIMIT 1;

            -- Convert row to JSON
            v_row_json := row_to_json(v_result)::jsonb;
            v_rows := v_rows || v_row_json;
        END LOOP;

        v_affected := jsonb_array_length(v_rows);

    ELSIF normalized_sql LIKE 'INSERT INTO %' OR normalized_sql LIKE 'UPDATE %' THEN
        -- Execute INSERT/UPDATE
        EXECUTE sql_query;
        GET DIAGNOSTICS v_affected = ROW_COUNT;

        -- Return empty result for mutations
        v_rows := '[]'::jsonb;
        v_columns := ARRAY[]::TEXT[];
    END IF;

    RETURN QUERY SELECT v_rows, v_columns, v_affected;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Apply updated_at trigger
CREATE TRIGGER organizations_updated_at BEFORE UPDATE ON organizations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER organization_members_updated_at BEFORE UPDATE ON organization_members
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER projects_updated_at BEFORE UPDATE ON projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER project_databases_updated_at BEFORE UPDATE ON project_databases
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER project_settings_updated_at BEFORE UPDATE ON project_settings
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER whatsapp_instances_updated_at BEFORE UPDATE ON whatsapp_instances
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER api_keys_updated_at BEFORE UPDATE ON api_keys
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- ====================================================================
-- Row Level Security (RLS)
-- ====================================================================

-- Enable RLS on sensitive tables
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_databases ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_instances ENABLE ROW LEVEL SECURITY;
ALTER TABLE whatsapp_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE api_keys ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Organizations: accessible to members
CREATE POLICY "Users can view organizations they are members of"
    ON organizations FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM organization_members
            WHERE organization_members.organization_id = organizations.id
            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
        )
    );

CREATE POLICY "Users can create organizations"
    ON organizations FOR INSERT
    TO authenticated
    WITH CHECK (true);

CREATE POLICY "Organization owners can update"
    ON organizations FOR UPDATE
    TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM organization_members
            WHERE organization_members.organization_id = organizations.id
            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
            AND organization_members.role = 'owner'
        )
    );

CREATE POLICY "Organization owners can delete"
    ON organizations FOR DELETE
    TO authenticated
    USING (
        EXISTS (
            SELECT 1 FROM organization_members
            WHERE organization_members.organization_id = organizations.id
            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
            AND organization_members.role = 'owner'
        )
    );

-- Projects: accessible to org members
CREATE POLICY "Users can view projects in their organizations"
    ON projects FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM organization_members
            WHERE organization_members.organization_id = projects.organization_id
            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
        )
    );

-- WhatsApp instances: accessible to project members
CREATE POLICY "Users can view WhatsApp instances in their projects"
    ON whatsapp_instances FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM projects p
            JOIN organization_members om ON om.organization_id = p.organization_id
            WHERE p.id = whatsapp_instances.project_id
            AND om.user_id = (current_setting('request.jwt.claim.user_id', true))
        )
    );

-- Messages: accessible to project members
CREATE POLICY "Users can view messages in their projects"
    ON whatsapp_messages FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM whatsapp_instances wi
            JOIN projects p ON p.id = wi.project_id
            JOIN organization_members om ON om.organization_id = p.organization_id
            WHERE wi.id = whatsapp_messages.instance_id
            AND om.user_id = (current_setting('request.jwt.claim.user_id', true))
        )
    );

-- ====================================================================
-- Initial Data
-- ====================================================================

-- Insert default project settings
INSERT INTO project_settings (project_id, key, value, description) VALUES
    (uuid_generate_v4(), 'storage.quota_gb', '10'::jsonb, 'Storage quota in GB'),
    (uuid_generate_v4(), 'rate.limit_rpm', '60'::jsonb, 'Rate limit: requests per minute'),
    (uuid_generate_v4(), 'whatsapp.auto_reconnect', 'true'::jsonb, 'Auto-reconnect WhatsApp on disconnect');

-- Grant necessary permissions
GRANT USAGE ON SCHEMA public TO postgres;
GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO postgres;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO postgres;
