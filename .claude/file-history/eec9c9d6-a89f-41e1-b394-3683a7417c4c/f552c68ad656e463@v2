'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useEffect, useState } from 'react';

interface NavItem {
  href: string;
  label: string;
  icon: string;
}

const navItems: NavItem[] = [
  { href: '/', label: 'Home', icon: '[H]' },
  { href: '/databases', label: 'Databases', icon: '[D]' },
  { href: '/whatsapp', label: 'WhatsApp', icon: '[W]' },
  { href: '/deploy', label: 'Deploy', icon: '[P]' },
  { href: '/backup', label: 'Backup', icon: '[B]' },
  { href: '/emails', label: 'Emails', icon: '[E]' },
];

export function Sidebar() {
  const pathname = usePathname();
  const [user, setUser] = useState<{ email: string } | null>(null);

  useEffect(() => {
    // Get user from localStorage
    const token = localStorage.getItem('supabase_access_token');
    if (token) {
      // Decode JWT to get user email (simple parsing)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        setUser({ email: payload.email || '' });
      } catch (error) {
        console.error('Failed to decode token:', error);
      }
    }
  }, []);

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/signout', { method: 'POST' });
      localStorage.removeItem('supabase_access_token');
      window.location.href = '/auth/signin';
    } catch (error) {
      console.error('Logout failed:', error);
      window.location.href = '/auth/signin';
    }
  };

  return (
    <aside className="sidebar">
      {/* Logo */}
      <div className="sidebar-header">
        <Link href="/" className="logo-link">
          <img
            src="https://www.nextmavens.com/logo-colored.png"
            alt="NextMavens"
            className="logo-image"
          />
        </Link>
      </div>

      {/* VPS Stats */}
      <div className="vps-stats">
        <VPSStat label="DISK" value="--" />
        <VPSStat label="CPU" value="--" />
        <VPSStat label="RAM" value="--" />
        <VPSStat label="NET" value="--" />
      </div>

      {/* Navigation */}
      <nav className="sidebar-nav">
        <ul className="nav-list">
          {navItems.map((item) => {
            const isActive = pathname === item.href;
            return (
              <li key={item.href}>
                <Link
                  href={item.href}
                  className={`nav-item ${isActive ? 'active' : ''}`}
                >
                  <span className="nav-icon mono">{item.icon}</span>
                  <span className="nav-label">{item.label}</span>
                </Link>
              </li>
            );
          })}
        </ul>
      </nav>

      {/* User section */}
      {user && (
        <div className="sidebar-footer">
          <div className="user-info">
            <span className="user-email mono">{user.email}</span>
          </div>
          <button
            onClick={handleLogout}
            className="logout-btn btn-ghost"
          >
            <span className="mono">[X]</span>
            <span>Logout</span>
          </button>
        </div>
      )}
    </aside>
  );
}

function VPSStat({ label, value }: { label: string; value: string }) {
  return (
    <div className="vps-stat">
      <span className="vps-stat-label mono text-muted">{label}</span>
      <span className="vps-stat-value mono">{value}</span>
    </div>
  );
}
