'use client';

import { useEffect, useState } from 'react';
import { useAuth } from '@/lib/store';
import { api } from '@/lib/api';
import type { Organization, Project } from '@/lib/api';
import { useVpsStats } from '@/lib/hooks/useVpsStats';
import { StatsCard } from '@/components/dashboard/home/StatsCard';
import { VPSResourceCard, NetworkCard } from '@/components/dashboard/home/VPSResourceCard';
import { QuickActionCard } from '@/components/dashboard/home/QuickActionCard';
import { RecentProjects } from '@/components/dashboard/home/RecentProjects';
import { ToastContainer } from '@/components/toast-notifications';

export default function DashboardPage() {
  const { user, loading: authLoading, initialize } = useAuth();
  const [organizations, setOrganizations] = useState<Organization[]>([]);
  const [projects, setProjects] = useState<Project[]>([]);
  const [dataLoading, setDataLoading] = useState(false);

  // Real-time VPS stats hook
  const { stats: vpsStats, loading: vpsLoading } = useVpsStats(5000);

  useEffect(() => {
    initialize();
  }, [initialize]);

  useEffect(() => {
    if (user) {
      fetchDashboardData();
    }
  }, [user]);

  const fetchDashboardData = async () => {
    setDataLoading(true);
    try {
      const [orgsResponse, projectsResponse] = await Promise.all([
        api.getOrganizations(),
        api.getProjects(),
      ]);
      setOrganizations(orgsResponse.items);
      setProjects(projectsResponse.items);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setDataLoading(false);
    }
  };

  const stats = {
    organizations: organizations.length,
    projects: projects.length,
    websites: projects.filter(p => p.status === 'active').length,
    whatsapp: 0 // Will be updated when WhatsApp API is connected
  };

  if (authLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen">
        <p className="text-lg text-gray-600 mb-4">Please sign in to access the dashboard</p>
        <a href="/auth/signin" className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 no-underline">
          Sign In
        </a>
      </div>
    );
  }

  return (
    <div>
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Dashboard</h1>
        <p className="text-gray-600">Welcome to NextMavens VPS Management Console</p>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <StatsCard
          title="Organizations"
          value={stats.organizations}
          icon="â—‰"
          href="/databases"
          color="blue"
          subtitle="Manage your data"
        />
        <StatsCard
          title="Projects"
          value={stats.projects}
          icon="â—‡"
          href="/databases"
          color="green"
          subtitle="Active databases"
        />
        <StatsCard
          title="Websites"
          value={stats.websites}
          icon="âŒ‚"
          href="/deploy"
          color="purple"
          subtitle="Deployed sites"
        />
        <StatsCard
          title="WhatsApp"
          value={stats.whatsapp}
          icon="âœ†"
          href="/whatsapp"
          color="orange"
          subtitle="Connected numbers"
        />
      </div>

      {/* VPS Resources - Real-time */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-semibold text-gray-900">System Resources</h2>
          <div className="flex items-center gap-2 text-sm text-gray-500">
            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            <span>Live</span>
          </div>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <VPSResourceCard
            title="Disk"
            used={vpsStats.disk.used}
            total={vpsStats.disk.total}
            percent={vpsStats.disk.percent}
            icon="ðŸ’¾"
            color="indigo"
          />
          <VPSResourceCard
            title="CPU"
            used={`${vpsStats.cpu.usage}%`}
            total="100%"
            percent={vpsStats.cpu.usage}
            icon="âš¡"
            color="blue"
          />
          <VPSResourceCard
            title="RAM"
            used={vpsStats.ram.used}
            total={vpsStats.ram.total}
            percent={vpsStats.ram.percent}
            icon="â–£"
            color="green"
          />
          <NetworkCard
            incoming={vpsStats.network.in}
            outgoing={vpsStats.network.out}
          />
        </div>
      </div>

      {/* Quick Actions */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <QuickActionCard
            title="New Project"
            description="Create a new Supabase project"
            icon="+"
            href="/databases"
            color="indigo"
          />
          <QuickActionCard
            title="Connect WhatsApp"
            description="Add a new WhatsApp instance"
            icon="âœ†"
            href="/whatsapp"
            color="green"
          />
          <QuickActionCard
            title="Deploy Website"
            description="Deploy from GitHub"
            icon="â¬†"
            href="/deploy"
            color="blue"
          />
          <QuickActionCard
            title="Run Backup"
            description="Backup your data now"
            icon="âŽ™"
            href="/backup"
            color="orange"
          />
        </div>
      </div>

      {/* Recent Projects */}
      <div>
        <h2 className="text-xl font-semibold text-gray-900 mb-4">Recent Projects</h2>
        <RecentProjects projects={projects} organizations={organizations} />
      </div>

      <ToastContainer />
    </div>
  );
}
