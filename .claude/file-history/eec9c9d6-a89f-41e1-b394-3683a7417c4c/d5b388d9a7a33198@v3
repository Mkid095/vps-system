'use client';

import { useEffect, useState, useRef } from 'react';
import { useAuth } from '@/lib/store';
import { api } from '@/lib/api';
import type { Organization, Project } from '@/lib/api';
import { ToastContainer } from '@/components/toast-notifications';

interface VPSStats {
  disk: { used: string; total: string; percent: number };
  cpu: { usage: number };
  ram: { used: string; total: string; percent: number };
  network: { in: string; out: string };
}

interface DashboardStats {
  organizations: number;
  whatsappInstances: number;
  websites: number;
  projects: number;
}

export default function DashboardPage() {
  const { user, loading: authLoading, initialize } = useAuth();
  const [organizations, setOrganizations] = useState<Organization[]>([]);
  const [projects, setProjects] = useState<Project[]>([]);
  const [dataLoading, setDataLoading] = useState(false);
  const [vpsStats, setVpsStats] = useState<VPSStats>({
    disk: { used: '--', total: '--', percent: 0 },
    cpu: { usage: 0 },
    ram: { used: '--', total: '--', percent: 0 },
    network: { in: '--', out: '--' },
  });
  const statsIntervalRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    // Initialize auth on mount
    initialize();
  }, [initialize]);

  useEffect(() => {
    if (user) {
      fetchDashboardData();
      fetchVPSStats();

      // Update VPS stats every 5 seconds
      statsIntervalRef.current = setInterval(() => {
        fetchVPSStats();
      }, 5000);

      return () => {
        if (statsIntervalRef.current) {
          clearInterval(statsIntervalRef.current);
        }
      };
    }
  }, [user]);

  const fetchDashboardData = async () => {
    setDataLoading(true);
    try {
      const [orgsResponse, projectsResponse] = await Promise.all([
        api.getOrganizations(),
        api.getProjects(),
      ]);
      setOrganizations(orgsResponse.items);
      setProjects(projectsResponse.items);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setDataLoading(false);
    }
  };

  const fetchVPSStats = async () => {
    try {
      const response = await fetch('/api/vps/stats');
      if (response.ok) {
        const stats = await response.json();
        setVpsStats(stats);
      }
    } catch (error) {
      console.error('Failed to fetch VPS stats:', error);
    }
  };

  const stats: DashboardStats = {
    organizations: organizations.length,
    whatsappInstances: 0, // Will be calculated when WhatsApp API is ready
    websites: projects.filter(p => p.status === 'active').length,
    projects: projects.length,
  };

  if (authLoading) {
    return (
      <div className="page-loading">
        <div className="spinner"></div>
        <span className="sr-only">Loading...</span>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="page-loading">
        <div className="text-center">
          <p className="text-lg mb-4">Please sign in to access the dashboard</p>
          <a href="/auth/signin" className="btn btn-primary">
            <span className="mono">[‚Üê]</span>
            <span>Sign In</span>
          </a>
        </div>
      </div>
    );
  }

  return (
    <div>
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-semibold mb-1">Dashboard</h1>
          <p className="text-muted-foreground text-base">
            Welcome to NEXT MAVENS VPS
          </p>
        </div>
        <div className="flex gap-3">
          <a href="/databases" className="btn btn-primary">
            <span className="mono text-xs">[+]</span>
            <span className="text-sm">New Project</span>
          </a>
        </div>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <StatCard
          title="Organizations"
          value={stats.organizations}
          icon="[O]"
          href="/databases"
          color="blue"
        />
        <StatCard
          title="Projects"
          value={stats.projects}
          icon="[P]"
          href="/databases"
          color="indigo"
        />
        <StatCard
          title="Websites"
          value={stats.websites}
          icon="[W]"
          href="/deploy"
          color="green"
        />
        <StatCard
          title="WhatsApp"
          value={stats.whatsappInstances}
          icon="[C]"
          href="/whatsapp"
          color="emerald"
        />
      </div>

      {/* VPS Stats Section */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold mb-4">System Resources</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <VPSStatCard
            title="Disk"
            used={vpsStats.disk.used}
            total={vpsStats.disk.total}
            percent={vpsStats.disk.percent}
            icon="[D]"
          />
          <VPSStatCard
            title="CPU"
            used={`${vpsStats.cpu.usage}%`}
            total="100%"
            percent={vpsStats.cpu.usage}
            icon="[C]"
          />
          <VPSStatCard
            title="RAM"
            used={vpsStats.ram.used}
            total={vpsStats.ram.total}
            percent={vpsStats.ram.percent}
            icon="[R]"
          />
          <NetworkCard
            incoming={vpsStats.network.in}
            outgoing={vpsStats.network.out}
          />
        </div>
      </div>

      {/* Quick Actions */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold mb-4">Quick Actions</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <QuickActionCard
            title="New Organization"
            description="Create a new organization"
            icon="[O]"
            href="/databases"
          />
          <QuickActionCard
            title="New WhatsApp"
            description="Connect WhatsApp number"
            icon="[C]"
            href="/whatsapp"
          />
          <QuickActionCard
            title="Deploy Site"
            description="Deploy from GitHub"
            icon="[P]"
            href="/deploy"
          />
          <QuickActionCard
            title="Backup"
            description="Manage backups"
            icon="[B]"
            href="/backup"
          />
        </div>
      </div>

      {/* Recent Projects */}
      {projects.length > 0 && (
        <div>
          <h2 className="text-xl font-semibold mb-4">Recent Projects</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {projects.slice(0, 6).map((project) => (
              <ProjectCard key={project.id} project={project} organizations={organizations} />
            ))}
          </div>
        </div>
      )}

      <ToastContainer />
    </div>
  );
}

function StatCard({ title, value, icon, href, color = 'indigo' }: {
  title: string;
  value: number;
  icon: string;
  href: string;
  color?: 'blue' | 'indigo' | 'green' | 'emerald' | 'orange' | 'purple';
}) {
  const colorClasses = {
    blue: 'bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-950/50',
    indigo: 'bg-indigo-50 dark:bg-indigo-950/30 border-indigo-200 dark:border-indigo-800 hover:bg-indigo-100 dark:hover:bg-indigo-950/50',
    green: 'bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800 hover:bg-green-100 dark:hover:bg-green-950/50',
    emerald: 'bg-emerald-50 dark:bg-emerald-950/30 border-emerald-200 dark:border-emerald-800 hover:bg-emerald-100 dark:hover:bg-emerald-950/50',
    orange: 'bg-orange-50 dark:bg-orange-950/30 border-orange-200 dark:border-orange-800 hover:bg-orange-100 dark:hover:bg-orange-950/50',
    purple: 'bg-purple-50 dark:bg-purple-950/30 border-purple-200 dark:border-purple-800 hover:bg-purple-100 dark:hover:bg-purple-950/50',
  };

  const iconColors = {
    blue: 'text-blue-600 dark:text-blue-400',
    indigo: 'text-indigo-600 dark:text-indigo-400',
    green: 'text-green-600 dark:text-green-400',
    emerald: 'text-emerald-600 dark:text-emerald-400',
    orange: 'text-orange-600 dark:text-orange-400',
    purple: 'text-purple-600 dark:text-purple-400',
  };

  return (
    <a href={href} className={`${colorClasses[color]} border rounded-xl p-5 transition-all hover:shadow-lg no-underline`}>
      <div className="flex items-center gap-2 mb-3">
        <span className={`mono text-sm ${iconColors[color]}`}>{icon}</span>
        <span className="text-xs font-medium uppercase tracking-wider text-muted-foreground">{title}</span>
      </div>
      <div className="mono text-4xl font-semibold">{value}</div>
    </a>
  );
}

function VPSStatCard({ title, used, total, percent, icon }: {
  title: string;
  used: string;
  total: string;
  percent: number;
  icon: string;
}) {
  return (
    <div className="bg-card border rounded-xl p-4">
      <div className="flex items-center gap-2 mb-3">
        <span className="mono text-xs text-muted-foreground">{icon}</span>
        <span className="text-xs font-medium uppercase tracking-wider text-muted-foreground">{title}</span>
      </div>
      <div className="flex items-center gap-2 mb-3">
        <span className="mono text-base font-medium">{used}</span>
        <span className="text-muted-foreground text-sm">/</span>
        <span className="mono text-base text-muted-foreground">{total}</span>
      </div>
      <div className="h-1.5 bg-muted rounded-full mb-2 overflow-hidden">
        <div
          className="h-full bg-primary rounded-full transition-all duration-300"
          style={{ width: `${Math.min(percent, 100)}%` }}
        />
      </div>
      <div className="mono text-xs text-muted-foreground text-right">{percent}%</div>
    </div>
  );
}

function NetworkCard({ incoming, outgoing }: {
  incoming: string;
  outgoing: string;
}) {
  return (
    <div className="bg-card border rounded-xl p-4 flex flex-col justify-between">
      <div className="flex items-center gap-2 mb-3">
        <span className="mono text-xs text-muted-foreground">[N]</span>
        <span className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Network</span>
      </div>
      <div className="flex flex-col gap-3">
        <div className="flex justify-between items-center">
          <span className="text-xs text-muted-foreground">IN</span>
          <span className="mono text-sm font-medium">{incoming}</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-xs text-muted-foreground">OUT</span>
          <span className="mono text-sm font-medium">{outgoing}</span>
        </div>
      </div>
    </div>
  );
}

function QuickActionCard({ title, description, icon, href }: {
  title: string;
  description: string;
  icon: string;
  href: string;
}) {
  return (
    <a href={href} className="bg-card border rounded-xl p-4 flex items-center gap-3 transition-all hover:border-primary hover:shadow-md no-underline">
      <span className="mono text-lg text-primary">{icon}</span>
      <div className="flex-1">
        <div className="font-medium text-sm mb-0.5">{title}</div>
        <div className="text-xs text-muted-foreground">{description}</div>
      </div>
    </a>
  );
}

function ProjectCard({ project, organizations }: { project: Project; organizations: Organization[] }) {
  const org = organizations?.find(o => o.id === project.organization_id);
  return (
    <div className="bg-card border rounded-xl p-4">
      <div className="flex justify-between items-center mb-2">
        <span className="mono text-sm font-medium">{project.slug}</span>
        <ProjectStatus status={project.status} />
      </div>
      <div className="text-xs text-muted-foreground">{org?.name || 'Unknown'}</div>
    </div>
  );
}

function ProjectStatus({ status }: { status: string }) {
  const statusConfig: Record<string, { label: string; className: string }> = {
    active: { label: 'ACTIVE', className: 'bg-green-100 dark:bg-green-950/30 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800' },
    provisioning: { label: 'PROVISIONING', className: 'bg-yellow-100 dark:bg-yellow-950/30 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-800' },
    suspended: { label: 'SUSPENDED', className: 'bg-red-100 dark:bg-red-950/30 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800' },
    archived: { label: 'ARCHIVED', className: 'bg-gray-100 dark:bg-gray-950/30 text-gray-700 dark:text-gray-400 border-gray-200 dark:border-gray-800' },
  };

  const config = statusConfig[status] || { label: status.toUpperCase(), className: 'bg-gray-100 dark:bg-gray-950/30 text-gray-700 dark:text-gray-400 border-gray-200 dark:border-gray-800' };

  return (
    <span className={`mono text-xs px-2 py-1 rounded-md border ${config.className}`}>
      {config.label}
    </span>
  );
}
