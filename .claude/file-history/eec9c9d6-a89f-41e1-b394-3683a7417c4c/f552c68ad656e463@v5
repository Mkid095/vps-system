'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useEffect, useState } from 'react';

interface NavItem {
  href: string;
  label: string;
  icon: string;
}

const navItems: NavItem[] = [
  { href: '/', label: 'Home', icon: '⌂' },
  { href: '/databases', label: 'Databases', icon: '◉' },
  { href: '/whatsapp', label: 'WhatsApp', icon: '✆' },
  { href: '/deploy', label: 'Deploy', icon: '⬆' },
  { href: '/backup', label: 'Backup', icon: '⎙' },
  { href: '/emails', label: 'Emails', icon: '✉' },
];

export function Sidebar() {
  const pathname = usePathname();
  const [user, setUser] = useState<{ email: string } | null>(null);
  const [isCollapsed, setIsCollapsed] = useState(false);

  useEffect(() => {
    const token = localStorage.getItem('supabase_access_token');
    if (token) {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        setUser({ email: payload.email || '' });
      } catch (error) {
        console.error('Failed to decode token:', error);
      }
    }

    // Check for mobile/collapsed state
    const handleResize = () => {
      setIsCollapsed(window.innerWidth < 1024);
    };

    handleResize();
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/signout', { method: 'POST' });
      localStorage.removeItem('supabase_access_token');
      window.location.href = '/auth/signin';
    } catch (error) {
      console.error('Logout failed:', error);
      window.location.href = '/auth/signin';
    }
  };

  return (
    <aside className={`fixed top-0 left-0 h-screen bg-white border-r border-gray-200 flex flex-col z-50 transition-all duration-300 ${
      isCollapsed ? 'w-20' : 'w-64'
      }`}>
      {/* Logo */}
      <div className="p-6 border-b border-gray-200">
        <Link href="/" className="flex items-center justify-center no-underline">
          <img
            src="https://www.nextmavens.com/logo-colored.png"
            alt="NextMavens"
            className={`object-contain transition-all duration-300 ${
              isCollapsed ? 'w-10 h-10' : 'w-16 h-16'
            }`}
          />
        </Link>
      </div>

      {/* Navigation */}
      <nav className="flex-1 overflow-y-auto py-6">
        <ul className="list-none m-0 p-0 space-y-1">
          {navItems.map((item) => {
            const isActive = pathname === item.href;
            return (
              <li key={item.href}>
                <Link
                  href={item.href}
                  className={`flex items-center gap-3 py-3 px-4 mx-3 rounded-lg transition-all duration-200 ${
                    isActive
                      ? 'bg-indigo-50 text-indigo-600 font-medium'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                  title={isCollapsed ? item.label : undefined}
                >
                  <span className="text-lg">{item.icon}</span>
                  {!isCollapsed && <span>{item.label}</span>}
                </Link>
              </li>
            );
          })}
        </ul>
      </nav>

      {/* User section */}
      {user && (
        <div className="p-4 border-t border-gray-200">
          {!isCollapsed && (
            <div className="mb-3 px-2">
              <p className="text-xs text-gray-500 mb-1">Signed in as</p>
              <p className="text-sm font-medium text-gray-900 truncate">{user.email}</p>
            </div>
          )}
          <button
            onClick={handleLogout}
            className="flex items-center gap-3 w-full py-2.5 px-4 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200"
            title={isCollapsed ? 'Logout' : undefined}
          >
            <span className="text-lg">⎋</span>
            {!isCollapsed && <span>Logout</span>}
          </button>
        </div>
      )}
    </aside>
  );
}
