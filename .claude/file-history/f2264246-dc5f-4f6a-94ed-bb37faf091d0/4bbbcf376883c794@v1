#!/usr/bin/env python3
import asyncio
import websockets
import json
import requests

# Login to get token
response = requests.post('https://auth.nextmavens.cloud/api/auth/login',
    json={'email': 'realtime@test.com', 'password': 'TestPass123'})
data = response.json()
token = data['accessToken']
tenant_id = data['user']['tenant_id']

print(f"Token: {token[:50]}...")
print(f"Tenant ID: {tenant_id}")

async def test_realtime():
    uri = f"wss://realtime.nextmavens.cloud/?token={token}"

    async with websockets.connect(uri) as websocket:
        print("Connected to WebSocket")

        # Subscribe to users channel
        subscribe_msg = {
            "type": "subscribe",
            "channel": "users"
        }
        await websocket.send(json.dumps(subscribe_msg))
        print(f"Sent: {subscribe_msg}")

        # Wait for subscription confirmation
        response = await asyncio.wait_for(websocket.recv(), timeout=5)
        print(f"Received: {response}")

        # Subscribe to presence
        presence_msg = {
            "type": "presence",
            "channel": "online",
            "payload": {"status": "online"}
        }
        await websocket.send(json.dumps(presence_msg))
        print(f"Sent: {presence_msg}")

        # Wait for presence state
        response = await asyncio.wait_for(websocket.recv(), timeout=5)
        print(f"Received: {response}")

        print("\nWaiting for notifications (10 seconds)...")

        # Trigger a database change via HTTP
        print("\nTriggering database change...")
        trigger_response = requests.post('https://auth.nextmavens.cloud/api/auth/login',
            json={'email': 'realtime@test.com', 'password': 'TestPass123'})
        print(f"Trigger response status: {trigger_response.status_code}")

        # Wait for real-time notification
        try:
            response = await asyncio.wait_for(websocket.recv(), timeout=5)
            print(f"\nReal-time notification received: {response}")
        except asyncio.TimeoutError:
            print("\nNo notification received within timeout")

        # Send ping
        ping_msg = {"type": "ping"}
        await websocket.send(json.dumps(ping_msg))
        response = await asyncio.wait_for(websocket.recv(), timeout=5)
        print(f"Ping response: {response}")

if __name__ == "__main__":
    try:
        asyncio.run(test_realtime())
    except Exception as e:
        print(f"Error: {e}")
