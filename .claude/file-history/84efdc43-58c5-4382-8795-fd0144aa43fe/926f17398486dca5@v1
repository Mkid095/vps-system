/**
 * Auth Module - Authentication and user management
 */

import { SignInCredentials, SignUpCredentials, AuthTokens, User, AuthError, NextMavensConfig } from './types';

export class AuthClient {
  private config: NextMavensConfig;
  private accessToken: string | null = null;
  private refreshToken: string | null = null;
  private user: User | null = null;

  constructor(config: NextMavensConfig) {
    this.config = config;
  }

  /**
   * Sign in a user
   */
  async signIn(credentials: SignInCredentials): Promise<AuthTokens> {
    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey
        },
        body: JSON.stringify(credentials)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Sign in failed', 'SIGN_IN_FAILED');
      }

      this.accessToken = data.accessToken;
      this.refreshToken = data.refreshToken;
      this.user = data.user;

      return {
        accessToken: this.accessToken,
        refreshToken: this.refreshToken,
        user: this.user
      };
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Sign in failed', 'NETWORK_ERROR');
    }
  }

  /**
   * Sign up a new user
   */
  async signUp(credentials: SignUpCredentials): Promise<AuthTokens> {
    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/signup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey
        },
        body: JSON.stringify(credentials)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Sign up failed', 'SIGN_UP_FAILED');
      }

      this.accessToken = data.accessToken;
      this.refreshToken = data.refreshToken;
      this.user = data.user;

      return {
        accessToken: this.accessToken,
        refreshToken: this.refreshToken,
        user: this.user
      };
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Sign up failed', 'NETWORK_ERROR');
    }
  }

  /**
   * Sign out the current user
   */
  async signOut(): Promise<void> {
    this.accessToken = null;
    this.refreshToken = null;
    this.user = null;
  }

  /**
   * Get the current access token
   */
  getAccessToken(): string | null {
    return this.accessToken;
  }

  /**
   * Get the current refresh token
   */
  getRefreshToken(): string | null {
    return this.refreshToken;
  }

  /**
   * Get the current user
   */
  getUser(): User | null {
    return this.user;
  }

  /**
   * Set auth tokens manually
   */
  setTokens(tokens: { accessToken: string; refreshToken: string }): void {
    this.accessToken = tokens.accessToken;
    this.refreshToken = tokens.refreshToken;
  }

  /**
   * Refresh the access token
   */
  async refreshAccessToken(): Promise<string> {
    if (!this.refreshToken) {
      throw new AuthError('No refresh token available', 'NO_REFRESH_TOKEN');
    }

    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/refresh`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey
        },
        body: JSON.stringify({ refreshToken: this.refreshToken })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Token refresh failed', 'REFRESH_FAILED');
      }

      this.accessToken = data.accessToken;
      if (data.refreshToken) {
        this.refreshToken = data.refreshToken;
      }
      if (data.user) {
        this.user = data.user;
      }

      return this.accessToken;
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Token refresh failed', 'NETWORK_ERROR');
    }
  }

  /**
   * Get the current user from the server
   */
  async getCurrentUser(): Promise<User> {
    if (!this.accessToken) {
      throw new AuthError('Not authenticated', 'NOT_AUTHENTICATED');
    }

    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/me`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey,
          'Authorization': `Bearer ${this.accessToken}`
        }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Failed to get user', 'GET_USER_FAILED');
      }

      this.user = data.user;
      return data.user;
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Failed to get user', 'NETWORK_ERROR');
    }
  }

  /**
   * Update user profile
   */
  async updateProfile(updates: { name?: string }): Promise<User> {
    if (!this.accessToken) {
      throw new AuthError('Not authenticated', 'NOT_AUTHENTICATED');
    }

    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/profile`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey,
          'Authorization': `Bearer ${this.accessToken}`
        },
        body: JSON.stringify(updates)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Profile update failed', 'UPDATE_FAILED');
      }

      this.user = data.user;
      return data.user;
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Profile update failed', 'NETWORK_ERROR');
    }
  }

  /**
   * Change password
   */
  async changePassword(oldPassword: string, newPassword: string): Promise<void> {
    if (!this.accessToken) {
      throw new AuthError('Not authenticated', 'NOT_AUTHENTICATED');
    }

    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/change-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey,
          'Authorization': `Bearer ${this.accessToken}`
        },
        body: JSON.stringify({ oldPassword, newPassword })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Password change failed', 'PASSWORD_CHANGE_FAILED');
      }
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Password change failed', 'NETWORK_ERROR');
    }
  }

  /**
   * Request password reset
   */
  async requestPasswordReset(email: string): Promise<void> {
    try {
      const response = await fetch(`${this.config.authUrl}/api/auth/forgot-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': this.config.apiKey
        },
        body: JSON.stringify({ email })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new AuthError(data.error || 'Password reset request failed', 'RESET_REQUEST_FAILED');
      }
    } catch (error) {
      if (error instanceof AuthError) throw error;
      throw new AuthError('Password reset request failed', 'NETWORK_ERROR');
    }
  }
}
