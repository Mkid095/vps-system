'use client';

import { useEffect, useState } from 'react';
import { useAuth, useOrganization } from '@/lib/store';
import { api, Project, WhatsappInstance } from '@/lib/api';
import type { Organization } from '@/lib/api';
import { OrganizationSwitcher } from '@/components/organization-switcher';
import { ToastContainer, notify } from '@/components/toast-notifications';
import { NotificationButton } from '@/components/notification-center';

interface OrganizationWithProjects extends Organization {
  projects: ProjectWithInstances[];
}

interface ProjectWithInstances extends Project {
  whatsappInstances?: WhatsappInstance[];
}

interface CreatedProjectData {
  name: string;
  slug: string;
  anonKey: string;
  serviceRoleKey: string;
  connectionString: string;
}

export default function DashboardPage() {
  const { user, loading, initialized, initialize, signOut } = useAuth();
  const { selectedOrganizationId, getSelectedOrganization } = useOrganization();
  const [organizations, setOrganizations] = useState<OrganizationWithProjects[]>([]);
  const [showCreateOrgForm, setShowCreateOrgForm] = useState(false);
  const [showCreateProjectForm, setShowCreateProjectForm] = useState(false);
  const [showCreateInstanceForm, setShowCreateInstanceForm] = useState(false);
  const [showApiKeysModal, setShowApiKeysModal] = useState(false);
  const [showQrModal, setShowQrModal] = useState(false);
  const [qrInstanceData, setQrInstanceData] = useState<{ instanceName: string; projectId: string; projectName: string } | null>(null);
  const [qrCodeBase64, setQrCodeBase64] = useState<string | null>(null);
  const [qrPairingCode, setQrPairingCode] = useState<string | null>(null);
  const [qrError, setQrError] = useState<string | null>(null);
  const [alreadyConnected, setAlreadyConnected] = useState(false);
  const [connectedPhoneNumber, setConnectedPhoneNumber] = useState<string | null>(null);
  const [createdProjectData, setCreatedProjectData] = useState<CreatedProjectData | null>(null);
  const [selectedOrgId, setSelectedOrgId] = useState<string>('');
  const [selectedProjectId, setSelectedProjectId] = useState<string>('');
  const [orgName, setOrgName] = useState('');
  const [orgSlug, setOrgSlug] = useState('');
  const [projectName, setProjectName] = useState('');
  const [projectSlug, setProjectSlug] = useState('');
  const [projectDescription, setProjectDescription] = useState('');
  const [instanceName, setInstanceName] = useState('');
  const [formError, setFormError] = useState('');
  const [dataLoading, setDataLoading] = useState(false);

  useEffect(() => {
    if (!initialized) {
      initialize();
    }
  }, [initialize, initialized]);

  useEffect(() => {
    if (user) {
      fetchDashboardData();
    }
  }, [user]);

  useEffect(() => {
    if (!showQrModal || !qrInstanceData || alreadyConnected) {
      return;
    }

    const pollQrCode = async () => {
      try {
        const response = await api.getWhatsappQrCode(qrInstanceData.instanceName, qrInstanceData.projectId);

        if (response.already_connected) {
          setAlreadyConnected(true);
          setConnectedPhoneNumber(response.phone_number || null);
          setQrCodeBase64(null);
          setQrPairingCode(null);
          fetchDashboardData();
          return;
        }

        if (response.qr_code_base64) {
          setQrCodeBase64(response.qr_code_base64);
          setQrPairingCode(response.pairing_code || null);
          setQrError(null);
        }
      } catch (error) {
        console.error('Failed to fetch QR code:', error);
        setQrError(error instanceof Error ? error.message : 'Failed to fetch QR code');
      }
    };

    pollQrCode();
    const interval = setInterval(pollQrCode, 3000);
    return () => clearInterval(interval);
  }, [showQrModal, qrInstanceData, alreadyConnected]);

  useEffect(() => {
    if (!user) {
      return;
    }

    const getInstancesToPoll = (): Array<{ instanceName: string; projectId: string }> => {
      const instances: Array<{ instanceName: string; projectId: string }> = [];
      for (const org of organizations) {
        for (const project of org.projects) {
          if (project.whatsappInstances) {
            for (const instance of project.whatsappInstances) {
              if (['pending', 'connecting', 'disconnected'].includes(instance.status)) {
                instances.push({
                  instanceName: instance.instance_name,
                  projectId: project.id,
                });
              }
            }
          }
        }
      }
      return instances;
    };

    const pollInstanceStatus = async () => {
      const instancesToPoll = getInstancesToPoll();
      if (instancesToPoll.length === 0) {
        return;
      }

      for (const { instanceName, projectId } of instancesToPoll) {
        try {
          const response = await api.getWhatsappInstanceStatus(instanceName, projectId);
          if (response && (response.state === 'open' || response.status === 'connected')) {
            fetchDashboardData();
          }
        } catch (error) {
          console.error(`Failed to fetch status for ${instanceName}:`, error);
        }
      }
    };

    pollInstanceStatus();
    const interval = setInterval(pollInstanceStatus, 5000);
    return () => clearInterval(interval);
  }, [user, organizations]);

  const fetchDashboardData = async () => {
    setDataLoading(true);
    try {
      const [orgsResponse, projectsResponse] = await Promise.all([
        api.getOrganizations(),
        api.getProjects(),
      ]);

      const orgsWithProjects: OrganizationWithProjects[] = orgsResponse.items.map(org => ({
        ...org,
        projects: projectsResponse.items.filter(p => p.organization_id === org.id),
      }));

      setOrganizations(orgsWithProjects);
    } catch (error) {
      console.error('Failed to fetch dashboard data:', error);
    } finally {
      setDataLoading(false);
    }
  };

  const handleCreateOrganization = async (e: React.FormEvent) => {
    e.preventDefault();
    setFormError('');

    try {
      const response = await api.createOrganization({
        name: orgName,
        slug: orgSlug || undefined,
      });
      const newOrg: OrganizationWithProjects = { ...response.data, projects: [] };
      setOrganizations([...organizations, newOrg]);
      setOrgName('');
      setOrgSlug('');
      setShowCreateOrgForm(false);
    } catch (error: unknown) {
      if (error instanceof Error) {
        setFormError(error.message);
      } else {
        setFormError('Failed to create organization');
      }
    }
  };

  const handleCreateProject = async (e: React.FormEvent) => {
    e.preventDefault();
    setFormError('');

    if (!selectedOrgId) {
      setFormError('Please select an organization');
      return;
    }

    try {
      const response = await api.createProject(selectedOrgId, {
        name: projectName,
        slug: projectSlug || undefined,
        description: projectDescription || undefined,
      });

      notify.success('Project Created', `Project "${response.name}" has been created successfully.`, response.id);

      if (response.api_keys && response.connection_string) {
        setCreatedProjectData({
          name: response.name,
          slug: response.slug,
          anonKey: response.api_keys.anon,
          serviceRoleKey: response.api_keys.service_role,
          connectionString: response.connection_string,
        });
        setShowApiKeysModal(true);
      }

      setOrganizations(organizations.map(org =>
        org.id === selectedOrgId
          ? { ...org, projects: [...org.projects, response] }
          : org
      ));
      setProjectName('');
      setProjectSlug('');
      setProjectDescription('');
      setShowCreateProjectForm(false);
      setSelectedOrgId('');
    } catch (error: unknown) {
      if (error instanceof Error) {
        setFormError(error.message);
      } else {
        setFormError('Failed to create project');
      }
    }
  };

  const handleCreateWhatsappInstance = async (e: React.FormEvent) => {
    e.preventDefault();
    setFormError('');

    if (!selectedProjectId) {
      setFormError('Please select a project');
      return;
    }

    try {
      const newInstance = await api.createWhatsappInstance(selectedProjectId, {
        instance_name: instanceName,
      });

      notify.info(
        'WhatsApp Instance Created',
        `Instance "${instanceName}" has been created. Connect it using QR code.`,
        'whatsapp_connect',
        selectedProjectId
      );

      setOrganizations(organizations.map(org =>
        org.id === selectedOrgId
          ? { ...org, projects: org.projects.map(proj =>
              proj.id === selectedProjectId
                ? { ...proj, whatsappInstances: [...(proj.whatsappInstances || []), newInstance] }
                : proj
            )}
          : org
      ));

      setInstanceName('');
      setShowCreateInstanceForm(false);
      setSelectedProjectId('');
    } catch (error: unknown) {
      if (error instanceof Error) {
        setFormError(error.message);
      } else {
        setFormError('Failed to create WhatsApp instance');
      }
    }
  };

  const handleOpenQrModal = (instance: WhatsappInstance, projectName: string) => {
    setQrInstanceData({
      instanceName: instance.instance_name,
      projectId: instance.project_id,
      projectName,
    });
    setQrCodeBase64(null);
    setQrPairingCode(null);
    setQrError(null);
    setAlreadyConnected(instance.status === 'connected');
    setConnectedPhoneNumber(instance.phone_number || null);
    setShowQrModal(true);
  };

  const handleCloseQrModal = () => {
    setShowQrModal(false);
    setQrInstanceData(null);
    setQrCodeBase64(null);
    setQrPairingCode(null);
    setQrError(null);
    setAlreadyConnected(false);
    setConnectedPhoneNumber(null);
    fetchDashboardData();
  };

  const handleSignOut = async () => {
    await signOut();
    setOrganizations([]);
  };

  const totalProjects = organizations.reduce((sum, org) => sum + org.projects.length, 0);
  const activeProjects = organizations.reduce((sum, org) =>
    sum + org.projects.filter(p => p.status === 'active').length, 0);

  const getStatusBadge = (status: string) => {
    const styles = {
      active: 'bg-emerald-50 text-emerald-700 border-emerald-200',
      provisioning: 'bg-amber-50 text-amber-700 border-amber-200',
      suspended: 'bg-red-50 text-red-700 border-red-200',
      archived: 'bg-gray-100 text-gray-700 border-gray-300',
    };
    const statusStyle = styles[status as keyof typeof styles] || styles.archived;
    return (
      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusStyle}`}>
        {status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
    );
  };

  const getWhatsappStatusBadge = (status: string) => {
    const styles = {
      connected: 'bg-emerald-50 text-emerald-700 border-emerald-200',
      connecting: 'bg-amber-50 text-amber-700 border-amber-200',
      pending: 'bg-gray-100 text-gray-700 border-gray-300',
      disconnected: 'bg-red-50 text-red-700 border-red-200',
      error: 'bg-red-50 text-red-700 border-red-200',
    };
    const statusStyle = styles[status as keyof typeof styles] || styles.pending;
    return (
      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusStyle}`}>
        {status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
    );
  };

  if (loading || !initialized) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-50">
        <div className="text-gray-600">Loading...</div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-50">
        <div className="w-full max-w-md rounded-lg border border-gray-200 bg-white p-8">
          <h1 className="mb-2 text-xl font-semibold text-gray-900">NextMavens Platform</h1>
          <p className="mb-6 text-sm text-gray-600">Please sign in to continue</p>
          <a
            href="/login"
            className="block w-full rounded-md bg-blue-600 px-4 py-2 text-center text-sm font-medium text-white hover:bg-blue-700"
          >
            Sign In
          </a>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Navigation */}
      <nav className="border-b border-gray-200 bg-white px-6 py-3">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <h1 className="text-lg font-semibold text-gray-900">NextMavens Platform</h1>
            {organizations.length > 0 && (
              <OrganizationSwitcher organizations={organizations} />
            )}
          </div>
          <div className="flex items-center gap-4">
            <NotificationButton />
            <span className="text-sm text-gray-600">{user.email}</span>
            <button
              onClick={handleSignOut}
              className="rounded-md px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-100"
            >
              Sign Out
            </button>
          </div>
        </div>
      </nav>

      {/* Toast Container */}
      <ToastContainer />

      <main className="mx-auto max-w-7xl px-6 py-8">
        {/* Statistics */}
        <div className="mb-8 grid gap-4 sm:grid-cols-3">
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <p className="text-sm font-medium text-gray-600">Total Organizations</p>
            <p className="mt-2 text-2xl font-semibold text-gray-900">{organizations.length}</p>
          </div>
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <p className="text-sm font-medium text-gray-600">Total Projects</p>
            <p className="mt-2 text-2xl font-semibold text-gray-900">{totalProjects}</p>
          </div>
          <div className="rounded-lg border border-gray-200 bg-white p-6">
            <p className="text-sm font-medium text-gray-600">Active Projects</p>
            <p className="mt-2 text-2xl font-semibold text-gray-900">{activeProjects}</p>
          </div>
        </div>

        {/* Quick Actions */}
        <div className="mb-8 flex flex-wrap gap-3">
          <button
            onClick={() => setShowCreateOrgForm(!showCreateOrgForm)}
            className="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
          >
            New Organization
          </button>
          <button
            onClick={() => {
              if (selectedOrganizationId) {
                setSelectedOrgId(selectedOrganizationId);
              }
              setShowCreateProjectForm(!showCreateProjectForm);
            }}
            className="inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700"
            disabled={!selectedOrganizationId}
          >
            New Project
          </button>
          <button
            onClick={() => {
              if (selectedOrganizationId) {
                setSelectedProjectId(selectedOrganizationId);
              }
              setShowCreateInstanceForm(!showCreateInstanceForm);
            }}
            className="inline-flex items-center rounded-md bg-purple-600 px-4 py-2 text-sm font-medium text-white hover:bg-purple-700"
            disabled={!selectedOrganizationId}
          >
            New WhatsApp Instance
          </button>
        </div>

        {/* Create Organization Form */}
        {showCreateOrgForm && (
          <div className="mb-8 rounded-lg border border-gray-200 bg-white p-6">
            <h3 className="mb-4 text-lg font-semibold text-gray-900">Create Organization</h3>
            <form onSubmit={handleCreateOrganization}>
              <div className="mb-4">
                <label htmlFor="orgName" className="mb-1 block text-sm font-medium text-gray-700">
                  Organization Name
                </label>
                <input
                  type="text"
                  id="orgName"
                  value={orgName}
                  onChange={(e) => setOrgName(e.target.value)}
                  required
                  minLength={2}
                  maxLength={100}
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="My Organization"
                />
              </div>
              <div className="mb-4">
                <label htmlFor="orgSlug" className="mb-1 block text-sm font-medium text-gray-700">
                  Slug (optional)
                </label>
                <input
                  type="text"
                  id="orgSlug"
                  value={orgSlug}
                  onChange={(e) => setOrgSlug(e.target.value)}
                  pattern="[a-z0-9-]+"
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="my-organization"
                />
                <p className="mt-1 text-xs text-gray-500">
                  Only lowercase letters, numbers, and hyphens. Auto-generated if not provided.
                </p>
              </div>
              {formError && (
                <div className="mb-4 rounded-md bg-red-50 p-3 text-sm text-red-700">
                  {formError}
                </div>
              )}
              <div className="flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowCreateOrgForm(false)}
                  className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
                >
                  Create Organization
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Create Project Form */}
        {showCreateProjectForm && (
          <div className="mb-8 rounded-lg border border-gray-200 bg-white p-6">
            <h3 className="mb-4 text-lg font-semibold text-gray-900">Create Project</h3>
            <form onSubmit={handleCreateProject}>
              <div className="mb-4">
                <label htmlFor="orgSelect" className="mb-1 block text-sm font-medium text-gray-700">
                  Organization
                </label>
                <select
                  id="orgSelect"
                  value={selectedOrgId}
                  onChange={(e) => setSelectedOrgId(e.target.value)}
                  required
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                >
                  <option value="">Select an organization</option>
                  {organizations.map((org) => (
                    <option key={org.id} value={org.id}>
                      {org.name}
                    </option>
                  ))}
                </select>
              </div>
              <div className="mb-4">
                <label htmlFor="projName" className="mb-1 block text-sm font-medium text-gray-700">
                  Project Name
                </label>
                <input
                  type="text"
                  id="projName"
                  value={projectName}
                  onChange={(e) => setProjectName(e.target.value)}
                  required
                  minLength={2}
                  maxLength={100}
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="My Project"
                />
              </div>
              <div className="mb-4">
                <label htmlFor="projSlug" className="mb-1 block text-sm font-medium text-gray-700">
                  Slug (optional)
                </label>
                <input
                  type="text"
                  id="projSlug"
                  value={projectSlug}
                  onChange={(e) => setProjectSlug(e.target.value)}
                  pattern="[a-z0-9-]+"
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="my-project"
                />
              </div>
              <div className="mb-4">
                <label htmlFor="projDesc" className="mb-1 block text-sm font-medium text-gray-700">
                  Description (optional)
                </label>
                <textarea
                  id="projDesc"
                  value={projectDescription}
                  onChange={(e) => setProjectDescription(e.target.value)}
                  rows={3}
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                  placeholder="Project description"
                />
              </div>
              {formError && (
                <div className="mb-4 rounded-md bg-red-50 p-3 text-sm text-red-700">
                  {formError}
                </div>
              )}
              <div className="flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowCreateProjectForm(false)}
                  className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="rounded-md bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700"
                >
                  Create Project
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Create WhatsApp Instance Form */}
        {showCreateInstanceForm && (
          <div className="mb-8 rounded-lg border border-gray-200 bg-white p-6">
            <h3 className="mb-4 text-lg font-semibold text-gray-900">Create WhatsApp Instance</h3>
            <form onSubmit={handleCreateWhatsappInstance}>
              <div className="mb-4">
                <label htmlFor="projectSelect" className="mb-1 block text-sm font-medium text-gray-700">
                  Project
                </label>
                <select
                  id="projectSelect"
                  value={selectedProjectId}
                  onChange={(e) => setSelectedProjectId(e.target.value)}
                  required
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500"
                >
                  <option value="">Select a project</option>
                  {organizations.flatMap(org =>
                    org.projects.map((project) => (
                      <option key={project.id} value={project.id}>
                        {org.name} / {project.name}
                      </option>
                    ))
                  )}
                </select>
              </div>
              <div className="mb-4">
                <label htmlFor="instanceName" className="mb-1 block text-sm font-medium text-gray-700">
                  Instance Name
                </label>
                <input
                  type="text"
                  id="instanceName"
                  value={instanceName}
                  onChange={(e) => setInstanceName(e.target.value)}
                  required
                  minLength={2}
                  maxLength={50}
                  pattern="[a-zA-Z0-9_-]+"
                  className="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-1 focus:ring-purple-500"
                  placeholder="my-instance"
                />
                <p className="mt-1 text-xs text-gray-500">
                  Only letters, numbers, hyphens, and underscores.
                </p>
              </div>
              {formError && (
                <div className="mb-4 rounded-md bg-red-50 p-3 text-sm text-red-700">
                  {formError}
                </div>
              )}
              <div className="flex justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowCreateInstanceForm(false)}
                  className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="rounded-md bg-purple-600 px-4 py-2 text-sm font-medium text-white hover:bg-purple-700"
                >
                  Create Instance
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Organizations and Projects */}
        {dataLoading ? (
          <div className="py-12 text-center">
            <p className="text-gray-600">Loading...</p>
          </div>
        ) : organizations.length === 0 ? (
          <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
            <h3 className="mb-2 text-lg font-semibold text-gray-900">No organizations yet</h3>
            <p className="mb-4 text-sm text-gray-600">Create your first organization to get started</p>
            <button
              onClick={() => setShowCreateOrgForm(true)}
              className="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
            >
              Create Organization
            </button>
          </div>
        ) : selectedOrganizationId ? (
          <div className="space-y-6">
            {(() => {
              const selectedOrg = organizations.find(org => org.id === selectedOrganizationId);
              if (!selectedOrg) return null;

              return (
                <div key={selectedOrg.id} className="rounded-lg border border-gray-200 bg-white p-6">
                  <div className="mb-4 flex items-center justify-between">
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">{selectedOrg.name}</h3>
                      <p className="text-sm text-gray-500">/{selectedOrg.slug}</p>
                    </div>
                    <span className="inline-flex items-center rounded-full bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700">
                      {selectedOrg.role || 'member'}
                    </span>
                  </div>

                  {selectedOrg.projects.length === 0 ? (
                    <div className="rounded-md bg-gray-50 p-6 text-center">
                      <p className="mb-3 text-sm text-gray-600">No projects yet</p>
                      <button
                        onClick={() => {
                          setSelectedOrgId(selectedOrg.id);
                          setShowCreateProjectForm(true);
                        }}
                        className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-emerald-700"
                      >
                        Create First Project
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {selectedOrg.projects.map((project) => (
                        <div key={project.id} className="rounded-md border border-gray-200 p-4 hover:border-gray-300">
                          <div className="mb-2 flex items-center justify-between">
                            <div>
                              <h4 className="font-medium text-gray-900">{project.name}</h4>
                              <p className="text-sm text-gray-500">/{project.slug}</p>
                            </div>
                            {getStatusBadge(project.status)}
                          </div>

                          <div className="mt-3 border-l-2 border-gray-200 pl-4">
                            <div className="mb-2 flex items-center justify-between">
                              <h5 className="text-xs font-semibold uppercase tracking-wide text-gray-500">WhatsApp Instances</h5>
                              <button
                                onClick={() => {
                                  setSelectedProjectId(project.id);
                                  setShowCreateInstanceForm(true);
                                }}
                                className="text-xs font-medium text-purple-600 hover:text-purple-700"
                              >
                                Add Instance
                              </button>
                            </div>

                            {project.whatsappInstances && project.whatsappInstances.length > 0 ? (
                              <div className="space-y-2">
                                {project.whatsappInstances.map((instance) => (
                                  <div
                                    key={instance.id}
                                    className="flex items-center justify-between rounded-md border border-gray-200 bg-white px-3 py-2 text-sm"
                                  >
                                    <div>
                                      <span className="font-medium text-gray-900">{instance.instance_name}</span>
                                      {instance.phone_number && (
                                        <span className="ml-2 text-gray-500">{instance.phone_number}</span>
                                      )}
                                    </div>
                                    <div className="flex items-center gap-2">
                                      {getWhatsappStatusBadge(instance.status)}
                                      {instance.status !== 'connected' && (
                                        <button
                                          onClick={() => handleOpenQrModal(instance, project.name)}
                                          className="text-xs font-medium text-purple-600 hover:text-purple-700"
                                        >
                                          {instance.status === 'connecting' ? 'View QR' : 'Connect'}
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-xs text-gray-400">No WhatsApp instances configured</p>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}
          </div>
        ) : (
          <div className="rounded-lg border border-gray-200 bg-white p-12 text-center">
            <p className="text-sm text-gray-600">Select an organization to view projects</p>
          </div>
        )}
      </main>

      {/* API Keys Modal */}
      {showApiKeysModal && createdProjectData && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 px-4">
          <div className="w-full max-w-2xl rounded-lg border border-gray-200 bg-white p-6">
            <div className="mb-4 flex items-center justify-between">
              <h3 className="text-lg font-semibold text-gray-900">Project Created - Save Your API Keys</h3>
              <button
                onClick={() => setShowApiKeysModal(false)}
                className="text-gray-400 hover:text-gray-600"
              >
                ✕
              </button>
            </div>

            <div className="mb-4 rounded-md bg-amber-50 border border-amber-200 p-4">
              <p className="text-sm text-amber-800">
                <span className="font-semibold">Important:</span> Save these API keys now. You won't be able to see them again.
              </p>
            </div>

            <div className="space-y-4">
              <div>
                <label className="mb-1 block text-sm font-medium text-gray-700">Project Name</label>
                <div className="rounded-md bg-gray-100 p-2 text-sm">{createdProjectData.name}</div>
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium text-gray-700">Anonymous Key (public)</label>
                <div className="rounded-md bg-gray-100 p-2 text-sm font-mono break-all">
                  {createdProjectData.anonKey}
                </div>
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium text-gray-700">Service Role Key (secret)</label>
                <div className="rounded-md bg-gray-100 p-2 text-sm font-mono break-all">
                  {createdProjectData.serviceRoleKey}
                </div>
              </div>

              <div>
                <label className="mb-1 block text-sm font-medium text-gray-700">Connection String</label>
                <div className="rounded-md bg-gray-100 p-2 text-xs font-mono break-all">
                  {createdProjectData.connectionString}
                </div>
              </div>
            </div>

            <div className="mt-6 flex justify-end gap-3">
              <button
                onClick={() => {
                  navigator.clipboard.writeText(
                    `Anonymous Key: ${createdProjectData.anonKey}\nService Role Key: ${createdProjectData.serviceRoleKey}\nConnection String: ${createdProjectData.connectionString}`
                  );
                }}
                className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >
                Copy All
              </button>
              <button
                onClick={() => setShowApiKeysModal(false)}
                className="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
              >
                I've Saved My Keys
              </button>
            </div>
          </div>
        </div>
      )}

      {/* QR Code Modal */}
      {showQrModal && qrInstanceData && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 px-4">
          <div className="w-full max-w-md rounded-lg border border-gray-200 bg-white p-6">
            <div className="mb-4 flex items-center justify-between">
              <h3 className="text-lg font-semibold text-gray-900">Connect WhatsApp</h3>
              <button
                onClick={handleCloseQrModal}
                className="text-gray-400 hover:text-gray-600"
              >
                ✕
              </button>
            </div>

            <div className="mb-4 text-sm text-gray-600">
              <p><span className="font-medium">Instance:</span> {qrInstanceData.instanceName}</p>
              <p><span className="font-medium">Project:</span> {qrInstanceData.projectName}</p>
            </div>

            {alreadyConnected ? (
              <div className="py-8 text-center">
                <div className="mb-4 text-emerald-600">
                  <svg className="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <h4 className="text-lg font-semibold text-emerald-700 mb-2">Connected</h4>
                {connectedPhoneNumber && (
                  <p className="text-gray-600">{connectedPhoneNumber}</p>
                )}
              </div>
            ) : qrError ? (
              <div className="py-8 text-center">
                <div className="mb-4 text-red-600">
                  <svg className="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
                <h4 className="text-lg font-semibold text-red-700 mb-2">Error</h4>
                <p className="text-sm text-gray-600">{qrError}</p>
              </div>
            ) : qrCodeBase64 ? (
              <div className="text-center">
                <p className="mb-4 text-sm text-gray-600">Scan this QR code with WhatsApp</p>
                <div className="mb-4 flex justify-center">
                  <img
                    src={`data:image/png;base64,${qrCodeBase64}`}
                    alt="WhatsApp QR Code"
                    className="rounded-md border border-gray-300"
                  />
                </div>
                {qrPairingCode && (
                  <div className="mb-4 rounded-md bg-gray-100 p-3">
                    <p className="mb-1 text-xs text-gray-600">Or enter this pairing code:</p>
                    <p className="text-lg font-mono font-semibold text-gray-900">{qrPairingCode}</p>
                </div>
                )}
                <p className="text-xs text-gray-500">QR code refreshes every 3 seconds</p>
              </div>
            ) : (
              <div className="py-8 text-center">
                <div className="mx-auto h-12 w-12 animate-spin rounded-full border-4 border-gray-200 border-t-blue-600"></div>
                <p className="mt-4 text-gray-600">Loading QR code...</p>
              </div>
            )}

            <div className="mt-6 flex justify-end">
              <button
                onClick={handleCloseQrModal}
                className="rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
