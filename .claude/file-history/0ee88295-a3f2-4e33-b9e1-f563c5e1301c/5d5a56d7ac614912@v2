#!/bin/bash
# Provision Studio for a specific project
# Usage: ./provision-studio.sh <project-id> <project-slug> <db-name> <port>

set -e

PROJECT_ID=$1
PROJECT_SLUG=$2
DB_NAME=$3
PORT=$4
POSTGRES_PASSWORD=${5:-postgres}

if [ -z "$PROJECT_ID" ] || [ -z "$PROJECT_SLUG" ] || [ -z "$DB_NAME" ] || [ -z "$PORT" ]; then
  echo "Usage: $0 <project-id> <project-slug> <db-name> <port> [postgres-password]"
  exit 1
fi

echo "Provisioning Studio for project: $PROJECT_SLUG (port $PORT)"

# Create docker-compose override for this project's Studio
cat > /home/ken/nextmavens-platform/docker/.studio-${PROJECT_SLUG}.yml <<EOF
version: '3.8'

networks:
  nextmavens-network:
    external: true

services:
  studio-${PROJECT_SLUG}:
    image: supabase/studio:latest
    container_name: nextmavens-studio-${PROJECT_SLUG}
    environment:
      STUDIO_PG_META_URL: http://meta:8080
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DEFAULT_ORGANIZATION_NAME: NextMavens
      DEFAULT_PROJECT_NAME: ${PROJECT_SLUG}
      PG_DATABASE: ${DB_NAME}
      PG_CONNECTION_STRING: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/${DB_NAME}
    ports:
      - "${PORT}:3000"
    networks:
      - nextmavens-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/profile"]
      interval: 30s
      timeout: 10s
      retries: 3
EOF

# Start the Studio container
cd /home/ken/nextmavens-platform/docker
docker compose -f .studio-${PROJECT_SLUG}.yml up -d

echo "Studio provisioned for ${PROJECT_SLUG} on port ${PORT}"
echo "Access at: https://nextmavens.cloud/studio/${PROJECT_SLUG}"
