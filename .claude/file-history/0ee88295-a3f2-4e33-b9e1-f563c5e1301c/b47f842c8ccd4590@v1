# Per-Project Supabase Stack Template
# Each project gets its own complete Supabase instance:
# - Studio (UI)
# - PostgREST (API)
# - GoTrue (Auth)
# - Kong (API Gateway)
# - Realtime (optional, can be shared)

# Ports are dynamically assigned to avoid conflicts
# Base ports: Studio={base}, PostgREST={base+1}, GoTrue={base+1000}, Kong={base+5000}

version: '3.8'

networks:
  nextmavens-network:
    external: true
    name: nextmavens-network

services:
  # Supabase Studio for this project
  studio-{PROJECT_SLUG}:
    image: supabase/studio:latest
    container_name: {PROJECT_SLUG}-studio
    environment:
      STUDIO_PG_META_URL: http://meta:8080
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DEFAULT_ORGANIZATION_NAME: NextMavens
      DEFAULT_PROJECT_NAME: {PROJECT_NAME}
      # Project-specific database connection
      PG_DATABASE: {DB_NAME}
      PG_CONNECTION_STRING: postgres://postgres:{POSTGRES_PASSWORD}@db:5432/{DB_NAME}
      # Public URL configuration
      NEXT_PUBLIC_STUDIO_URL: https://nextmavens.cloud/studio/{PROJECT_SLUG}
      STUDIO_BASE_PATH: /studio/{PROJECT_SLUG}
      # JWT secret for this project
      JWT_SECRET: {JWT_SECRET}
      # API URLs for this project's services
      POSTGREST_URL: http://localhost:{POSTGREST_PORT}
      GOTRUE_URL: http://localhost:{GOTRUE_PORT}
    ports:
      - "{STUDIO_PORT}:3000"
    networks:
      - nextmavens-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    depends_on:
      db:
        condition: service_healthy
      meta:
        condition: service_healthy

  # PostgREST for this project
  postgrest-{PROJECT_SLUG}:
    image: postgrest/postgrest:v12.2.0
    container_name: {PROJECT_SLUG}-postgrest
    environment:
      PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/{DB_NAME}
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: {JWT_SECRET}
      PGRST_SERVER_TRACE_ENABLED: false
    ports:
      - "{POSTGREST_PORT}:3000"
    networks:
      - nextmavens-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      db:
        condition: service_healthy

  # GoTrue Auth for this project
  gotrue-{PROJECT_SLUG}:
    image: supabase/gotrue:v2.158.4
    container_name: {PROJECT_SLUG}-gotrue
    environment:
      GOTRUE_API_HOSTNAME: localhost
      GOTRUE_API_PORT: {GOTRUE_PORT}
      GOTRUE_EXTERNAL_GOtrue_URL: https://nextmavens.cloud
      GOTRUE_EXTERNAL_GOtrue_REDIRECT_TRUSTED: 0
      GOTRUE_SITE_URL: https://nextmavens.cloud
      # Database connection
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://postgres:postgres_supabase_auth@db:5432/{DB_NAME}
      GOTRUE_DB_ENC_KEY_KEY: {JWT_SECRET}
      GOTRUE_DB_ENC_KEY_PARENT_KEY: {JWT_SECRET}
      # JWT configuration
      JWT_SECRET: {JWT_SECRET}
      JWT_EXP: 3600000000
      # Anon keys
      ANON_KEY: {ANON_KEY}
      SERVICE_ROLE_KEY: {SERVICE_ROLE_KEY}
      # Project reference
      GOTRUE_PROJECT_REF: {PROJECT_SLUG}
      GOTRUE_PROJECT_NAME: {PROJECT_NAME}
      # External hostnames
      GOTRUE_EXTERNAL_GOtrue_HOSTS: nextmavens.cloud,www.nextmavens.cloud,localhost
      GOTRUE_MAILER_EXTERNAL_GOtrue_HOSTS: nextmavens.cloud,www.nextmavens.cloud
    ports:
      - "{GOTRUE_PORT}:9999"
    networks:
      - nextmavens-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    depends_on:
      db:
        condition: service_healthy

  # Kong API Gateway for this project
  kong-{PROJECT_SLUG}:
    image: kong:3.7.1
    container_name: {PROJECT_SLUG}-kong
    environment:
      KONG_DATABASE: "off"
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_LOG_LEVEL: info
      KONG_PLUGINS: bundled,cors
      KONG_DECLARATIVE_CONFIG: /kong/declarative/{PROJECT_SLUG}.yml
    ports:
      - "{KONG_PORT}:8000"
      - "{KONG_ADMIN_PORT}:8001"
    volumes:
      - ./kong-{PROJECT_SLUG}.yml:/kong/declarative/{PROJECT_SLUG}.yml:ro
    networks:
      - nextmavens-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
