#!/bin/bash
# Update nginx configuration for project-specific Studio routing
# Adds dynamic routing for /studio/{slug} to correct port

NGINX_CONF="/etc/nginx/sites-available/nextmavens.conf"
STUDIO_CONF="/etc/nginx/sites-available/studio-projects.conf"

# Create Studio projects configuration
cat > "$STUDIO_CONF" <<'EOF'
# Project-Specific Studio Routing
# Dynamically generated - do not edit manually
# Each project's Studio runs on a unique port

# Studio project routing - must come before the general /studio location
location ~ ^/studio/([a-z0-9-]+)(.*)$ {
    # Extract project slug and path
    set $project_slug $1;
    set $remaining_path $2;

    # Default to Studio port 3000, will be overridden below
    set $studio_port 3000;

    # Project-specific port mappings
    # Add new projects here with: if ($project_slug = "slug") { set $studio_port 300X; }
    # Example: if ($project_slug = "nextmavens") { set $studio_port 3001; }

    # Proxy to the correct Studio container
    proxy_pass http://172.20.0.6:$studio_port$remaining_path;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
}
EOF

# Include this in main nginx config
if ! grep -q "include.*studio-projects.conf" "$NGINX_CONF"; then
  # Insert before the closing brace
  sed -i '/^}/ i # Include project-specific Studio configurations\ninclude /etc/nginx/sites-available/studio-projects.conf;\n' "$NGINX_CONF"
fi

echo "Studio nginx configuration created at $STUDIO_CONF"
echo "Run 'sudo nginx -t && sudo systemctl reload nginx' to apply"
