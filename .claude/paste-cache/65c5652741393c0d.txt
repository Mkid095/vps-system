Got it. So `flow-convert` needs to evolve from a **pure PRD → JSON converter** to a **PRD maintenance and repair tool** that ensures existing JSONs stay valid, complete, and compatible with the current Maven Flow version. Here’s the strategic breakdown:

---

### **Enhanced flow-convert Responsibilities**

1. **Conversion**

   * Original: PRD Markdown → JSON.
   * Now: Detect missing PRD JSONs and create them.

2. **Validation & Repair**

   * Scan existing PRDs in `docs/prd-[feature].json`.
   * Validate against the current PRD schema (`.claude/shared/prd-json-schema.md`).
   * Fix:

     * Missing fields (`mavenSteps`, `acceptanceCriteria`, `relatedPRDs`, etc.).
     * Invalid formats or syntax errors.
     * Outdated MCP references.

3. **Synchronization with Memory**

   * Reconcile `relatedPRDs` arrays with consolidated memory.
   * Ensure story completion flags (`passes`, `completed`) align with memory files.
   * Update lessons learned and agent metadata if missing.

4. **Atomic Safe Update**

   * Lock JSON using the filesystem lock system before editing (`find_and_lock_story()` + `unlock_story()`).
   * Backup existing JSON (`prd-[feature].json.bak`) before overwrite.
   * Write atomically to avoid corruption.

5. **Reporting**

   * Summarize:

     * Features repaired
     * Stories updated
     * Missing fields filled
     * Any manual review suggestions

6. **CLI Behavior**

   * `flow-convert [feature]`

     * Create JSON if missing
     * Validate existing JSON
     * Repair missing fields
   * Optional flags:

     * `--validate-only` → no writes, just report
     * `--force-repair` → overwrite with fixed JSON
     * `--verbose` → detailed field-level reporting

---

### **Workflow Example**

```bash
flow-convert payments --verbose
```

* Reads `docs/prd-payments.json`.
* Acquires lock for the PRD.
* Checks each story:

  * `mavenSteps` exist and match 1–11.
  * `passes` is boolean.
  * `relatedPRDs` match existing PRDs.
* Updates missing or invalid fields.
* Writes back to JSON atomically.
* Logs: 2 stories repaired, 1 new story added, 3 fields fixed.

---

### **Implementation Notes**

* Must reuse **existing helper functions**:

  * `validate_prd_json()`
  * `update_story_fields()`
  * `sync_with_memory()`
* Locking is **mandatory** to avoid concurrent edits.
* Backup first, then overwrite for safety.
* Maintain compatibility with **all flow scripts** (`flow start`, `flow test`, `flow consolidate`).

---

If you want, I can **draft the updated `bin/flow-convert.sh`** script with the new repair/validation logic, including lock-safe updates and schema auto-fixes. This would make it fully ready for production.

Do you want me to do that next?
