     1→// NextMavens Platform - Centralized Supabase Client
     2→// This module provides the main Supabase client configuration for the API layer
     3→
     4→import { createClient, SupabaseClient } from '@supabase/supabase-js';
     5→
     6→// ====================================================================
     7→// Environment Configuration
     8→// ====================================================================
     9→
    10→const getSupabaseConfig = () => {
    11→  const url = process.env.SUPABASE_URL;
    12→  const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
    13→  const anonKey = process.env.SUPABASE_ANON_KEY;
    14→
    15→  if (!url) {
    16→    throw new Error('SUPABASE_URL environment variable is required');
    17→  }
    18→
    19→  if (!serviceKey) {
    20→    throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
    21→  }
    22→
    23→  return { url, serviceKey, anonKey: anonKey || '' };
    24→};
    25→
    26→// ====================================================================
    27→// Client Creation
    28→// ====================================================================
    29→
    30→/**
    31→ * Create a Supabase admin client with service role privileges
    32→ * Use this for server-side operations that bypass RLS
    33→ */
    34→export function createAdminClient(): SupabaseClient {
    35→  const config = getSupabaseConfig();
    36→
    37→  return createClient(config.url, config.serviceKey, {
    38→    auth: {
    39→      autoRefreshToken: false,
    40→      persistSession: false,
    41→    },
    42→    db: {
    43→      schema: 'public',
    44→    },
    45→    global: {
    46→      headers: {
    47→        'x-service-role': 'true',
    48→      },
    49→    },
    50→  });
    51→}
    52→
    53→/**
    54→ * Create a Supabase client with anon key
    55→ * Use this for operations that should respect RLS
    56→ */
    57→export function createAnonClient(): SupabaseClient {
    58→  const config = getSupabaseConfig();
    59→
    60→  if (!config.anonKey) {
    61→    throw new Error('SUPABASE_ANON_KEY environment variable is required for anon client');
    62→  }
    63→
    64→  return createClient(config.url, config.anonKey, {
    65→    auth: {
    66→      autoRefreshToken: true,
    67→      persistSession: false,
    68→    },
    69→    db: {
    70→      schema: 'public',
    71→    },
    72→  });
    73→}
    74→
    75→/**
    76→ * Create a Supabase client for a specific project database
    77→ * This is used for tenant database operations
    78→ */
    79→export function createProjectClient(config: {
    80→  url: string;
    81→  anonKey: string;
    82→  schema?: string;
    83→}): SupabaseClient {
    84→  return createClient(config.url, config.anonKey, {
    85→    auth: {
    86→      autoRefreshToken: true,
    87→      persistSession: false,
    88→    },
    89→    db: {
    90→      schema: (config.schema || 'public') as 'public',
    91→    },
    92→  });
    93→}
    94→
    95→/**
    96→ * Create a Supabase client with a specific user's token
    97→ * Use this for operations on behalf of a user
    98→ */
    99→export function createUserClient(token: string): SupabaseClient {
   100→  const config = getSupabaseConfig();
   101→
   102→  return createClient(config.url, config.anonKey, {
   103→    auth: {
   104→      autoRefreshToken: false,
   105→      persistSession: false,
   106→    },
   107→    global: {
   108→      headers: {
   109→        Authorization: `Bearer ${token}`,
   110→      },
   111→    },
   112→  });
   113→}
   114→
   115→// ====================================================================
   116→// Singleton Instances
   117→// ====================================================================
   118→
   119→/**
   120→ * Shared admin client instance
   121→ * Reuse this for most server-side operations
   122→ */
   123→let adminClientInstance: SupabaseClient | null = null;
   124→
   125→export function getAdminClient(): SupabaseClient {
   126→  if (!adminClientInstance) {
   127→    adminClientInstance = createAdminClient();
   128→  }
   129→  return adminClientInstance;
   130→}
   131→
   132→/**
   133→ * Shared anon client instance
   134→ * Reuse this for client operations
   135→ */
   136→let anonClientInstance: SupabaseClient | null = null;
   137→
   138→export function getAnonClient(): SupabaseClient {
   139→  if (!anonClientInstance) {
   140→    anonClientInstance = createAnonClient();
   141→  }
   142→  return anonClientInstance;
   143→}
   144→
   145→// ====================================================================
   146→// Connection Pool Configuration
   147→// ====================================================================
   148→
   149→/**
   150→ * Connection pool configuration reference for Supavisor
   151→ *
   152→ * Supavisor is Supabase's connection pooler that provides:
   153→ * - Efficient connection management
   154→ * - Reduced database connection overhead
   155→ * - Better performance for serverless environments
   156→ *
   157→ * Configuration is done via environment variables in the Supabase instance:
   158→ * - DB_USE_POOLER=true
   159→ * - DB_POOLER_URL=postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-REF].supabase.co:6543/postgres
   160→ * - DB_POOLER_MODE=transaction
   161→ *
   162→ * For self-hosted Supabase, configure Supavisor in docker-compose.yml:
   163→ *
   164→ * supavisor:
   165→ *   image: supabase/supavisor:latest
   166→ *   environment:
   167→ *     - PORT=4000
   168→ *     - PGHOST=db
   169→ *     - PGPORT=5432
   170→ *     - PGDATABASE=postgres
   171→ *     - PGUSER=postgres
   172→ *     - PGPASSWORD=your-password
   173→ *   ports:
   174→ *     - "4000:4000"
   175→ *
   176→ * Connection string format:
   177→ * postgresql://postgres:[YOUR-PASSWORD]@localhost:4000/postgres
   178→ */
   179→export const CONNECTION_POOL_CONFIG = {
   180→  mode: 'transaction', // 'session' or 'transaction'
   181→  defaultPoolSize: 15, // Default for transaction mode
   182→  maxPoolSize: 50, // Maximum connections
   183→  minPoolSize: 2, // Minimum idle connections
   184→  acquireTimeoutMillis: 10000, // Connection acquisition timeout
   185→  idleTimeoutMillis: 30000, // Idle connection timeout
   186→  reapIntervalMillis: 1000, // Connection check interval
   187→} as const;
   188→
   189→// ====================================================================
   190→// Type Exports
   191→// ====================================================================
   192→
   193→export type { SupabaseClient } from '@supabase/supabase-js';
   194→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
