     1→// NextMavens Platform - Organizations Data Access Layer
     2→// Centralized data access patterns for organizations table
     3→
     4→import { getAdminClient } from '../supabase-client';
     5→import type {
     6→  Organization,
     7→  OrganizationMember,
     8→  CreateOrganizationInput,
     9→  UpdateOrganizationInput,
    10→  OrganizationRole,
    11→} from '../types';
    12→import { NotFoundError } from '../middleware';
    13→
    14→// ====================================================================
    15→// Organizations CRUD
    16→// ====================================================================
    17→
    18→/**
    19→ * Get all organizations for a user
    20→ */
    21→export async function getUserOrganizations(userId: string): Promise<
    22→  (Organization & { role: OrganizationRole })[]
    23→> {
    24→  const supabase = getAdminClient();
    25→
    26→  // Get user's memberships
    27→  const { data: memberships, error: memberError } = await supabase
    28→    .from('organization_members')
    29→    .select('organization_id, role')
    30→    .eq('user_id', userId);
    31→
    32→  if (memberError) {
    33→    throw new Error(`Failed to fetch memberships: ${memberError.message}`);
    34→  }
    35→
    36→  if (!memberships || memberships.length === 0) {
    37→    return [];
    38→  }
    39→
    40→  const orgIds = memberships.map((m) => m.organization_id);
    41→
    42→  // Get organizations
    43→  const { data: organizations, error: orgError } = await supabase
    44→    .from('organizations')
    45→    .select('*')
    46→    .in('id', orgIds)
    47→    .order('created_at', { ascending: false });
    48→
    49→  if (orgError) {
    50→    throw new Error(`Failed to fetch organizations: ${orgError.message}`);
    51→  }
    52→
    53→  // Merge role data
    54→  return (organizations || []).map((org) => ({
    55→    ...org,
    56→    role: memberships.find((m) => m.organization_id === org.id)?.role || 'member',
    57→  }));
    58→}
    59→
    60→/**
    61→ * Get a single organization by ID
    62→ * @throws {NotFoundError} if organization doesn't exist
    63→ */
    64→export async function getOrganizationById(
    65→  organizationId: string
    66→): Promise<Organization> {
    67→  const supabase = getAdminClient();
    68→
    69→  const { data, error } = await supabase
    70→    .from('organizations')
    71→    .select('*')
    72→    .eq('id', organizationId)
    73→    .single();
    74→
    75→  if (error || !data) {
    76→    throw new NotFoundError('Organization', organizationId);
    77→  }
    78→
    79→  return data;
    80→}
    81→
    82→/**
    83→ * Get a single organization by slug
    84→ * @throws {NotFoundError} if organization doesn't exist
    85→ */
    86→export async function getOrganizationBySlug(slug: string): Promise<Organization> {
    87→  const supabase = getAdminClient();
    88→
    89→  const { data, error } = await supabase
    90→    .from('organizations')
    91→    .select('*')
    92→    .eq('slug', slug)
    93→    .single();
    94→
    95→  if (error || !data) {
    96→    throw new NotFoundError('Organization', slug);
    97→  }
    98→
    99→  return data;
   100→}
   101→
   102→/**
   103→ * Check if a slug is available
   104→ */
   105→export async function isSlugAvailable(slug: string): Promise<boolean> {
   106→  const supabase = getAdminClient();
   107→
   108→  const { data, error } = await supabase
   109→    .from('organizations')
   110→    .select('id')
   111→    .eq('slug', slug)
   112→    .maybeSingle();
   113→
   114→  if (error) {
   115→    throw new Error(`Failed to check slug availability: ${error.message}`);
   116→  }
   117→
   118→  return !data;
   119→}
   120→
   121→/**
   122→ * Create a new organization
   123→ */
   124→export async function createOrganization(
   125→  input: CreateOrganizationInput,
   126→  creatorUserId: string
   127→): Promise<Organization & { role: OrganizationRole }> {
   128→  const supabase = getAdminClient();
   129→
   130→  // Check slug availability
   131→  const slug = input.slug || input.name.toLowerCase().replace(/[^a-z0-9-]+/g, '-').replace(/^-+|-+$/g, '');
   132→
   133→  const slugAvailable = await isSlugAvailable(slug);
   134→  if (!slugAvailable) {
   135→    throw new Error(`Slug "${slug}" is already taken`);
   136→  }
   137→
   138→  // Create organization
   139→  const { data: org, error: orgError } = await supabase
   140→    .from('organizations')
   141→    .insert({
   142→      name: input.name.trim(),
   143→      slug,
   144→      logo_url: input.logo_url,
   145→    })
   146→    .select()
   147→    .single();
   148→
   149→  if (orgError || !org) {
   150→    throw new Error(`Failed to create organization: ${orgError?.message || 'Unknown error'}`);
   151→  }
   152→
   153→  // Add creator as owner
   154→  const { error: memberError } = await supabase
   155→    .from('organization_members')
   156→    .insert({
   157→      organization_id: org.id,
   158→      user_id: creatorUserId,
   159→      role: 'owner',
   160→      invited_by: creatorUserId,
   161→    });
   162→
   163→  if (memberError) {
   164→    // Rollback organization creation
   165→    await supabase.from('organizations').delete().eq('id', org.id);
   166→    throw new Error(`Failed to add owner to organization: ${memberError.message}`);
   167→  }
   168→
   169→  return {
   170→    ...org,
   171→    role: 'owner',
   172→  };
   173→}
   174→
   175→/**
   176→ * Update an organization
   177→ * @throws {NotFoundError} if organization doesn't exist
   178→ */
   179→export async function updateOrganization(
   180→  organizationId: string,
   181→  updates: UpdateOrganizationInput
   182→): Promise<Organization> {
   183→  const supabase = getAdminClient();
   184→
   185→  const { data, error } = await supabase
   186→    .from('organizations')
   187→    .update({
   188→      name: updates.name?.trim(),
   189→      logo_url: updates.logo_url,
   190→    })
   191→    .eq('id', organizationId)
   192→    .select()
   193→    .single();
   194→
   195→  if (error || !data) {
   196→    throw new Error(`Failed to update organization: ${error?.message || 'Unknown error'}`);
   197→  }
   198→
   199→  return data;
   200→}
   201→
   202→/**
   203→ * Delete an organization
   204→ * This will cascade delete all projects, members, etc.
   205→ */
   206→export async function deleteOrganization(organizationId: string): Promise<void> {
   207→  const supabase = getAdminClient();
   208→
   209→  const { error } = await supabase
   210→    .from('organizations')
   211→    .delete()
   212→    .eq('id', organizationId);
   213→
   214→  if (error) {
   215→    throw new Error(`Failed to delete organization: ${error.message}`);
   216→  }
   217→}
   218→
   219→// ====================================================================
   220→// Organization Members
   221→// ====================================================================
   222→
   223→/**
   224→ * Get all members of an organization
   225→ */
   226→export async function getOrganizationMembers(
   227→  organizationId: string
   228→): Promise<OrganizationMember[]> {
   229→  const supabase = getAdminClient();
   230→
   231→  const { data, error } = await supabase
   232→    .from('organization_members')
   233→    .select('*')
   234→    .eq('organization_id', organizationId)
   235→    .order('created_at', { ascending: true });
   236→
   237→  if (error) {
   238→    throw new Error(`Failed to fetch organization members: ${error.message}`);
   239→  }
   240→
   241→  return data || [];
   242→}
   243→
   244→/**
   245→ * Get a user's role in an organization
   246→ */
   247→export async function getOrganizationRole(
   248→  organizationId: string,
   249→  userId: string
   250→): Promise<OrganizationRole | null> {
   251→  const supabase = getAdminClient();
   252→
   253→  const { data, error } = await supabase
   254→    .from('organization_members')
   255→    .select('role')
   256→    .eq('organization_id', organizationId)
   257→    .eq('user_id', userId)
   258→    .maybeSingle();
   259→
   260→  if (error) {
   261→    throw new Error(`Failed to fetch organization role: ${error.message}`);
   262→  }
   263→
   264→  return data?.role || null;
   265→}
   266→
   267→/**
   268→ * Add a member to an organization
   269→ */
   270→export async function addOrganizationMember(
   271→  organizationId: string,
   272→  userId: string,
   273→  role: OrganizationRole,
   274→  invitedBy: string
   275→): Promise<OrganizationMember> {
   276→  const supabase = getAdminClient();
   277→
   278→  const { data, error } = await supabase
   279→    .from('organization_members')
   280→    .insert({
   281→      organization_id: organizationId,
   282→      user_id: userId,
   283→      role,
   284→      invited_by: invitedBy,
   285→    })
   286→    .select()
   287→    .single();
   288→
   289→  if (error || !data) {
   290→    throw new Error(`Failed to add organization member: ${error?.message || 'Unknown error'}`);
   291→  }
   292→
   293→  return data;
   294→}
   295→
   296→/**
   297→ * Update a member's role in an organization
   298→ */
   299→export async function updateOrganizationMemberRole(
   300→  organizationId: string,
   301→  userId: string,
   302→  newRole: OrganizationRole
   303→): Promise<OrganizationMember> {
   304→  const supabase = getAdminClient();
   305→
   306→  const { data, error } = await supabase
   307→    .from('organization_members')
   308→    .update({ role: newRole })
   309→    .eq('organization_id', organizationId)
   310→    .eq('user_id', userId)
   311→    .select()
   312→    .single();
   313→
   314→  if (error || !data) {
   315→    throw new Error(`Failed to update member role: ${error?.message || 'Unknown error'}`);
   316→  }
   317→
   318→  return data;
   319→}
   320→
   321→/**
   322→ * Remove a member from an organization
   323→ */
   324→export async function removeOrganizationMember(
   325→  organizationId: string,
   326→  userId: string
   327→): Promise<void> {
   328→  const supabase = getAdminClient();
   329→
   330→  const { error } = await supabase
   331→    .from('organization_members')
   332→    .delete()
   333→    .eq('organization_id', organizationId)
   334→    .eq('user_id', userId);
   335→
   336→  if (error) {
   337→    throw new Error(`Failed to remove organization member: ${error.message}`);
   338→  }
   339→}
   340→
   341→/**
   342→ * Check if user is a member of an organization
   343→ */
   344→export async function isOrganizationMember(
   345→  organizationId: string,
   346→  userId: string
   347→): Promise<boolean> {
   348→  const role = await getOrganizationRole(organizationId, userId);
   349→  return role !== null;
   350→}
   351→
   352→/**
   353→ * Check if user has a specific role level in an organization
   354→ */
   355→export async function hasOrganizationRoleLevel(
   356→  organizationId: string,
   357→  userId: string,
   358→  minRole: OrganizationRole
   359→): Promise<boolean> {
   360→  const role = await getOrganizationRole(organizationId, userId);
   361→
   362→  if (!role) {
   363→    return false;
   364→  }
   365→
   366→  // Role hierarchy: owner > admin > member > viewer
   367→  const roleLevels: Record<OrganizationRole, number> = {
   368→    owner: 4,
   369→    admin: 3,
   370→    member: 2,
   371→    viewer: 1,
   372→  };
   373→
   374→  return roleLevels[role] >= roleLevels[minRole];
   375→}
   376→
   377→// ====================================================================
   378→// Pagination Helpers
   379→// ====================================================================
   380→
   381→export interface PaginationOptions {
   382→  page?: number;
   383→  perPage?: number;
   384→}
   385→
   386→export interface PaginatedResult<T> {
   387→  items: T[];
   388→  total: number;
   389→  page: number;
   390→  perPage: number;
   391→  totalPages: number;
   392→}
   393→
   394→/**
   395→ * Get paginated organizations for a user
   396→ */
   397→export async function getUserOrganizationsPaginated(
   398→  userId: string,
   399→  options: PaginationOptions = {}
   400→): Promise<PaginatedResult<Organization & { role: OrganizationRole }>> {
   401→  const page = options.page || 1;
   402→  const perPage = Math.min(options.perPage || 10, 100);
   403→
   404→  const supabase = getAdminClient();
   405→
   406→  // Get user's memberships
   407→  const { data: memberships, error: memberError, count } = await supabase
   408→    .from('organization_members')
   409→    .select('organization_id, role', { count: 'exact' })
   410→    .eq('user_id', userId)
   411→    .range((page - 1) * perPage, page * perPage - 1);
   412→
   413→  if (memberError) {
   414→    throw new Error(`Failed to fetch memberships: ${memberError.message}`);
   415→  }
   416→
   417→  if (!memberships || memberships.length === 0) {
   418→    return {
   419→      items: [],
   420→      total: 0,
   421→      page,
   422→      perPage,
   423→      totalPages: 0,
   424→    };
   425→  }
   426→
   427→  const orgIds = memberships.map((m) => m.organization_id);
   428→
   429→  // Get organizations
   430→  const { data: organizations, error: orgError } = await supabase
   431→    .from('organizations')
   432→    .select('*')
   433→    .in('id', orgIds);
   434→
   435→  if (orgError) {
   436→    throw new Error(`Failed to fetch organizations: ${orgError.message}`);
   437→  }
   438→
   439→  // Merge role data
   440→  const items = (organizations || []).map((org) => ({
   441→    ...org,
   442→    role: memberships.find((m) => m.organization_id === org.id)?.role || 'member',
   443→  }));
   444→
   445→  return {
   446→    items,
   447→    total: count || 0,
   448→    page,
   449→    perPage,
   450→    totalPages: Math.ceil((count || 0) / perPage),
   451→  };
   452→}
   453→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
