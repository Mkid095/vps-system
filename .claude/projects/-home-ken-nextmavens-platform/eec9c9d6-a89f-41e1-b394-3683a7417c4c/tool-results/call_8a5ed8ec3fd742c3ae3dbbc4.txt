     1→-- NextMavens Platform - Master Database Schema
     2→-- This schema manages organizations, projects, and their database credentials
     3→-- Run this on the master database to initialize the platform
     4→
     5→-- Enable required extensions
     6→CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
     7→CREATE EXTENSION IF NOT EXISTS "pgcrypto";
     8→CREATE EXTENSION IF NOT EXISTS "pg_trgm";
     9→
    10→-- Custom types
    11→CREATE TYPE organization_role AS ENUM ('owner', 'admin', 'member', 'viewer');
    12→CREATE TYPE project_status AS ENUM ('provisioning', 'active', 'suspended', 'archived');
    13→CREATE TYPE whatsapp_instance_status AS ENUM ('pending', 'connecting', 'connected', 'disconnected', 'error');
    14→
    15→-- ====================================================================
    16→-- Organizations
    17→-- ====================================================================
    18→CREATE TABLE organizations (
    19→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    20→    name TEXT NOT NULL,
    21→    slug TEXT NOT NULL UNIQUE,
    22→    logo_url TEXT,
    23→    created_at TIMESTAMPTZ DEFAULT NOW(),
    24→    updated_at TIMESTAMPTZ DEFAULT NOW()
    25→);
    26→
    27→CREATE INDEX idx_organizations_slug ON organizations(slug);
    28→
    29→-- ====================================================================
    30→-- Organization Members
    31→-- ====================================================================
    32→CREATE TABLE organization_members (
    33→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    34→    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    35→    user_id TEXT NOT NULL, -- Supabase Auth user ID
    36→    role organization_role NOT NULL DEFAULT 'member',
    37→    invited_by UUID,
    38→    created_at TIMESTAMPTZ DEFAULT NOW(),
    39→    updated_at TIMESTAMPTZ DEFAULT NOW(),
    40→    UNIQUE(organization_id, user_id)
    41→);
    42→
    43→CREATE INDEX idx_org_members_org_id ON organization_members(organization_id);
    44→CREATE INDEX idx_org_members_user_id ON organization_members(user_id);
    45→
    46→-- ====================================================================
    47→-- Projects
    48→-- ====================================================================
    49→CREATE TABLE projects (
    50→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    51→    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    52→    name TEXT NOT NULL,
    53→    slug TEXT NOT NULL,
    54→    description TEXT,
    55→    status project_status NOT NULL DEFAULT 'provisioning',
    56→    db_name TEXT UNIQUE, -- Database name in PostgreSQL
    57→    db_user TEXT, -- Database role name
    58→    anon_key TEXT UNIQUE,
    59→    service_role_key TEXT UNIQUE,
    60→    jwt_secret TEXT,
    61→    created_at TIMESTAMPTZ DEFAULT NOW(),
    62→    updated_at TIMESTAMPTZ DEFAULT NOW(),
    63→    CONSTRAINT projects_org_slug_unique UNIQUE (organization_id, slug)
    64→);
    65→
    66→CREATE INDEX idx_projects_org_id ON projects(organization_id);
    67→CREATE INDEX idx_projects_slug ON projects(slug);
    68→CREATE INDEX idx_projects_status ON projects(status);
    69→
    70→-- ====================================================================
    71→-- Project Databases (Credentials Storage)
    72→-- ====================================================================
    73→CREATE TABLE project_databases (
    74→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    75→    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    76→    db_name TEXT NOT NULL UNIQUE,
    77→    db_user TEXT NOT NULL,
    78→    db_password TEXT NOT NULL, -- Encrypted
    79→    db_host TEXT NOT NULL DEFAULT 'db',
    80→    db_port INTEGER NOT NULL DEFAULT 5432,
    81→    connection_pool TEXT DEFAULT 'supavisor',
    82→    created_at TIMESTAMPTZ DEFAULT NOW(),
    83→    updated_at TIMESTAMPTZ DEFAULT NOW()
    84→);
    85→
    86→CREATE INDEX idx_project_dbs_project_id ON project_databases(project_id);
    87→CREATE INDEX idx_project_dbs_db_name ON project_databases(db_name);
    88→
    89→-- ====================================================================
    90→-- Project Settings
    91→-- ====================================================================
    92→CREATE TABLE project_settings (
    93→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    94→    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    95→    key TEXT NOT NULL,
    96→    value JSONB NOT NULL,
    97→    description TEXT,
    98→    created_at TIMESTAMPTZ DEFAULT NOW(),
    99→    updated_at TIMESTAMPTZ DEFAULT NOW(),
   100→    UNIQUE(project_id, key)
   101→);
   102→
   103→CREATE INDEX idx_project_settings_project_id ON project_settings(project_id);
   104→
   105→-- ====================================================================
   106→-- WhatsApp Instances
   107→-- ====================================================================
   108→CREATE TABLE whatsapp_instances (
   109→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   110→    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
   111→    instance_name TEXT NOT NULL UNIQUE,
   112→    instance_id TEXT, -- Evolution API instance ID
   113→    status whatsapp_instance_status NOT NULL DEFAULT 'pending',
   114→    phone_number TEXT,
   115→    qr_code_base64 TEXT,
   116→    webhook_url TEXT,
   117→    webhook_secret TEXT,
   118→    settings JSONB DEFAULT '{}',
   119→    created_at TIMESTAMPTZ DEFAULT NOW(),
   120→    connected_at TIMESTAMPTZ,
   121→    last_activity_at TIMESTAMPTZ DEFAULT NOW(),
   122→    UNIQUE(project_id, instance_name)
   123→);
   124→
   125→CREATE INDEX idx_whatsapp_instances_project_id ON whatsapp_instances(project_id);
   126→CREATE INDEX idx_whatsapp_instances_status ON whatsapp_instances(status);
   127→CREATE INDEX idx_whatsapp_instances_instance_name ON whatsapp_instances(instance_name);
   128→
   129→-- ====================================================================
   130→-- WhatsApp Messages
   131→-- ====================================================================
   132→CREATE TABLE whatsapp_messages (
   133→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   134→    instance_id UUID NOT NULL REFERENCES whatsapp_instances(id) ON DELETE CASCADE,
   135→    message_id TEXT NOT NULL,
   136→    from_number TEXT NOT NULL,
   137→    to_number TEXT NOT NULL,
   138→    message_type TEXT NOT NULL, -- text, image, audio, video, document
   139→    content TEXT,
   140→    media_url TEXT,
   141→    direction TEXT NOT NULL, -- inbound, outbound
   142→    status TEXT DEFAULT 'sent',
   143→    metadata JSONB DEFAULT '{}',
   144→    created_at TIMESTAMPTZ DEFAULT NOW(),
   145→    UNIQUE(instance_id, message_id)
   146→);
   147→
   148→CREATE INDEX idx_whatsapp_messages_instance_id ON whatsapp_messages(instance_id);
   149→CREATE INDEX idx_whatsapp_messages_from_number ON whatsapp_messages(from_number);
   150→CREATE INDEX idx_whatsapp_messages_created_at ON whatsapp_messages(created_at DESC);
   151→
   152→-- ====================================================================
   153→-- API Keys
   154→-- ====================================================================
   155→CREATE TABLE api_keys (
   156→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   157→    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
   158→    name TEXT NOT NULL,
   159→    key_hash TEXT NOT NULL, -- SHA256 hash of the key
   160→    key_prefix TEXT NOT NULL, -- First 8 characters for identification
   161→    scopes TEXT[] NOT NULL DEFAULT ARRAY['read', 'write'],
   162→    is_active BOOLEAN NOT NULL DEFAULT true,
   163→    last_used_at TIMESTAMPTZ,
   164→    expires_at TIMESTAMPTZ,
   165→    created_by TEXT,
   166→    created_at TIMESTAMPTZ DEFAULT NOW()
   167→);
   168→
   169→CREATE INDEX idx_api_keys_project_id ON api_keys(project_id);
   170→CREATE INDEX idx_api_keys_key_hash ON api_keys(key_hash);
   171→CREATE INDEX idx_api_keys_active ON api_keys(is_active) WHERE is_active = true;
   172→
   173→-- ====================================================================
   174→-- Audit Logs
   175→-- ====================================================================
   176→CREATE TABLE audit_logs (
   177→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   178→    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
   179→    api_key_id UUID REFERENCES api_keys(id) ON DELETE SET NULL,
   180→    user_id TEXT,
   181→    action TEXT NOT NULL,
   182→    resource_type TEXT NOT NULL,
   183→    resource_id TEXT,
   184→    endpoint TEXT,
   185→    method TEXT,
   186→    status_code INTEGER,
   187→    metadata JSONB DEFAULT '{}',
   188→    ip_address TEXT,
   189→    user_agent TEXT,
   190→    created_at TIMESTAMPTZ DEFAULT NOW()
   191→);
   192→
   193→CREATE INDEX idx_audit_logs_project_id ON audit_logs(project_id);
   194→CREATE INDEX idx_audit_logs_api_key_id ON audit_logs(api_key_id);
   195→CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
   196→CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
   197→CREATE INDEX idx_audit_logs_action ON audit_logs(action);
   198→
   199→-- ====================================================================
   200→-- Storage Monitoring
   201→-- ====================================================================
   202→CREATE TABLE storage_metrics (
   203→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   204→    metric_type TEXT NOT NULL, -- disk_usage, docker_usage, etc.
   205→    value NUMERIC NOT NULL,
   206→    unit TEXT NOT NULL, -- GB, MB, percentage
   207→    threshold_alerted NUMERIC[] DEFAULT ARRAY[80, 90, 95],
   208→    metadata JSONB DEFAULT '{}',
   209→    created_at TIMESTAMPTZ DEFAULT NOW()
   210→);
   211→
   212→CREATE INDEX idx_storage_metrics_type ON storage_metrics(metric_type);
   213→CREATE INDEX idx_storage_metrics_created_at ON storage_metrics(created_at DESC);
   214→
   215→-- ====================================================================
   216→-- Functions
   217→-- ====================================================================
   218→
   219→-- Function to generate a safe database name from project ID
   220→CREATE OR REPLACE FUNCTION generate_db_name(project_id UUID)
   221→RETURNS TEXT AS $$
   222→BEGIN
   223→    RETURN 'project_' || REPLACE(project_id::TEXT, '-', '_');
   224→END;
   225→$$ LANGUAGE plpgsql IMMUTABLE;
   226→
   227→-- Function to generate a safe database role name
   228→CREATE OR REPLACE FUNCTION generate_db_role(project_id UUID)
   229→RETURNS TEXT AS $$
   230→BEGIN
   231→    RETURN 'app_' || REPLACE(project_id::TEXT, '-', '_');
   232→END;
   233→$$ LANGUAGE plpgsql IMMUTABLE;
   234→
   235→-- Function to generate API key
   236→CREATE OR REPLACE FUNCTION generate_api_key()
   237→RETURNS TEXT AS $$
   238→    SELECT encode(gen_random_bytes(32), 'base64');
   239→$$ LANGUAGE sql SECURITY DEFINER;
   240→
   241→-- Function to hash API key
   242→CREATE OR REPLACE FUNCTION hash_api_key(key TEXT)
   243→RETURNS TEXT AS $$
   244→    SELECT encode(digest(key, 'sha256'), 'hex');
   245→$$ LANGUAGE sql IMMUTABLE;
   246→
   247→-- Function to create project database (admin only)
   248→CREATE OR REPLACE FUNCTION create_project_database(project_id UUID)
   249→RETURNS JSONB AS $$
   250→DECLARE
   251→    v_db_name TEXT;
   252→    v_role_name TEXT;
   253→    v_password TEXT;
   254→    v_project projects;
   255→BEGIN
   256→    -- Get project details
   257→    SELECT * INTO v_project FROM projects WHERE id = project_id;
   258→    IF NOT FOUND THEN
   259→        RAISE EXCEPTION 'Project not found';
   260→    END IF;
   261→
   262→    -- Generate database name and role
   263→    v_db_name := generate_db_name(project_id);
   264→    v_role_name := generate_db_role(project_id);
   265→    v_password := encode(gen_random_bytes(24), 'base64');
   266→
   267→    -- Create database
   268→    EXECUTE format('CREATE DATABASE %I', v_db_name);
   269→
   270→    -- Connect to new database and create role
   271→    EXECUTE format('CREATE ROLE %I WITH LOGIN PASSWORD %L', v_role_name, v_password);
   272→
   273→    -- Grant privileges
   274→    EXECUTE format('GRANT ALL PRIVILEGES ON DATABASE %I TO %I', v_db_name, v_role_name);
   275→
   276→    -- Store credentials
   277→    INSERT INTO project_databases (project_id, db_name, db_user, db_password)
   278→    VALUES (project_id, v_db_name, v_role_name, v_password);
   279→
   280→    -- Update project
   281→    UPDATE projects
   282→    SET db_name = v_db_name,
   283→        db_user = v_role_name,
   284→        status = 'active'
   285→    WHERE id = project_id;
   286→
   287→    RETURN jsonb_build_object(
   288→        'db_name', v_db_name,
   289→        'db_user', v_role_name,
   290→        'connection_string', format('postgres://%I:%s@db:5432/%I', v_role_name, v_password, v_db_name)
   291→    );
   292→END;
   293→$$ LANGUAGE plpgsql SECURITY DEFINER;
   294→
   295→-- Trigger to update updated_at
   296→CREATE OR REPLACE FUNCTION update_updated_at()
   297→RETURNS TRIGGER AS $$
   298→BEGIN
   299→    NEW.updated_at = NOW();
   300→    RETURN NEW;
   301→END;
   302→$$ LANGUAGE plpgsql;
   303→
   304→-- Function to execute safe SQL queries for MCP server
   305→-- Only allows SELECT, INSERT, UPDATE operations with safety limits
   306→CREATE OR REPLACE FUNCTION execute_sql(sql_query TEXT)
   307→RETURNS TABLE(
   308→    rows JSONB,
   309→    columns TEXT[],
   310→    affected_rows BIGINT
   311→) AS $$
   312→DECLARE
   313→    normalized_sql TEXT;
   314→    v_rows JSONB := '[]'::jsonb;
   315→    v_columns TEXT[] := ARRAY[]::TEXT[];
   316→    v_affected BIGINT := 0;
   317→    v_result RECORD;
   318→    v_col_name TEXT;
   319→    v_row_data JSONB;
   320→    v_row_json JSONB;
   321→BEGIN
   322→    -- Normalize SQL for validation
   323→    normalized_sql := UPPER(TRIM(sql_query));
   324→
   325→    -- Validate SQL type - only allow SELECT, INSERT, UPDATE
   326→    IF normalized_sql NOT LIKE 'SELECT %' AND
   327→       normalized_sql NOT LIKE 'INSERT INTO %' AND
   328→       normalized_sql NOT LIKE 'UPDATE %' THEN
   329→        RAISE EXCEPTION 'Only SELECT, INSERT INTO, and UPDATE queries are allowed';
   330→    END IF;
   331→
   332→    -- Block dangerous operations
   333→    IF sql_query ~* '(DROP\s+TABLE|DROP\s+DATABASE|DELETE\s+FROM|TRUNCATE|ALTER\s+TABLE|CREATE\s+TABLE|CREATE\s+DATABASE|GRANT\s+|REVOKE\s+|EXEC\s+|EXECUTE\s+)' THEN
   334→        RAISE EXCEPTION 'Dangerous SQL operation detected';
   335→    END IF;
   336→
   337→    -- Additional safety for UPDATE: require WHERE clause
   338→    IF normalized_sql LIKE 'UPDATE %' AND sql_query !~* '\bWHERE\b' THEN
   339→        RAISE EXCEPTION 'UPDATE queries must include a WHERE clause';
   340→    END IF;
   341→
   342→    -- Execute based on query type
   343→    IF normalized_sql LIKE 'SELECT %' THEN
   344→        -- Execute SELECT and return results
   345→        -- Use dynamic SQL with FOR loop
   346→        FOR v_result IN EXECUTE sql_query LOOP
   347→            -- Build row JSON
   348→            v_row_json := '{}'::jsonb;
   349→
   350→            -- Get column names from the result
   351→            -- This is a simplified approach - for production, use pg_attribute
   352→            SELECT array_agg(a.attname)
   353→            INTO v_columns
   354→            FROM pg_attribute a
   355→            JOIN pg_class c ON c.oid = a.attrelid
   356→            JOIN pg_namespace n ON n.oid = c.relnamespace
   357→            WHERE c.relkind = 'r'
   358→            AND n.nspname = current_schema()
   359→            AND a.attnum > 0
   360→            AND NOT a.attisdropped
   361→            LIMIT 1;
   362→
   363→            -- Convert row to JSON
   364→            v_row_json := row_to_json(v_result)::jsonb;
   365→            v_rows := v_rows || v_row_json;
   366→        END LOOP;
   367→
   368→        v_affected := jsonb_array_length(v_rows);
   369→
   370→    ELSIF normalized_sql LIKE 'INSERT INTO %' OR normalized_sql LIKE 'UPDATE %' THEN
   371→        -- Execute INSERT/UPDATE
   372→        EXECUTE sql_query;
   373→        GET DIAGNOSTICS v_affected = ROW_COUNT;
   374→
   375→        -- Return empty result for mutations
   376→        v_rows := '[]'::jsonb;
   377→        v_columns := ARRAY[]::TEXT[];
   378→    END IF;
   379→
   380→    RETURN QUERY SELECT v_rows, v_columns, v_affected;
   381→END;
   382→$$ LANGUAGE plpgsql SECURITY DEFINER;
   383→
   384→-- Apply updated_at trigger
   385→CREATE TRIGGER organizations_updated_at BEFORE UPDATE ON organizations
   386→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   387→
   388→CREATE TRIGGER organization_members_updated_at BEFORE UPDATE ON organization_members
   389→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   390→
   391→CREATE TRIGGER projects_updated_at BEFORE UPDATE ON projects
   392→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   393→
   394→CREATE TRIGGER project_databases_updated_at BEFORE UPDATE ON project_databases
   395→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   396→
   397→CREATE TRIGGER project_settings_updated_at BEFORE UPDATE ON project_settings
   398→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   399→
   400→CREATE TRIGGER whatsapp_instances_updated_at BEFORE UPDATE ON whatsapp_instances
   401→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   402→
   403→CREATE TRIGGER api_keys_updated_at BEFORE UPDATE ON api_keys
   404→    FOR EACH ROW EXECUTE FUNCTION update_updated_at();
   405→
   406→-- ====================================================================
   407→-- Row Level Security (RLS)
   408→-- ====================================================================
   409→
   410→-- Enable RLS on sensitive tables
   411→ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
   412→ALTER TABLE organization_members ENABLE ROW LEVEL SECURITY;
   413→ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
   414→ALTER TABLE project_databases ENABLE ROW LEVEL SECURITY;
   415→ALTER TABLE project_settings ENABLE ROW LEVEL SECURITY;
   416→ALTER TABLE whatsapp_instances ENABLE ROW LEVEL SECURITY;
   417→ALTER TABLE whatsapp_messages ENABLE ROW LEVEL SECURITY;
   418→ALTER TABLE api_keys ENABLE ROW LEVEL SECURITY;
   419→ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;
   420→
   421→-- Organizations: accessible to members
   422→CREATE POLICY "Users can view organizations they are members of"
   423→    ON organizations FOR SELECT
   424→    USING (
   425→        EXISTS (
   426→            SELECT 1 FROM organization_members
   427→            WHERE organization_members.organization_id = organizations.id
   428→            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
   429→        )
   430→    );
   431→
   432→-- Projects: accessible to org members
   433→CREATE POLICY "Users can view projects in their organizations"
   434→    ON projects FOR SELECT
   435→    USING (
   436→        EXISTS (
   437→            SELECT 1 FROM organization_members
   438→            WHERE organization_members.organization_id = projects.organization_id
   439→            AND organization_members.user_id = (current_setting('request.jwt.claim.user_id', true))
   440→        )
   441→    );
   442→
   443→-- WhatsApp instances: accessible to project members
   444→CREATE POLICY "Users can view WhatsApp instances in their projects"
   445→    ON whatsapp_instances FOR SELECT
   446→    USING (
   447→        EXISTS (
   448→            SELECT 1 FROM projects p
   449→            JOIN organization_members om ON om.organization_id = p.organization_id
   450→            WHERE p.id = whatsapp_instances.project_id
   451→            AND om.user_id = (current_setting('request.jwt.claim.user_id', true))
   452→        )
   453→    );
   454→
   455→-- Messages: accessible to project members
   456→CREATE POLICY "Users can view messages in their projects"
   457→    ON whatsapp_messages FOR SELECT
   458→    USING (
   459→        EXISTS (
   460→            SELECT 1 FROM whatsapp_instances wi
   461→            JOIN projects p ON p.id = wi.project_id
   462→            JOIN organization_members om ON om.organization_id = p.organization_id
   463→            WHERE wi.id = whatsapp_messages.instance_id
   464→            AND om.user_id = (current_setting('request.jwt.claim.user_id', true))
   465→        )
   466→    );
   467→
   468→-- ====================================================================
   469→-- Initial Data
   470→-- ====================================================================
   471→
   472→-- Insert default project settings
   473→INSERT INTO project_settings (project_id, key, value, description) VALUES
   474→    (uuid_generate_v4(), 'storage.quota_gb', '10'::jsonb, 'Storage quota in GB'),
   475→    (uuid_generate_v4(), 'rate.limit_rpm', '60'::jsonb, 'Rate limit: requests per minute'),
   476→    (uuid_generate_v4(), 'whatsapp.auto_reconnect', 'true'::jsonb, 'Auto-reconnect WhatsApp on disconnect');
   477→
   478→-- Grant necessary permissions
   479→GRANT USAGE ON SCHEMA public TO postgres;
   480→GRANT ALL ON ALL TABLES IN SCHEMA public TO postgres;
   481→GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO postgres;
   482→GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO postgres;
   483→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
