     1→---
     2→name: flow-convert
     3→description: "Convert PRDs to prd.json format with memory loading and relationship analysis. Validates MCPs and tags related features. Triggers on: convert this prd, turn this into flow format, create prd.json from this, flow json."
     4→---
     5→
     6→# Flow PRD Converter with Memory Loading
     7→
     8→Converts existing PRDs (markdown) to the `prd.json` format that next-mavens-flow uses for autonomous execution.
     9→
    10→**NEW: Now loads existing context and analyzes feature relationships.**
    11→
    12→---
    13→
    14→## The Job
    15→
    16→Take a markdown PRD and convert it to `docs/prd-[feature-name].json`. Create `docs/` folder if it doesn't exist.
    17→
    18→**Important:** Each feature gets its own PRD JSON file. The flow command will scan for all `prd-*.json` files in `docs/` and process incomplete ones.
    19→
    20→**CRITICAL:** Each story MUST have its own `mcpTools` object specifying which MCPs to use for each Maven step.
    21→
    22→---
    23→
    24→## STEP 1: Read the Markdown PRD
    25→
    26→**Read the input PRD file:**
    27→
    28→Execute: `cat "$PRD_FILE"`
    29→
    30→**Extract key information:**
    31→- Project name
    32→- Branch name
    33→- Description
    34→- User stories
    35→- Related features (from flow-prd.md Step 2.6)
    36→- Context from existing features (if included)
    37→
    38→---
    39→
    40→## STEP 2: SCAN EXISTING JSON PRDs
    41→
    42→**CRITICAL: Before creating the JSON PRD, scan for existing PRDs to understand relationships.**
    43→
    44→Execute: `find docs -name "prd-*.json" -type f | sort`
    45→
    46→**For each existing PRD found:**
    47→
    48→1. **Read the PRD** to understand:
    49→   - What feature it implements
    50→   - Its status (check if all stories have `passes: true`)
    51→   - Its relatedPRDs array
    52→   - Its consolidatedMemory (if complete)
    53→
    54→2. **Build a feature map:**
    55→   ```
    56→   FEATURE_MAP = {
    57→     "prd-auth.json": {
    58→       name: "User Authentication",
    59→       status: "complete" | "incomplete",
    60→       related: ["prd-payments.json"],
    61→       consolidated: "..."
    62→     },
    63→     "prd-products.json": {
    64→       name: "Product Catalog",
    65→       status: "complete",
    66→       related: ["prd-orders.json"],
    67→       consolidated: "..."
    68→     }
    69→   }
    70→   ```
    71→
    72→---
    73→
    74→## STEP 3: LOAD CONSOLIDATED MEMORIES
    75→
    76→**From all complete PRDs, load consolidated memories:**
    77→
    78→Execute: For each complete PRD, read its `consolidatedMemory` field
    79→
    80→**Extract and categorize:**
    81→
    82→**Architecture Decisions:**
    83→```json
    84→{
    85→  "tech_stack": {
    86→    "framework": "Next.js 14",
    87→    "database": "Supabase (PostgreSQL)",
    88→    "state": "React Query + Zustand",
    89→    "auth": "Supabase Auth"
    90→  },
    91→  "structure": {
    92→    "pattern": "feature-based",
    93→    "directories": "src/features/, src/shared/"
    94→  },
    95→  "decisions": [
    96→    "Feature-based architecture for isolation",
    97→    "React Query for server state caching"
    98→  ]
    99→}
   100→```
   101→
   102→**Lessons Learned:**
   103→```json
   104→{
   105→  "lessons": [
   106→    "Always generate Supabase types first",
   107→    "Feature isolation prevents merge conflicts",
   108→    "Zero 'any' types policy catches bugs early"
   109→  ]
   110→}
   111→```
   112→
   113→**Integration Patterns:**
   114→```json
   115→{
   116→  "authentication": {
   117→    "provider": "Supabase Auth",
   118→    "roles": ["SUPER_ADMIN", "SHOP_OWNER", "SHOP_EMPLOYEE"],
   119→    "session": "server-side sessions"
   120→  },
   121→  "database": {
   122→    "client": "@supabase/supabase-js",
   123→    "migrations": "Supabase migrations",
   124→    "types": "supabase gen types typescript"
   125→  }
   126→}
   127→```
   128→
   129→---
   130→
   131→## STEP 4: ANALYZE FEATURE RELATIONSHIPS
   132→
   133→**CRITICAL: Analyze how this PRD relates to existing PRDs.**
   134→
   135→### 4.1: Extract Relationships from Markdown PRD
   136→
   137→**From the markdown PRD's "Related Features" section, extract:**
   138→
   139→**Depends On:**
   140→- Feature names that must exist first
   141→- Reasons for dependency
   142→- Integration points
   143→
   144→**Will Be Used By:**
   145→- Feature names that will depend on this
   146→- Reasons for the dependency
   147→- Future integration points
   148→
   149→### 4.2: Cross-Reference with Existing PRDs
   150→
   151→**For each related feature mentioned in the markdown PRD:**
   152→
   153→1. **Find the corresponding JSON PRD:**
   154→   - If markdown says "auth", find "prd-auth.json"
   155→   - If markdown says "products", find "prd-products.json"
   156→
   157→2. **Verify the PRD exists:**
   158→   ```bash
   159→   test -f "docs/prd-[feature].json" && echo "EXISTS" || echo "NOT_FOUND"
   160→   ```
   161→
   162→3. **Check the status:**
   163→   - Complete: All stories have `passes: true`
   164→   - Incomplete: Some stories have `passes: false`
   165→
   166→4. **Build the relatedPRDs array:**
   167→   ```json
   168→   {
   169→     "relatedPRDs": [
   170→       {
   171→         "prd": "prd-auth.json",
   172→         "type": "depends_on",
   173→         "status": "complete",
   174→         "reason": "Payments require authenticated users",
   175→         "integration": "user sessions, role-based access"
   176→       },
   177→       {
   178→         "prd": "prd-products.json",
   179→         "type": "depends_on",
   180→         "status": "complete",
   181→         "reason": "Payments process product purchases",
   182→         "integration": "product pricing, inventory validation"
   183→       },
   184→       {
   185→         "prd": "prd-orders.json",
   186→         "type": "depended_by",
   187→         "status": "incomplete",
   188→         "reason": "Orders will need payment processing",
   189→         "integration": "payment status, transaction history"
   190→       }
   191→     ]
   192→   }
   193→   ```
   194→
   195→### 4.3: Validate Relationship Types
   196→
   197→**Valid relationship types:**
   198→- `depends_on`: This PRD depends on the related PRD
   199→- `depended_by`: The related PRD depends on this one
   200→- `bidirectional`: Mutual dependency (be careful with these!)
   201→
   202→**Integration categories:**
   203→- `authentication`: User auth, roles, permissions
   204→- `data`: Data consumption, API calls, shared models
   205→- `components`: Shared UI components, utilities
   206→- `infrastructure`: Shared infrastructure, services
   207→
   208→### 4.4: Handle Edge Cases
   209→
   210→**If a related PRD doesn't exist:**
   211→- Add a warning in the JSON PRD's notes field
   212→- Example: `WARNING: Related PRD prd-xyz.json not found - may need to be created first`
   213→
   214→**If circular dependencies detected:**
   215→- Add a warning in the notes field
   216→- Example: "WARNING: Circular dependency detected with prd-abc.json - review execution order"
   217→
   218→---
   219→
   220→## STEP 5: VALIDATE MCP AVAILABILITY
   221→
   222→**CRITICAL: Before assigning MCPs to stories, validate they are available.**
   223→
   224→### 5.1: Scan for Available MCPs
   225→
   226→**How to discover available MCPs:**
   227→
   228→**Method 1: Check Claude Code settings**
   229→```bash
   230→cat ~/.claude/settings.json | jq '.mcpServers | keys'
   231→```
   232→
   233→**Method 2: Check project-level settings**
   234→```bash
   235→cat .claude/settings.json 2>/dev/null | jq '.mcpServers | keys' || echo "No project MCP settings"
   236→```
   237→
   238→**Method 3: Check environment variables**
   239→```bash
   240→env | grep -i mcp || echo "No MCP environment variables found"
   241→```
   242→
   243→**Method 4: Ask the user**
   244→If uncertain, ask: "What MCP servers do you have configured? (e.g., supabase, chrome-devtools, web-search-prime)"
   245→
   246→### 5.2: Document Available MCPs
   247→
   248→**Build the available MCPs list:**
   249→```json
   250→{
   251→  "availableMCPs": {
   252→    "supabase": {
   253→      "status": "available",
   254→      "tools": ["query", "mutate", "subscribe"]
   255→    },
   256→    "chrome-devtools": {
   257→      "status": "available",
   258→      "tools": ["navigate", "evaluate", "screenshot"]
   259→    },
   260→    "web-search-prime": {
   261→      "status": "not_available"
   262→    }
   263→  }
   264→}
   265→```
   266→
   267→### 5.3: Assign MCPs Based on Availability
   268→
   269→**For each story:**
   270→
   271→1. **Identify Maven steps** required
   272→2. **For each step**, check if MCPs are needed:
   273→   - Database operations → supabase
   274→   - Browser testing → chrome-devtools
   275→   - Documentation → web-search-prime
   276→3. **Verify MCP is available** before assigning
   277→4. **Only assign available MCPs** - leave `mcpTools` empty `{}` if unsure
   278→
   279→**Example:**
   280→```json
   281→{
   282→  "id": "US-001",
   283→  "title": "Create products table",
   284→  "mavenSteps": [1, 7],
   285→  "mcpTools": {
   286→    "step1": ["supabase"],    // Available - assigned
   287→    "step7": ["supabase"]     // Available - assigned
   288→  }
   289→}
   290→```
   291→
   292→**If MCP not available:**
   293→```json
   294→{
   295→  "id": "US-002",
   296→  "title": "Test checkout flow",
   297→  "mavenSteps": [5],
   298→  "mcpTools": {}  // chrome-devtools not available - left empty
   299→}
   300→```
   301→
   302→---
   303→
   304→## STEP 6: BUILD LESSONS LEARNED
   305→
   306→**Extract lessons learned from all consolidated memories:**
   307→
   308→**From TECH_STACK decisions:**
   309→- Which frameworks work well together
   310→- What database choices were made
   311→- What state management approach works
   312→
   313→**From LESSONS_LEARNED sections:**
   314→- Development process insights
   315→- Technical stack learnings
   316→- Architecture insights
   317→- Integration challenges and solutions
   318→
   319→**Build lessonsLearned string:**
   320→```json
   321→{
   322→  "lessonsLearned": "# Lessons Learned from Existing Features
   323→
   324→## Tech Stack
   325→- Framework: Next.js 14 provides excellent developer experience
   326→- Database: Supabase offers PostgreSQL + real-time + auth in one service
   327→- State: React Query eliminates most loading state boilerplate
   328→
   329→## Architecture
   330→- Feature-based architecture prevents merge conflicts
   331→- src/features/ for feature code, src/shared/ for reusable code
   332→- No cross-feature imports - use shared/ instead
   333→
   334→## Integration
   335→- Always generate types before implementing features
   336→- Zero 'any' types policy catches bugs early
   337→- Supabase real-time requires careful subscription management
   338→
   339→## Common Patterns
   340→- All API calls go through feature-specific api/ directories
   341→- Centralized error handling in @shared/api/errors
   342→- Components < 300 lines must be split"
   343→}
   344→```
   345→
   346→---
   347→
   348→## STEP 7: GENERATE JSON PRD
   349→
   350→**Create the JSON PRD file** at: `docs/prd-[feature-name].json`
   351→
   352→**Use this enhanced structure:**
   353→
   354→```json
   355→{
   356→  "project": "[Project Name]",
   357→  "branchName": "flow/[feature-name-kebab-case]",
   358→  "description": "[Feature description from PRD]",
   359→
   360→  "relatedPRDs": [
   361→    {
   362→      "prd": "prd-auth.json",
   363→      "type": "depends_on",
   364→      "status": "complete",
   365→      "reason": "Payments require authenticated users",
   366→      "integration": "user sessions, role-based access control"
   367→    }
   368→  ],
   369→
   370→  "consolidatedMemory": "",
   371→
   372→  "lessonsLearned": "# Lessons Learned\n\n[From STEP 6 above]",
   373→
   374→  "userStories": [
   375→    {
   376→      "id": "US-001",
   377→      "title": "[Story title]",
   378→      "description": "As a [user], I want [feature] so that [benefit]",
   379→      "acceptanceCriteria": [
   380→        "[Criterion 1]",
   381→        "[Criterion 2]",
   382→        "Typecheck passes"
   383→      ],
   384→      "mavenSteps": [1, 7],
   385→      "mcpTools": {
   386→        "step1": ["supabase"],
   387→        "step7": ["supabase"]
   388→      },
   389→      "priority": 1,
   390→      "passes": false,
   391→      "notes": ""
   392→    }
   393→  ]
   394→}
   395→```
   396→
   397→**Field descriptions:**
   398→
   399→| Field | Type | Required | Description |
   400→|-------|------|----------|-------------|
   401→| `project` | string | Yes | Project/feature name |
   402→| `branchName` | string | Yes | Git branch name (flow/ prefix) |
   403→| `description` | string | Yes | Brief description |
   404→| `relatedPRDs` | array | No | Related PRDs with metadata (NEW) |
   405→| `consolidatedMemory` | string | Yes | Empty initially, filled when PRD complete |
   406→| `lessonsLearned` | string | Yes | Lessons from existing features (NEW) |
   407→| `userStories` | array | Yes | Array of story objects |
   408→
   409→**Story object fields:**
   410→
   411→| Field | Type | Required | Description |
   412→|-------|------|----------|-------------|
   413→| `id` | string | Yes | US-XXX format |
   414→| `title` | string | Yes | Story title |
   415→| `description` | string | Yes | User story format |
   416→| `acceptanceCriteria` | array | Yes | Verifiable criteria |
   417→| `mavenSteps` | array | Yes | Maven steps required |
   418→| `mcpTools` | object | Yes | Step-based MCP assignments |
   419→| `priority` | number | Yes | Execution order (1 = first) |
   420→| `passes` | boolean | Yes | Set to true when complete |
   421→| `notes` | string | Yes | For warnings or notes |
   422→
   423→---
   424→
   425→## MCP Tool Assignment (Story-Level, Step-Based)
   426→
   427→**CRITICAL ARCHITECTURE DECISION:** MCPs are assigned PER STORY PER STEP, not at the PRD level.
   428→
   429→**SCAN FIRST - Discover Available MCPs:**
   430→
   431→**BEFORE assigning any MCPs to stories, you MUST:**
   432→
   433→1. **Check which MCP servers are available** in the current environment
   434→2. **Only assign MCPs that actually exist** - don't guess or assume
   435→3. **If unsure, leave mcpTools empty** `{}` rather than guessing wrong
   436→
   437→**How to Discover Available MCPs:**
   438→- Check the user's MCP configuration
   439→- Ask the user what MCPs they have configured
   440→- Look for common MCP patterns in the project (e.g., if using Supabase, check if supabase MCP is set up)
   441→
   442→**Why Scan First?**
   443→- Prevents assigning MCPs that don't exist
   444→- Avoids confusion when agents can't find the MCP
   445→- Ensures PRD matches actual environment capabilities
   446→
   447→**Why Story-Level MCP Assignment?**
   448→
   449→1. **Context Isolation:** Each story has its own specific MCPs, reducing confusion as context grows
   450→2. **Precision:** Flow command tells agents exactly which MCPs to use for each step
   451→3. **No Hallucination:** Prevents agents from "forgetting" which MCPs are available in large contexts
   452→4. **Granular Control:** Different stories and steps can use different MCPs
   453→
   454→**How to Assign MCPs to Stories:**
   455→
   456→When creating a PRD JSON, for each story:
   457→
   458→1. **Identify which Maven steps** the story requires (see Maven Steps Field section below)
   459→2. **For each step**, specify which MCPs to use (ONLY from discovered/available MCPs)
   460→3. **List MCPs in `mcpTools` object** with step-based keys (e.g., `step1`, `step7`)
   461→
   462→**Important:** You only specify the MCP **name**, not individual tools. The agent will automatically discover and use the available tools from that MCP.
   463→
   464→**Common MCPs (verify these are available before using):**
   465→
   466→| MCP Name | Use For Steps |
   467→|----------|--------------|
   468→| supabase | 7, 8, 10 (database operations) |
   469→| web-search-prime | All steps (research, documentation) |
   470→| web-reader | All steps (reading web content) |
   471→| chrome-devtools | Testing (browser automation) |
   472→| vercel | 9 (deployment) |
   473→| wrangler | 9 (deployment) |
   474→| figma | 11 (design) |
   475→
   476→**Example MCP Assignment:**
   477→```json
   478→{
   479→  "mavenSteps": [1, 7],
   480→  "mcpTools": {
   481→    "step1": ["supabase"],
   482→    "step7": ["supabase", "web-search-prime"]
   483→  }
   484→}
   485→```
   486→
   487→This tells the flow:
   488→- For Step 1: Use supabase MCP
   489→- For Step 7: Use supabase MCP and web-search-prime MCP
   490→
   491→---
   492→
   493→## Maven Steps Field
   494→
   495→**CRITICAL:** Each story MUST include a `mavenSteps` array that specifies which Maven workflow steps are required.
   496→
   497→**Maven Step to Agent Mapping:**
   498→
   499→| Maven Step | Agent | Description |
   500→|------------|-------|-------------|
   501→| 1 | development-agent | Foundation - Import UI with mock data or create from scratch |
   502→| 2 | development-agent | Package Manager - Convert npm → pnpm |
   503→| 3 | refactor-agent | Feature Structure - Restructure to feature-based folder structure |
   504→| 4 | refactor-agent | Modularization - Modularize components >300 lines |
   505→| 5 | quality-agent | Type Safety - No 'any' types, @ aliases |
   506→| 6 | refactor-agent | UI Centralization - Centralize UI components to @shared/ui |
   507→| 7 | development-agent | Data Layer - Centralized data layer with backend setup |
   508→| 8 | security-agent | Auth Integration - Firebase + Supabase authentication flow |
   509→| 9 | development-agent | MCP Integration - MCP integrations (web-search, web-reader, chrome, expo, supabase) |
   510→| 10 | security-agent | Security & Error Handling - Security and error handling |
   511→| 11 | design-agent | Mobile Design - Professional UI/UX for Expo/React Native (optional) |
   512→
   513→**Map Maven steps to story types:**
   514→
   515→| Story Type | Required Maven Steps |
   516→|------------|---------------------|
   517→| New feature UI from scratch | [1, 3, 5, 6, 10] |
   518→| Adding UI component to existing page | [3, 5, 6] |
   519→| Database schema changes | [1, 7] |
   520→| Backend API/Server actions | [1, 7, 10] |
   521→| Authentication flow | [1, 7, 8, 10] |
   522→| MCP integration | [9] |
   523→| Refactoring existing code | [4, 5] |
   524→| Full feature (schema + backend + UI) | [1, 3, 4, 5, 6, 7, 10] |
   525→
   526→**Example assignments:**
   527→```json
   528→// Database migration story
   529→{
   530→  "id": "US-001",
   531→  "title": "Add status column to tasks table",
   532→  "mavenSteps": [1, 7],  // Foundation + Data layer
   533→  "mcpTools": {
   534→    "step1": ["supabase"],
   535→    "step7": ["supabase"]
   536→  }
   537→}
   538→
   539→// UI component story
   540→{
   541→  "id": "US-002",
   542→  "title": "Add status badge to task cards",
   543→  "mavenSteps": [5, 6],  // Type safety + UI centralization
   544→  "mcpTools": {}
   545→}
   546→
   547→// Full feature story
   548→{
   549→  "id": "US-003",
   550→  "title": "Create user profile page",
   551→  "mavenSteps": [1, 3, 5, 6, 7, 10],  // Most steps
   552→  "mcpTools": {
   553→    "step1": ["supabase"],
   554→    "step7": ["supabase", "web-search-prime"],
   555→    "step10": ["web-search-prime"]
   556→  }
   557→}
   558→```
   559→
   560→---
   561→
   562→## Story Size: The Number One Rule
   563→
   564→**Each story must be completable in ONE flow iteration (one context window).**
   565→
   566→The flow spawns fresh each iteration with no memory of previous work. If a story is too big, the context fills before finishing and produces broken code.
   567→
   568→### Right-sized stories:
   569→- Add a database column and migration
   570→- Add a UI component to an existing page
   571→- Update a server action with new logic
   572→- Add a filter dropdown to a list
   573→
   574→### Too big (split these):
   575→- "Build the entire dashboard" → Split into: schema, queries, UI components, filters
   576→- "Add authentication" → Split into: schema, middleware, login UI, session handling
   577→- "Refactor the API" → Split into one story per endpoint or pattern
   578→
   579→**Rule of thumb:** If you cannot describe the change in 2-3 sentences, it's too big.
   580→
   581→---
   582→
   583→## Story Ordering: Dependencies First
   584→
   585→Stories execute in priority order. Earlier stories must not depend on later ones.
   586→
   587→**Correct order:**
   588→1. Schema/database changes (migrations)
   589→2. Server actions / backend logic
   590→3. UI components that use the backend
   591→4. Dashboard/summary views that aggregate data
   592→
   593→**Wrong order:**
   594→1. UI component (depends on schema that does not exist yet)
   595→2. Schema change
   596→
   597→**CONSIDER relatedPRDs when ordering:**
   598→- If this PRD depends on prd-auth.json, auth must be complete first
   599→- Add notes about dependency requirements
   600→- Consider priority in the broader project context
   601→
   602→---
   603→
   604→## Acceptance Criteria: Must Be Verifiable
   605→
   606→Each criterion must be something that can be CHECKED.
   607→
   608→### Good criteria (verifiable):
   609→- "Add `status` column to tasks table with default 'pending'"
   610→- "Filter dropdown has options: All, Active, Completed"
   611→- "Clicking delete shows confirmation dialog"
   612→- "Typecheck passes"
   613→
   614→### Bad criteria (vague):
   615→- "Works correctly"
   616→- "User can do X easily"
   617→- "Good UX"
   618→
   619→### Always include:
   620→```
   621→"Typecheck passes"
   622→```
   623→
   624→For testable stories:
   625→```
   626→"Tests pass"
   627→```
   628→
   629→### For UI stories:
   630→```
   631→"Verify in browser"
   632→```
   633→
   634→---
   635→
   636→## Conversion Rules
   637→
   638→1. **Each user story** becomes one JSON entry
   639→2. **IDs**: Sequential (US-001, US-002, etc.)
   640→3. **Priority**: Based on dependency order, then document order
   641→4. **All stories**: `passes: false` and empty `notes`
   642→5. **branchName**: Derive from feature name, kebab-case, prefixed with `flow/`
   643→6. **Always add**: "Typecheck passes" to every story's acceptance criteria
   644→7. **CRITICAL**: Add `mavenSteps` array to each story - see Maven Steps Field section above
   645→8. **CRITICAL**: Add `mcpTools` object to each story - only list MCP names, not individual tools
   646→9. **NEW**: Add `relatedPRDs` array with relationship metadata
   647→10. **NEW**: Add `lessonsLearned` field with context from existing features
   648→11. **NEW**: Add `consolidatedMemory` field (empty initially)
   649→
   650→---
   651→
   652→## Splitting Large PRDs
   653→
   654→If a PRD has big features, split them:
   655→
   656→**Original:**
   657→> "Add user notification system"
   658→
   659→**Split into:**
   660→1. US-001: Add notifications table to database
   661→2. US-002: Create notification service for sending notifications
   662→3. US-003: Add notification bell icon to header
   663→4. US-004: Create notification dropdown panel
   664→5. US-005: Add mark-as-read functionality
   665→6. US-006: Add notification preferences page
   666→
   667→Each is one focused change completable independently.
   668→
   669→---
   670→
   671→## Example
   672→
   673→### Input PRD (Markdown from flow-prd.md)
   674→
   675→```markdown
   676→---
   677→project: Payment Processing
   678→branchName: flow/payment-processing
   679→description: Payment processing feature for e-commerce
   680→availableMCPs:
   681→  - supabase
   682→  - chrome-devtools
   683→  - web-search-prime
   684→---
   685→
   686→# Payment Processing
   687→
   688→## Overview
   689→
   690→Payment processing system for e-commerce transactions with multiple payment methods.
   691→
   692→## Context from Existing Features
   693→
   694→### Architecture Alignment
   695→This feature follows established patterns from the codebase:
   696→
   697→**Tech Stack:**
   698→- Framework: Next.js 14 (App Router)
   699→- Database: Supabase (PostgreSQL)
   700→- State: React Query + Zustand
   701→- Auth: Supabase Auth
   702→
   703→**Project Structure:**
   704→- Feature-based architecture under src/features/
   705→- Shared code in src/shared/
   706→
   707→**Integration Patterns:**
   708→- API calls through feature-specific api/ directories
   709→- Centralized error handling in @shared/api/errors
   710→
   711→### Lessons Learned
   712→**Key Lessons to Apply:**
   713→- Always generate Supabase types before implementing features
   714→- Feature isolation prevents merge conflicts
   715→- React Query eliminates most loading state boilerplate
   716→
   717→## Related Features
   718→
   719→### Depends On (these features must exist first):
   720→- **auth**: User authentication and authorization (prd-auth.json)
   721→  - Why: Payments require authenticated users
   722→  - Integration: User sessions, role-based access control
   723→  - Status: Complete
   724→
   725→- **products**: Product catalog and inventory (prd-products.json)
   726→  - Why: Payments process product purchases
   727→  - Integration: Product pricing, inventory validation
   728→  - Status: Complete
   729→
   730→### Will Be Used By (these features depend on this):
   731→- **orders**: Order processing and management (prd-orders.json)
   732→  - Why: Orders need payment processing
   733→  - Integration: Payment status, transaction history
   734→  - Status: Incomplete
   735→
   736→### Integration Points:
   737→- Will use user sessions from auth feature
   738→- Will consume product data from products feature
   739→- Will provide payment status to orders feature
   740→
   741→## User Stories
   742→
   743→### US-001: Setup payment database schema
   744→
   745→**Priority:** 1
   746→**Maven Steps:** [1, 7]
   747→**MCP Tools:** `{ step1: ["supabase"], step7: ["supabase"] }`
   748→
   749→**Description:**
   750→As a developer, I need to create payment database tables.
   751→
   752→**Acceptance Criteria:**
   753→- Create payments table with id, amount, status, method
   754→- Create payment_methods table with id, type, is_active
   755→- Add foreign key to users table (from auth)
   756→- Generate and run migration successfully
   757→- Typecheck passes
   758→
   759→---
   760→
   761→### US-002: Integrate payment gateway API
   762→
   763→**Priority:** 2
   764→**Maven Steps:** [7, 9, 10]
   765→**MCP Tools:** `{ step7: ["supabase"], step9: ["web-search-prime"], step10: ["web-search-prime"] }`
   766→
   767→**Description:**
   768→As a developer, I need to integrate payment gateway for processing transactions.
   769→
   770→**Acceptance Criteria:**
   771→- Integrate Stripe SDK for payments
   772→- Create payment intent API endpoint
   773→- Create webhook handler for payment status
   774→- Add error handling for failed payments
   775→- Typecheck passes
   776→```
   777→
   778→### Output JSON PRD
   779→
   780→```json
   781→{
   782→  "project": "Payment Processing",
   783→  "branchName": "flow/payment-processing",
   784→  "description": "Payment processing feature for e-commerce with multiple payment methods",
   785→
   786→  "relatedPRDs": [
   787→    {
   788→      "prd": "prd-auth.json",
   789→      "type": "depends_on",
   790→      "status": "complete",
   791→      "reason": "Payments require authenticated users",
   792→      "integration": "user sessions, role-based access control"
   793→    },
   794→    {
   795→      "prd": "prd-products.json",
   796→      "type": "depends_on",
   797→      "status": "complete",
   798→      "reason": "Payments process product purchases",
   799→      "integration": "product pricing, inventory validation"
   800→    },
   801→    {
   802→      "prd": "prd-orders.json",
   803→      "type": "depended_by",
   804→      "status": "incomplete",
   805→      "reason": "Orders will need payment processing",
   806→      "integration": "payment status, transaction history"
   807→    }
   808→  ],
   809→
   810→  "consolidatedMemory": "",
   811→
   812→  "lessonsLearned": "# Lessons Learned from Existing Features\n\n## Tech Stack\n- Framework: Next.js 14 provides excellent developer experience\n- Database: Supabase offers PostgreSQL + real-time + auth in one service\n- State: React Query eliminates most loading state boilerplate\n\n## Architecture\n- Feature-based architecture prevents merge conflicts\n- src/features/ for feature code, src/shared/ for reusable code\n- No cross-feature imports - use shared/ instead\n\n## Integration\n- Always generate types before implementing features\n- Zero 'any' types policy catches bugs early\n- Supabase real-time requires careful subscription management\n\n## Common Patterns\n- All API calls go through feature-specific api/ directories\n- Centralized error handling in @shared/api/errors",
   813→
   814→  "userStories": [
   815→    {
   816→      "id": "US-001",
   817→      "title": "Setup payment database schema",
   818→      "description": "As a developer, I need to create payment database tables.",
   819→      "acceptanceCriteria": [
   820→        "Create payments table with id, amount, status, method",
   821→        "Create payment_methods table with id, type, is_active",
   822→        "Add foreign key to users table (from auth)",
   823→        "Generate and run migration successfully",
   824→        "Typecheck passes"
   825→      ],
   826→      "mavenSteps": [1, 7],
   827→      "mcpTools": {
   828→        "step1": ["supabase"],
   829→        "step7": ["supabase"]
   830→      },
   831→      "priority": 1,
   832→      "passes": false,
   833→      "notes": ""
   834→    },
   835→    {
   836→      "id": "US-002",
   837→      "title": "Integrate payment gateway API",
   838→      "description": "As a developer, I need to integrate payment gateway for processing transactions.",
   839→      "acceptanceCriteria": [
   840→        "Integrate Stripe SDK for payments",
   841→        "Create payment intent API endpoint",
   842→        "Create webhook handler for payment status",
   843→        "Add error handling for failed payments",
   844→        "Typecheck passes"
   845→      ],
   846→      "mavenSteps": [7, 9, 10],
   847→      "mcpTools": {
   848→        "step7": ["supabase"],
   849→        "step9": ["web-search-prime"],
   850→        "step10": ["web-search-prime"]
   851→      },
   852→      "priority": 2,
   853→      "passes": false,
   854→      "notes": ""
   855→    }
   856→  ]
   857→}
   858→```
   859→
   860→---
   861→
   862→## Archiving Previous Runs
   863→
   864→**Before writing a new PRD JSON file:**
   865→
   866→1. Ensure `docs/` folder exists (create if needed)
   867→2. Extract feature name from the PRD title (kebab-case)
   868→3. Output file will be: `docs/prd-[feature-name].json`
   869→4. If that exact file already exists:
   870→   - Archive the old version: `archive/YYYY-MM-DD-[feature-name]-prd.json`
   871→   - Create new version with current timestamp
   872→5. Create `docs/progress-[feature-name].txt` for tracking iteration progress
   873→
   874→**Note:** Each feature has its own PRD JSON file and progress file.
   875→
   876→---
   877→
   878→## Checklist Before Saving
   879→
   880→**FIRST - Before assigning MCPs:**
   881→- [ ] **Scanned for available MCP servers** in the environment
   882→- [ ] **Verified which MCPs actually exist** before assigning them
   883→- [ ] **Asked user if unsure** what MCPs are configured
   884→
   885→**THEN - PRD validation:**
   886→- [ ] **Previous run archived** (if docs/prd-[feature-name].json exists)
   887→- [ ] **Scanned existing PRDs** and loaded consolidated memories
   888→- [ ] **Analyzed feature relationships** and built relatedPRDs array
   889→- [ ] **Extracted lessons learned** from consolidated memories
   890→- [ ] Each story is completable in one iteration
   891→- [ ] Stories are ordered by dependency (schema to backend to UI)
   892→- [ ] Every story has "Typecheck passes" as criterion
   893→- [ ] UI stories have "Verify in browser" as criterion
   894→- [ ] **Every story has mavenSteps array** specifying required Maven steps
   895→- [ ] **Every story has mcpTools object** (even if empty `{}`)
   896→- [ ] **mcpTools uses step-based keys** (step1, step7, etc.)
   897→- [ ] **mcpTools only lists ACTUALLY AVAILABLE MCP names** (not guessed)
   898→- [ ] **mcpTools only lists MCP names** (e.g., "supabase"), not individual tools
   899→- [ ] **relatedPRDs array populated** with relationship metadata (not empty)
   900→- [ ] **lessonsLearned field populated** with context from existing features
   901→- [ ] Acceptance criteria are verifiable (not vague)
   902→- [ ] No story depends on a later story
   903→- [ ] Created `docs/` folder if it didn't exist
   904→- [ ] Extracted feature name from PRD title (kebab-case)
   905→- [ ] Saved to `docs/prd-[feature-name].json`
   906→- [ ] Created `docs/progress-[feature-name].txt`
   907→
   908→---
   909→
   910→## STEP 8: Display Summary
   911→
   912→```
   913→==============================================================================
   914→PRD Conversion Complete
   915→==============================================================================
   916→
   917→Input: docs/prd-[feature].md
   918→
   919→Output: docs/prd-[feature].json
   920→
   921→Memory Context Loaded:
   922→- Existing PRDs Scanned: [number]
   923→- Complete PRDs Found: [number]
   924→- Consolidated Memories Loaded: [number]
   925→- Story Memories Available: [number]
   926→
   927→Feature Relationships:
   928→- Depends On: [features that must exist first]
   929→- Will Be Used By: [features that depend on this]
   930→- Integration Points: [key integration details]
   931→
   932→MCP Validation:
   933→- Available MCPs: [list of available MCPs]
   934→- Assigned MCPs: [MCPs assigned to stories]
   935→
   936→Lessons Applied:
   937→- Architecture Patterns: [patterns followed]
   938→- Integration Patterns: [integration approaches]
   939→- Key Lessons: [lessons applied from existing features]
   940→
   941→Total Stories: [number]
   942→Next Steps:
   943→1. Review the JSON PRD: cat docs/prd-[feature].json
   944→2. Edit if needed: nano docs/prd-[feature].json
   945→3. Start development: flow start
   946→==============================================================================
   947→```
   948→
   949→---
   950→
   951→## EXECUTE NOW
   952→
   953→**DO NOT ASK QUESTIONS. DO NOT REQUEST INPUT. EXECUTE STEPS. CREATE FILE. EXIT.**
   954→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
