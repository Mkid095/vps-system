<tool_use_error>String to replace not found in file.
String:     dry_run_preview
    exit 0
fi

# ============================================================================
# Load plan.md context if available
# ============================================================================
PLAN_CONTEXT=""
if [ -f "plan.md" ]; then
    echo -e "${CYAN}Found plan.md - loading as project context${NC}"
    PLAN_MD_CONTENT=$(cat plan.md)
    PLAN_CONTEXT="

*** PROJECT PLAN CONTEXT ***
The user has a plan.md file with the overall project direction:
${PLAN_MD_CONTENT}
"
    echo -e "${GRAY}Loaded plan.md (${#PLAN_MD_CONTENT} bytes)${NC}"
    echo ""
fi

# ============================================================================
# Function to get first incomplete story
# ============================================================================
get_first_incomplete_story() {
    local prd_files=($(find docs -name "prd-*.json" -type f 2>/dev/null | sort))

    for prd in "${prd_files[@]}"; do
        local story=$(jq -r '.userStories[] | select(.passes == false) | "\(.id)|\(.title)|\(.description)"' "$prd" 2>/dev/null | head -1)
        if [ -n "$story" ]; then
            echo "$prd|$story"
            return 0
        fi
    done

    return 1
}

# ============================================================================
# Function to spawn specialist agent for a story step
# ============================================================================
spawn_agent_for_step() {
    local story_data="$1"
    local step="$2"
    local prd_file="$3"

    IFS='|' read -r story_id story_title story_description <<< "$story_data"

    # Get story details
    local mcp_tools=$(jq -r ".userStories[] | select(.id == \"$story_id\") | .mcpTools.step$step // empty" "$prd_file" 2>/dev/null)

    # Determine agent type based on step
    local agent_type=""
    local agent_name=""
    case $step in
        1|2|7|9)
            agent_type="development-agent"
            agent_name="Development"
            ;;
        3|4|6)
            agent_type="refactor-agent"
            agent_name="Refactor"
            ;;
        5)
            agent_type="quality-agent"
            agent_name="Quality"
            ;;
        8|10)
            agent_type="security-agent"
            agent_name="Security"
            ;;
        11)
            agent_type="design-agent"
            agent_name="Design"
            ;;
        *)
            agent_type="development-agent"
            agent_name="Development"
            ;;
    esac

    # Build MCP instruction
    local mcp_instruction=""
    if [ "$mcp_tools" != "null" ] && [ "$mcp_tools" != "empty" ]; then
        mcp_instruction="

*** CRITICAL: MCP TOOLS INSTRUCTION ***
You MUST use these MCP tools for this step:
$mcp_tools
Use these MCP tools to complete your work. DO NOT read files or make assumptions - CHECK FIRST using the MCP.
"
    fi

    # Generate agent prompt
    local agent_prompt="You are the Maven $agent_name Agent (Step $step of Maven Workflow).

STORY: $story_id - $story_title

DESCRIPTION:
$story_description

PRD FILE: $prd_file$PLAN_CONTEXT$mcp_instruction

## Your Task (Step $step)

Complete Step $step of the Maven workflow for this story:
- Read the PRD file to understand the full story context
- Review acceptance criteria
- Complete the step's work according to Maven Flow standards
- Ensure NO 'any' types, NO gradients, use @ aliases for imports

## Quality Standards (ZERO TOLERANCE):
- No 'any' types - use proper TypeScript
- No gradients - use solid professional colors
- No relative imports - use @/ aliases
- Components < 300 lines

## After Completion:
1. Run: pnpm run typecheck
2. If errors remain, fix them
3. Output: [STEP_COMPLETE] when done

Begin Step $step now."

    # Spawn the agent using Task tool
    echo -e "${CYAN}Spawning $agent_name agent for Step $step...${NC}"

    local result=$(claude --dangerously-skip-permissions "$agent_prompt" 2>&1)
    local exit_code=$?

    if echo "$result" | grep -q "\[STEP_COMPLETE\]"; then
        echo -e "${GREEN}âœ“ Step $step complete${NC}"
        return 0
    else
        echo -e "${YELLOW}âš  Step $step completed (no confirmation signal)${NC}"
        return 0
    fi
}

# ============================================================================
# Function to process a single story
# ============================================================================
process_story() {
    local prd_file="$1"
    local story_line="$2"

    IFS='|' read -r story_id story_title story_description <<< "$story_line"

    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  Processing Story: $story_id - $story_title${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Get maven steps for this story
    local maven_steps=($(jq -r ".userStories[] | select(.id == \"$story_id\") | .mavenSteps[]" "$prd_file" 2>/dev/null))

    if [ ${#maven_steps[@]} -eq 0 ]; then
        echo -e "${RED}Error: No mavenSteps found for story $story_id${NC}"
        return 1
    fi

    echo -e "${GRAY}Maven Steps: ${maven_steps[*]}${NC}"
    echo ""

    # Process each step in sequence
    for step in "${maven_steps[@]}"; do
        echo -e "${YELLOW}â”€â”€â”€ Step $step â”€â”€â”€${NC}"

        spawn_agent_for_step "$story_line" "$step" "$prd_file"

        # Small pause between steps
        sleep 1
        echo ""
    done

    # All steps complete - mark story as done
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  Story $story_id Complete!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # â­ MEMORY STEP 1: Create/Update Story Memory
    echo -e "${CYAN}Creating story memory...${NC}"
    if create_story_memory "$prd_file" "$story_id"; then
        echo -e "${GREEN}âœ“ Story memory created${NC}"
    else
        echo -e "${YELLOW}âš  Could not create story memory${NC}"
    fi
    echo ""

    # Update PRD to mark story as complete
    echo -e "${CYAN}Updating PRD...${NC}"
    node -e "
const fs = require('fs');
const prd = JSON.parse(fs.readFileSync('$prd_file', 'utf-8'));
const story = prd.userStories.find(s => s.id === '$story_id');
if (story) {
    story.passes = true;
    fs.writeFileSync('$prd_file', JSON.stringify(prd, null, 2));
    console.log('Marked $story_id as complete');
}
" 2>/dev/null || echo "Could not update PRD (requires Node.js)"

    # Run final quality check
    echo -e "${CYAN}Running final quality check...${NC}"
    pnpm run typecheck 2>&1 || echo -e "${YELLOW}âš  Typecheck had issues - please review${NC}"

    # Commit changes (NOW INCLUDES MEMORY FILE)
    echo -e "${CYAN}Committing changes...${NC}"
    git add -A
    local commit_title="feat: $story_id - $story_title"
    local commit_body="Co-Authored-By: Maven Flow <flow@maven.dev>"

    git commit -m "$commit_title" -m "$commit_body" 2>/dev/null || echo -e "${YELLOW}âš  Nothing new to commit${NC}"

    # Push to remote
    echo -e "${CYAN}Pushing to remote...${NC}"
    git push 2>&1 || echo -e "${YELLOW}âš  Push failed (may need manual push)${NC}"

    echo ""

    # â­ MEMORY STEP 2: Check if ALL stories in PRD are complete, then consolidate
    if check_prd_complete "$prd_file"; then
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${PURPLE}  All stories in PRD complete!${NC}"
        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        echo -e "${CYAN}Consolidating memory from all stories...${NC}"

        # Trigger Claude Code to consolidate memory intelligently
        echo -e "${CYAN}Triggering AI-powered memory consolidation...${NC}"
        echo -e "${YELLOW}This will spawn Claude Code to analyze and consolidate memories${NC}"

        # Call Claude Code with consolidate-memory command
        if claude --dangerously-skip-permissions "/consolidate-memory $prd_file" 2>&1; then
            echo -e "${GREEN}âœ“ Memory consolidation triggered successfully${NC}"
        else
            echo -e "${YELLOW}âš  Consolidation may have issues - please review${NC}"
        fi
        echo ""
    fi

    return 0
}

# ============================================================================
# Function to commit and push all changes
# ============================================================================
commit_and_push_changes() {
    echo ""
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}  Commit & Push Changes${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # Check if there are changes to commit
    if git diff --quiet && git diff --cached --quiet; then
        echo -e "${GRAY}No changes to commit${NC}"
        return 0
    fi

    # Stage all changes
    git add -A

    # Create commit message
    local current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    git commit -m "chore: flow session checkpoint - $current_time" 2>/dev/null || echo -e "${YELLOW}âš  Nothing new to commit${NC}"

    # Push to remote
    echo -e "${CYAN}Pushing to remote...${NC}"
    if git push 2>&1; then
        echo -e "${GREEN}âœ“ Pushed to remote${NC}"
    else
        echo -e "${YELLOW}âš  Push failed - please push manually${NC}"
    fi

    echo ""
}

# ============================================================================
# Memory Management Functions
# ============================================================================

# Function to create/update story memory after completion
create_story_memory() {
    local prd_file="$1"
    local story_id="$2"

    # Trigger Claude Code to create intelligent story memory
    echo "Triggering AI-powered story memory creation..."

    # Call Claude Code with create-story-memory command
    if claude --dangerously-skip-permissions "/create-story-memory $prd_file $story_id" 2>&1; then
        echo "âœ“ Story memory created"
        return 0
    else
        echo "âš  Story memory creation may have issues"
        return 1
    fi
}

# Function to check if all stories in a PRD are complete
check_prd_complete() {
    local prd_file="$1"

    # Check if all stories have passes: true
    local incomplete_count=$(jq '[.userStories[] | select(.passes != true)] | length' "$prd_file" 2>/dev/null)

    if [ "$incomplete_count" -eq 0 ]; then
        return 0  # All complete
    else
        return 1  # Some incomplete
    fi
}

# Main flow
write_header "Maven Flow - Starting"

# Check if plan.md exists for context
PLAN_CONTEXT=""
if [ -f "plan.md" ]; then
    echo -e "${CYAN}Found plan.md - using as additional context${NC}"
    PLAN_CONTEXT="
PLAN CONTEXT:
The user has a plan.md file with overall project direction. Use this as context when making decisions about feature interactions and prioritization.
"
fi

# Commit and push any existing changes first
commit_and_push_changes

# ============================================================================
# Main Execution Loop
# ============================================================================
STORIES_PROCESSED=0

for ((iteration=1; iteration<=MAX_ITERATIONS; iteration++)); do
    write_iteration_header "$iteration" "$MAX_ITERATIONS"

    # Get first incomplete story
    local story_result=$(get_first_incomplete_story)

    if [ $? -ne 0 ]; then
        # No more incomplete stories
        current_time=$(date +%s)
        duration=$((current_time - START_TIME))
        write_complete "$((iteration - 1))" "$duration"

        # Final commit and push
        commit_and_push_changes

        echo -e "${GREEN}${NC}"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${GREEN}  ðŸŽ‰ ALL STORIES COMPLETE! ðŸŽ‰${NC}"
        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        exit 0
    fi

    IFS='|' read -r prd_file story_id story_title story_description <<< "$story_result"
    local story_line="$story_id|$story_title|$story_description"

    # Process this story
    if process_story "$prd_file" "$story_line"; then
        STORIES_PROCESSED=$((STORIES_PROCESSED + 1))
    fi

    # Check if we should continue
    stats=$(get_story_stats)
    IFS='|' read -r total completed remaining progress <<< "$stats"

    if [ $total -gt 0 ] && [ $completed -eq $total ]; then
        # All stories complete
        current_time=$(date +%s)
        duration=$((current_time - START_TIME))
        write_complete "$iteration" "$duration"

        # Final commit and push
        commit_and_push_changes

        echo ""
        exit 0
    fi

    # Small pause between stories
    if [ $iteration -lt $MAX_ITERATIONS ]; then
        echo ""
        echo -e "${GRAY}Pausing ${SLEEP_SECONDS}s before next story...${NC}"
        sleep "$SLEEP_SECONDS"
        echo ""
    fi
done

# Max iterations reached
write_max_reached "$MAX_ITERATIONS"

# Final commit and push before exiting
commit_and_push_changes

exit 0</tool_use_error>