     1â†’#!/bin/bash
     2â†’# ============================================================================
     3â†’# Maven Flow - Linux Native Bash Implementation
     4â†’# ============================================================================
     5â†’
     6â†’set -e
     7â†’
     8â†’# Default parameters
     9â†’MAX_ITERATIONS=100
    10â†’SLEEP_SECONDS=2
    11â†’DRY_RUN=false
    12â†’
    13â†’# Parse arguments
    14â†’while [[ $# -gt 0 ]]; do
    15â†’    case $1 in
    16â†’        --dry-run)
    17â†’            DRY_RUN=true
    18â†’            shift
    19â†’            ;;
    20â†’        start)
    21â†’            shift
    22â†’            # Parse options after "start"
    23â†’            while [[ $# -gt 0 ]]; do
    24â†’                case $1 in
    25â†’                    --dry-run)
    26â†’                        DRY_RUN=true
    27â†’                        shift
    28â†’                        ;;
    29â†’                    [0-9]*)
    30â†’                        MAX_ITERATIONS=$1
    31â†’                        shift
    32â†’                        ;;
    33â†’                    *)
    34â†’                        shift
    35â†’                        ;;
    36â†’                esac
    37â†’            done
    38â†’            ;;
    39â†’        status)
    40â†’            # Show status only
    41â†’            exec bash "$SCRIPT_DIR/flow-status.sh" "$@"
    42â†’            ;;
    43â†’        continue)
    44â†’            # Continue from previous session
    45â†’            CONTINUE=true
    46â†’            shift
    47â†’            ;;
    48â†’        reset)
    49â†’            # Reset session with safety checks
    50â†’            echo ""
    51â†’            echo "=========================================="
    52â†’            echo "  Maven Flow - Session Reset"
    53â†’            echo "=========================================="
    54â†’            echo ""
    55â†’
    56â†’            # Check for uncommitted changes
    57â†’            if git status --porcelain | grep -q .; then
    58â†’                echo -e "${RED}[!] WARNING: Uncommitted changes detected${NC}"
    59â†’                echo ""
    60â†’                git status --short
    61â†’                echo ""
    62â†’            fi
    63â†’
    64â†’            # Check for incomplete stories
    65â†’            if [ -d "docs" ]; then
    66â†’                for prd in docs/prd-*.json; do
    67â†’                    if [ -f "$prd" ]; then
    68â†’                        local total=$(jq '.userStories | length' "$prd" 2>/dev/null || echo 0)
    69â†’                        local completed=$(jq '[.userStories[] | select(.passes == true)] | length' "$prd" 2>/dev/null || echo 0)
    70â†’                        local remaining=$((total - completed))
    71â†’
    72â†’                        if [ $remaining -gt 0 ]; then
    73â†’                            echo -e "${YELLOW}[!] $prd has $remaining incomplete story(s)${NC}"
    74â†’                            jq -r '.userStories[] | select(.passes == false) | "  - \(.id): \(.title)"' "$prd" 2>/dev/null || true
    75â†’                        fi
    76â†’                    fi
    77â†’                done
    78â†’                echo ""
    79â†’            fi
    80â†’
    81â†’            # Check if session file exists
    82â†’            if [ ! -f ".flow-session" ]; then
    83â†’                echo -e "${GRAY}[INFO] No active session found${NC}"
    84â†’                echo ""
    85â†’            else
    86â†’                local session_id=$(cat .flow-session 2>/dev/null || echo "unknown")
    87â†’                echo -e "${CYAN}[INFO] Active session: $session_id${NC}"
    88â†’                echo ""
    89â†’            fi
    90â†’
    91â†’            # Interactive confirmation
    92â†’            echo -e "${RED}This will:${NC}"
    93â†’            echo "  - Delete the .flow-session file"
    94â†’            echo "  - Clear all session progress"
    95â†’            echo "  - Allow starting fresh from the first incomplete story"
    96â†’            echo ""
    97â†’
    98â†’            # Only require confirmation if there's uncommitted work or active session
    99â†’            if git status --porcelain | grep -q . || [ -f ".flow-session" ]; then
   100â†’                echo -n -e "${YELLOW}Continue with reset? [y/N]: ${NC}"
   101â†’                read -r response
   102â†’                echo ""
   103â†’
   104â†’                if [[ ! "$response" =~ ^[Yy]$ ]]; then
   105â†’                    echo -e "${GRAY}[CANCELLED] Reset aborted${NC}"
   106â†’                    exit 0
   107â†’                fi
   108â†’            fi
   109â†’
   110â†’            # Perform reset
   111â†’            rm -f .flow-session
   112â†’            echo -e "${GREEN}[OK] Session reset${NC}"
   113â†’            echo ""
   114â†’            exit 0
   115â†’            ;;
   116â†’        help|--help|-h)
   117â†’            echo "Maven Flow - Autonomous Development Orchestrator"
   118â†’            echo ""
   119â†’            echo "Usage:"
   120â†’            echo "  flow start [--dry-run] [max-iterations]  - Start flow (default: 100 iterations)"
   121â†’            echo "  flow status                                  - Show current status"
   122â†’            echo "  flow continue                                - Continue from previous session"
   123â†’            echo "  flow reset                                   - Reset session state"
   124â†’            echo "  flow help                                    - Show this help"
   125â†’            echo ""
   126â†’            echo "Options:"
   127â†’            echo "  --dry-run    Show what would happen without making changes"
   128â†’            exit 0
   129â†’            ;;
   130â†’        --dry-run)
   131â†’            # Already handled above
   132â†’            shift
   133â†’            ;;
   134â†’        *)
   135â†’            # Try to parse as number (max iterations)
   136â†’            if [[ "$1" =~ ^[0-9]+$ ]]; then
   137â†’                MAX_ITERATIONS=$1
   138â†’            fi
   139â†’            shift
   140â†’            ;;
   141â†’    esac
   142â†’done
   143â†’
   144â†’# Colors
   145â†’CYAN='\033[0;36m'
   146â†’GREEN='\033[0;32m'
   147â†’YELLOW='\033[1;33m'
   148â†’BLUE='\033[0;34m'
   149â†’RED='\033[0;31m'
   150â†’GRAY='\033[0;90m'
   151â†’MAGENTA='\033[0;35m'
   152â†’WHITE='\033[0;37m'
   153â†’NC='\033[0m'
   154â†’
   155â†’# Get script directory
   156â†’SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
   157â†’
   158â†’# Session setup
   159â†’PROJECT_NAME="$(basename "$(pwd)")"
   160â†’SESSION_ID="${PROJECT_NAME}-$(head /dev/urandom | tr -dc a-z0-9 | head -c 8)"
   161â†’SESSION_FILE=".flow-session"
   162â†’START_TIME=$(date +%s)
   163â†’
   164â†’# Save session ID to file
   165â†’echo "$SESSION_ID" > "$SESSION_FILE"
   166â†’
   167â†’# Check if claude CLI is available
   168â†’if ! command -v claude &> /dev/null; then
   169â†’    echo -e "${RED}[ERROR] Claude CLI not found in PATH${NC}"
   170â†’    echo -e "${YELLOW}[INFO] Install with: npm install -g @anthropic-ai/claude-code${NC}"
   171â†’    exit 1
   172â†’fi
   173â†’
   174â†’# Check if jq is available
   175â†’if ! command -v jq &> /dev/null; then
   176â†’    echo -e "${RED}[ERROR] jq not found in PATH${NC}"
   177â†’    echo -e "${YELLOW}[INFO] Install with: sudo apt-get install jq${NC}"
   178â†’    exit 1
   179â†’fi
   180â†’
   181â†’# Function to get story stats
   182â†’get_story_stats() {
   183â†’    local total=0
   184â†’    local completed=0
   185â†’
   186â†’    if [ -d "docs" ]; then
   187â†’        for prd in docs/prd-*.json; do
   188â†’            if [ -f "$prd" ]; then
   189â†’                local count=$(jq '.userStories | length' "$prd" 2>/dev/null || echo 0)
   190â†’                total=$((total + count))
   191â†’
   192â†’                local complete=$(jq '[.userStories[] | select(.passes == true)] | length' "$prd" 2>/dev/null || echo 0)
   193â†’                completed=$((completed + complete))
   194â†’            fi
   195â†’        done
   196â†’    fi
   197â†’
   198â†’    local remaining=$((total - completed))
   199â†’    local progress=0
   200â†’    if [ $total -gt 0 ]; then
   201â†’        progress=$(( (completed * 100) / total ))
   202â†’    fi
   203â†’
   204â†’    echo "$total|$completed|$remaining|$progress"
   205â†’}
   206â†’
   207â†’# Function to format duration
   208â†’format_duration() {
   209â†’    local seconds=$1
   210â†’    local hours=$((seconds / 3600))
   211â†’    local minutes=$(((seconds % 3600) / 60))
   212â†’    local secs=$((seconds % 60))
   213â†’    printf "%02d:%02d:%02d" $hours $minutes $secs
   214â†’}
   215â†’
   216â†’# Function to write header
   217â†’write_header() {
   218â†’    local title="$1"
   219â†’    local stats=$(get_story_stats)
   220â†’    IFS='|' read -r total completed remaining progress <<< "$stats"
   221â†’
   222â†’    echo ""
   223â†’    echo -e "${BLUE}==========================================${NC}"
   224â†’    echo -e "${BLUE}  $title${NC}"
   225â†’    echo -e "${BLUE}==========================================${NC}"
   226â†’    echo -e "  Project: ${CYAN}${PROJECT_NAME}${NC}"
   227â†’    echo -e "  Session: ${MAGENTA}${SESSION_ID}${NC}"
   228â†’    echo -e "  Started: ${GRAY}$(date -d @$START_TIME '+%Y-%m-%d %H:%M:%S')${NC}"
   229â†’    echo -e "  Stories: ${GREEN}${completed}/${total}${NC} ${GRAY}(${remaining} left) - ${progress}% complete${NC}"
   230â†’    echo -e "  Max Iterations: ${GRAY}${MAX_ITERATIONS}${NC}"
   231â†’    echo -e "${BLUE}==========================================${NC}"
   232â†’    echo ""
   233â†’}
   234â†’
   235â†’# Function to write iteration header
   236â†’write_iteration_header() {
   237â†’    local current=$1
   238â†’    local total=$2
   239â†’    local stats=$(get_story_stats)
   240â†’    IFS='|' read -r prd_total prd_completed prd_remaining prd_progress <<< "$stats"
   241â†’
   242â†’    local iter_percent=$(( (current * 100) / total ))
   243â†’
   244â†’    echo ""
   245â†’    echo -e "${YELLOW}==========================================${NC}"
   246â†’    echo -e "${YELLOW}  Iteration $current of $total ($iter_percent%)${NC}"
   247â†’    echo -e "  Session: ${MAGENTA}${SESSION_ID}${NC}"
   248â†’    echo -e "  Stories: ${CYAN}${prd_completed}/${prd_total}${NC} ${GRAY}(${prd_remaining} left) - Project: ${prd_progress}%${NC}"
   249â†’    echo -e "${YELLOW}==========================================${NC}"
   250â†’    echo ""
   251â†’}
   252â†’
   253â†’# Function to write completion message
   254â†’write_complete() {
   255â†’    local iterations=$1
   256â†’    local duration=$2
   257â†’    local stats=$(get_story_stats)
   258â†’    IFS='|' read -r total completed remaining progress <<< "$stats"
   259â†’
   260â†’    echo ""
   261â†’    echo -e "${GREEN}==========================================${NC}"
   262â†’    echo -e "${GREEN}  [OK] ALL TASKS COMPLETE${NC}"
   263â†’    echo -e "  Session: ${MAGENTA}${SESSION_ID}${NC}"
   264â†’    echo -e "  Stories: ${WHITE}${total}/${total}${NC} - 100% complete"
   265â†’    echo -e "  Iterations: ${WHITE}${iterations}${NC}"
   266â†’    echo -e "  Duration: ${WHITE}$(format_duration $duration)${NC}"
   267â†’    echo -e "${GREEN}==========================================${NC}"
   268â†’    echo ""
   269â†’}
   270â†’
   271â†’# Function to write max reached message
   272â†’write_max_reached() {
   273â†’    local max=$1
   274â†’    local stats=$(get_story_stats)
   275â†’    IFS='|' read -r total completed remaining progress <<< "$stats"
   276â†’
   277â†’    echo ""
   278â†’    echo -e "${YELLOW}==========================================${NC}"
   279â†’    echo -e "${YELLOW}  [!] MAX ITERATIONS REACHED${NC}"
   280â†’    echo -e "  Session: ${MAGENTA}${SESSION_ID}${NC}"
   281â†’    echo -e "  Progress: ${CYAN}${progress}%${NC} ${GRAY}(${remaining} stories remaining)${NC}"
   282â†’    echo -e "${GRAY}  Run 'flow continue' to resume${NC}"
   283â†’    echo -e "${YELLOW}==========================================${NC}"
   284â†’    echo ""
   285â†’}
   286â†’
   287â†’# Cleanup function
   288â†’cleanup() {
   289â†’    rm -f "$SESSION_FILE"
   290â†’}
   291â†’
   292â†’trap cleanup EXIT
   293â†’
   294â†’# ============================================================================
   295â†’# Dry-Run Preview Function
   296â†’# ============================================================================
   297â†’dry_run_preview() {
   298â†’    echo ""
   299â†’    echo "=========================================="
   300â†’    echo "  Maven Flow - Dry Run Preview"
   301â†’    echo "=========================================="
   302â†’    echo ""
   303â†’    echo "This is a PREVIEW of what would happen."
   304â†’    echo "No changes will be made."
   305â†’    echo ""
   306â†’
   307â†’    # Check for PRD files
   308â†’    if [ ! -d "docs" ]; then
   309â†’        echo -e "${RED}[ERROR] No docs/ directory found${NC}"
   310â†’        echo "  Create a PRD first using the flow-prd skill."
   311â†’        exit 1
   312â†’    fi
   313â†’
   314â†’    local prd_files=($(find docs -name "prd-*.json" -type f 2>/dev/null))
   315â†’    if [ ${#prd_files[@]} -eq 0 ]; then
   316â†’        echo -e "${RED}[ERROR] No PRD files found in docs/${NC}"
   317â†’        echo "  Create a PRD first using the flow-prd skill."
   318â†’        exit 1
   319â†’    fi
   320â†’
   321â†’    echo -e "${CYAN}PRD Files Found:${NC}"
   322â†’    for prd in "${prd_files[@]}"; do
   323â†’        local feature=$(basename "$prd" | sed 's/^prd-//' | sed 's/\.json$//')
   324â†’        local total=$(jq '.userStories | length' "$prd" 2>/dev/null || echo 0)
   325â†’        local completed=$(jq '[.userStories[] | select(.passes == true)] | length' "$prd" 2>/dev/null || echo 0)
   326â†’        local remaining=$((total - completed))
   327â†’        echo "  - $feature"
   328â†’        echo "    File: $prd"
   329â†’        echo "    Stories: $completed/$total complete ($remaining remaining)"
   330â†’    done
   331â†’    echo ""
   332â†’
   333â†’    # Get first incomplete story across all PRDs
   334â†’    local first_prd=""
   335â†’    local first_story_id=""
   336â†’    local first_story_title=""
   337â†’    local first_maven_steps=()
   338â†’    local first_mcp_tools="{}"
   339â†’
   340â†’    for prd in "${prd_files[@]}"; do
   341â†’        local story=$(jq -r '.userStories[] | select(.passes == false) | "\(.id)|\(.title)"' "$prd" 2>/dev/null | head -1)
   342â†’        if [ -n "$story" ]; then
   343â†’            first_prd="$prd"
   344â†’            IFS='|' read -r first_story_id first_story_title <<< "$story"
   345â†’            first_maven_steps=($(jq -r ".userStories[] | select(.id == \"$first_story_id\") | .mavenSteps[]" "$prd" 2>/dev/null || echo ""))
   346â†’            first_mcp_tools=$(jq -r ".userStories[] | select(.id == \"$first_story_id\") | .mcpTools" "$prd" 2>/dev/null || echo "{}")
   347â†’            break
   348â†’        fi
   349â†’    done
   350â†’
   351â†’    if [ -z "$first_story_id" ]; then
   352â†’        echo -e "${GREEN}[OK] All stories are complete!${NC}"
   353â†’        echo ""
   354â†’        echo "No work to do. All stories in all PRDs are marked as complete."
   355â†’        exit 0
   356â†’    fi
   357â†’
   358â†’    echo -e "${CYAN}Next Story to Process:${NC}"
   359â†’    echo "  PRD: $first_prd"
   360â†’    echo "  Story ID: $first_story_id"
   361â†’    echo "  Title: $first_story_title"
   362â†’    echo "  Maven Steps: ${first_maven_steps[*]:-none}"
   363â†’    echo "  MCP Tools:"
   364â†’    echo "$first_mcp_tools" | jq -r 'to_entries | map("    \(.key): \(.value | join(", "))") | .[]' 2>/dev/null || echo "    (none)"
   365â†’    echo ""
   366â†’
   367â†’    # Determine agent for first step
   368â†’    local first_step="${first_maven_steps[0]}"
   369â†’    local agent=""
   370â†’    case $first_step in
   371â†’        1|2|7|9) agent="development-agent" ;;
   372â†’        3|4|6) agent="refactor-agent" ;;
   373â†’        5) agent="quality-agent" ;;
   374â†’        8|10) agent="security-agent" ;;
   375â†’        11) agent="design-agent" ;;
   376â†’        *) agent="development-agent" ;;
   377â†’    esac
   378â†’
   379â†’    echo -e "${CYAN}Execution Plan:${NC}"
   380â†’    echo "  Max Iterations: $MAX_ITERATIONS"
   381â†’    echo "  First Agent: $agent"
   382â†’    echo "  Estimated Steps per Story: ${#first_maven_steps[@]}"
   383â†’    echo "  Pause Between Iterations: ${SLEEP_SECONDS}s"
   384â†’    echo ""
   385â†’
   386â†’    # Show what files would be modified
   387â†’    echo -e "${CYAN}Files That Would Be Modified:${NC}"
   388â†’    echo "  - $first_prd (story marked as complete)"
   389â†’    echo "  - Source files in src/ (implementation)"
   390â†’    echo "  - Git history (commits)"
   391â†’    echo ""
   392â†’
   393â†’    echo "=========================================="
   394â†’    echo -e "${YELLOW}To execute, run: flow start${NC}"
   395â†’    echo "=========================================="
   396â†’    echo ""
   397â†’}
   398â†’
   399â†’# Check if dry-run mode
   400â†’if [ "$DRY_RUN" = true ]; then
   401â†’    dry_run_preview
   402â†’    exit 0
   403â†’fi
   404â†’
   405â†’# ============================================================================
   406â†’# Load plan.md context if available
   407â†’# ============================================================================
   408â†’PLAN_CONTEXT=""
   409â†’if [ -f "plan.md" ]; then
   410â†’    echo -e "${CYAN}Found plan.md - loading as project context${NC}"
   411â†’    PLAN_MD_CONTENT=$(cat plan.md)
   412â†’    PLAN_CONTEXT="
   413â†’
   414â†’*** PROJECT PLAN CONTEXT ***
   415â†’The user has a plan.md file with the overall project direction:
   416â†’${PLAN_MD_CONTENT}
   417â†’"
   418â†’    echo -e "${GRAY}Loaded plan.md (${#PLAN_MD_CONTENT} bytes)${NC}"
   419â†’    echo ""
   420â†’fi
   421â†’
   422â†’# ============================================================================
   423â†’# Function to get first incomplete story
   424â†’# ============================================================================
   425â†’get_first_incomplete_story() {
   426â†’    local prd_files=($(find docs -name "prd-*.json" -type f 2>/dev/null | sort))
   427â†’
   428â†’    for prd in "${prd_files[@]}"; do
   429â†’        local story=$(jq -r '.userStories[] | select(.passes == false) | "\(.id)|\(.title)|\(.description)"' "$prd" 2>/dev/null | head -1)
   430â†’        if [ -n "$story" ]; then
   431â†’            echo "$prd|$story"
   432â†’            return 0
   433â†’        fi
   434â†’    done
   435â†’
   436â†’    return 1
   437â†’}
   438â†’
   439â†’# ============================================================================
   440â†’# Function to spawn specialist agent for a story step
   441â†’# ============================================================================
   442â†’spawn_agent_for_step() {
   443â†’    local story_data="$1"
   444â†’    local step="$2"
   445â†’    local prd_file="$3"
   446â†’
   447â†’    IFS='|' read -r story_id story_title story_description <<< "$story_data"
   448â†’
   449â†’    # Get story details
   450â†’    local mcp_tools=$(jq -r ".userStories[] | select(.id == \"$story_id\") | .mcpTools.step$step // empty" "$prd_file" 2>/dev/null)
   451â†’
   452â†’    # Determine agent type based on step
   453â†’    local agent_type=""
   454â†’    local agent_name=""
   455â†’    case $step in
   456â†’        1|2|7|9)
   457â†’            agent_type="development-agent"
   458â†’            agent_name="Development"
   459â†’            ;;
   460â†’        3|4|6)
   461â†’            agent_type="refactor-agent"
   462â†’            agent_name="Refactor"
   463â†’            ;;
   464â†’        5)
   465â†’            agent_type="quality-agent"
   466â†’            agent_name="Quality"
   467â†’            ;;
   468â†’        8|10)
   469â†’            agent_type="security-agent"
   470â†’            agent_name="Security"
   471â†’            ;;
   472â†’        11)
   473â†’            agent_type="design-agent"
   474â†’            agent_name="Design"
   475â†’            ;;
   476â†’        *)
   477â†’            agent_type="development-agent"
   478â†’            agent_name="Development"
   479â†’            ;;
   480â†’    esac
   481â†’
   482â†’    # Build MCP instruction
   483â†’    local mcp_instruction=""
   484â†’    if [ "$mcp_tools" != "null" ] && [ "$mcp_tools" != "empty" ]; then
   485â†’        mcp_instruction="
   486â†’
   487â†’*** CRITICAL: MCP TOOLS INSTRUCTION ***
   488â†’You MUST use these MCP tools for this step:
   489â†’$mcp_tools
   490â†’Use these MCP tools to complete your work. DO NOT read files or make assumptions - CHECK FIRST using the MCP.
   491â†’"
   492â†’    fi
   493â†’
   494â†’    # Generate agent prompt
   495â†’    local agent_prompt="You are the Maven $agent_name Agent (Step $step of Maven Workflow).
   496â†’
   497â†’STORY: $story_id - $story_title
   498â†’
   499â†’DESCRIPTION:
   500â†’$story_description
   501â†’
   502â†’PRD FILE: $prd_file$PLAN_CONTEXT$mcp_instruction
   503â†’
   504â†’## Your Task (Step $step)
   505â†’
   506â†’Complete Step $step of the Maven workflow for this story:
   507â†’- Read the PRD file to understand the full story context
   508â†’- Review acceptance criteria
   509â†’- Complete the step's work according to Maven Flow standards
   510â†’- Ensure NO 'any' types, NO gradients, use @ aliases for imports
   511â†’
   512â†’## Quality Standards (ZERO TOLERANCE):
   513â†’- No 'any' types - use proper TypeScript
   514â†’- No gradients - use solid professional colors
   515â†’- No relative imports - use @/ aliases
   516â†’- Components < 300 lines
   517â†’
   518â†’## After Completion:
   519â†’1. Run: pnpm run typecheck
   520â†’2. If errors remain, fix them
   521â†’3. Output: [STEP_COMPLETE] when done
   522â†’
   523â†’Begin Step $step now."
   524â†’
   525â†’    # Spawn the agent using Task tool
   526â†’    echo -e "${CYAN}Spawning $agent_name agent for Step $step...${NC}"
   527â†’
   528â†’    local result=$(claude --dangerously-skip-permissions -p "$agent_prompt" 2>&1)
   529â†’    local exit_code=$?
   530â†’
   531â†’    if echo "$result" | grep -q "\[STEP_COMPLETE\]"; then
   532â†’        echo -e "${GREEN}âœ“ Step $step complete${NC}"
   533â†’        return 0
   534â†’    else
   535â†’        echo -e "${YELLOW}âš  Step $step completed (no confirmation signal)${NC}"
   536â†’        return 0
   537â†’    fi
   538â†’}
   539â†’
   540â†’# ============================================================================
   541â†’# Function to process a single story
   542â†’# ============================================================================
   543â†’process_story() {
   544â†’    local prd_file="$1"
   545â†’    local story_line="$2"
   546â†’
   547â†’    IFS='|' read -r story_id story_title story_description <<< "$story_line"
   548â†’
   549â†’    echo ""
   550â†’    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   551â†’    echo -e "${CYAN}  Processing Story: $story_id - $story_title${NC}"
   552â†’    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   553â†’    echo ""
   554â†’
   555â†’    # Get maven steps for this story
   556â†’    local maven_steps=($(jq -r ".userStories[] | select(.id == \"$story_id\") | .mavenSteps[]" "$prd_file" 2>/dev/null))
   557â†’
   558â†’    if [ ${#maven_steps[@]} -eq 0 ]; then
   559â†’        echo -e "${RED}Error: No mavenSteps found for story $story_id${NC}"
   560â†’        return 1
   561â†’    fi
   562â†’
   563â†’    echo -e "${GRAY}Maven Steps: ${maven_steps[*]}${NC}"
   564â†’    echo ""
   565â†’
   566â†’    # Process each step in sequence
   567â†’    for step in "${maven_steps[@]}"; do
   568â†’        echo -e "${YELLOW}â”€â”€â”€ Step $step â”€â”€â”€${NC}"
   569â†’
   570â†’        spawn_agent_for_step "$story_line" "$step" "$prd_file"
   571â†’
   572â†’        # Small pause between steps
   573â†’        sleep 1
   574â†’        echo ""
   575â†’    done
   576â†’
   577â†’    # All steps complete - mark story as done
   578â†’    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   579â†’    echo -e "${GREEN}  Story $story_id Complete!${NC}"
   580â†’    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   581â†’    echo ""
   582â†’
   583â†’    # â­ MEMORY STEP 1: Create/Update Story Memory
   584â†’    echo -e "${CYAN}Creating story memory...${NC}"
   585â†’    if create_story_memory "$prd_file" "$story_id"; then
   586â†’        echo -e "${GREEN}âœ“ Story memory created${NC}"
   587â†’    else
   588â†’        echo -e "${YELLOW}âš  Could not create story memory${NC}"
   589â†’    fi
   590â†’    echo ""
   591â†’
   592â†’    # Update PRD to mark story as complete
   593â†’    echo -e "${CYAN}Updating PRD...${NC}"
   594â†’    node -e "
   595â†’const fs = require('fs');
   596â†’const prd = JSON.parse(fs.readFileSync('$prd_file', 'utf-8'));
   597â†’const story = prd.userStories.find(s => s.id === '$story_id');
   598â†’if (story) {
   599â†’    story.passes = true;
   600â†’    fs.writeFileSync('$prd_file', JSON.stringify(prd, null, 2));
   601â†’    console.log('Marked $story_id as complete');
   602â†’}
   603â†’" 2>/dev/null || echo "Could not update PRD (requires Node.js)"
   604â†’
   605â†’    # Run final quality check
   606â†’    echo -e "${CYAN}Running final quality check...${NC}"
   607â†’    pnpm run typecheck 2>&1 || echo -e "${YELLOW}âš  Typecheck had issues - please review${NC}"
   608â†’
   609â†’    # Commit changes (NOW INCLUDES MEMORY FILE)
   610â†’    echo -e "${CYAN}Committing changes...${NC}"
   611â†’    git add -A
   612â†’    local commit_title="feat: $story_id - $story_title"
   613â†’    local commit_body="Co-Authored-By: Maven Flow <flow@maven.dev>"
   614â†’
   615â†’    git commit -m "$commit_title" -m "$commit_body" 2>/dev/null || echo -e "${YELLOW}âš  Nothing new to commit${NC}"
   616â†’
   617â†’    # Push to remote
   618â†’    echo -e "${CYAN}Pushing to remote...${NC}"
   619â†’    git push 2>&1 || echo -e "${YELLOW}âš  Push failed (may need manual push)${NC}"
   620â†’
   621â†’    echo ""
   622â†’
   623â†’    # â­ MEMORY STEP 2: Check if ALL stories in PRD are complete, then consolidate
   624â†’    if check_prd_complete "$prd_file"; then
   625â†’        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   626â†’        echo -e "${PURPLE}  All stories in PRD complete!${NC}"
   627â†’        echo -e "${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   628â†’        echo ""
   629â†’        echo -e "${CYAN}Consolidating memory from all stories...${NC}"
   630â†’
   631â†’        # Trigger Claude Code to consolidate memory intelligently
   632â†’        echo -e "${CYAN}Triggering AI-powered memory consolidation...${NC}"
   633â†’        echo -e "${YELLOW}This will spawn Claude Code to analyze and consolidate memories${NC}"
   634â†’
   635â†’        # Call Claude Code with consolidate-memory command
   636â†’        if claude --prompt "/consolidate-memory $prd_file" --dangerously-skip-permissions 2>&1; then
   637â†’            echo -e "${GREEN}âœ“ Memory consolidation triggered successfully${NC}"
   638â†’        else
   639â†’            echo -e "${YELLOW}âš  Consolidation may have issues - please review${NC}"
   640â†’        fi
   641â†’        echo ""
   642â†’    fi
   643â†’
   644â†’    return 0
   645â†’}
   646â†’
   647â†’# ============================================================================
   648â†’# Function to commit and push all changes
   649â†’# ============================================================================
   650â†’commit_and_push_changes() {
   651â†’    echo ""
   652â†’    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   653â†’    echo -e "${CYAN}  Commit & Push Changes${NC}"
   654â†’    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   655â†’    echo ""
   656â†’
   657â†’    # Check if there are changes to commit
   658â†’    if git diff --quiet && git diff --cached --quiet; then
   659â†’        echo -e "${GRAY}No changes to commit${NC}"
   660â†’        return 0
   661â†’    fi
   662â†’
   663â†’    # Stage all changes
   664â†’    git add -A
   665â†’
   666â†’    # Create commit message
   667â†’    local current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
   668â†’    git commit -m "chore: flow session checkpoint - $current_time" 2>/dev/null || echo -e "${YELLOW}âš  Nothing new to commit${NC}"
   669â†’
   670â†’    # Push to remote
   671â†’    echo -e "${CYAN}Pushing to remote...${NC}"
   672â†’    if git push 2>&1; then
   673â†’        echo -e "${GREEN}âœ“ Pushed to remote${NC}"
   674â†’    else
   675â†’        echo -e "${YELLOW}âš  Push failed - please push manually${NC}"
   676â†’    fi
   677â†’
   678â†’    echo ""
   679â†’}
   680â†’
   681â†’# ============================================================================
   682â†’# Memory Management Functions
   683â†’# ============================================================================
   684â†’
   685â†’# Function to create/update story memory after completion
   686â†’create_story_memory() {
   687â†’    local prd_file="$1"
   688â†’    local story_id="$2"
   689â†’
   690â†’    # Trigger Claude Code to create intelligent story memory
   691â†’    echo "Triggering AI-powered story memory creation..."
   692â†’
   693â†’    # Call Claude Code with create-story-memory command
   694â†’    if claude --prompt "/create-story-memory $prd_file $story_id" --dangerously-skip-permissions 2>&1; then
   695â†’        echo "âœ“ Story memory created"
   696â†’        return 0
   697â†’    else
   698â†’        echo "âš  Story memory creation may have issues"
   699â†’        return 1
   700â†’    fi
   701â†’}
   702â†’
   703â†’# Function to check if all stories in a PRD are complete
   704â†’check_prd_complete() {
   705â†’    local prd_file="$1"
   706â†’
   707â†’    # Check if all stories have passes: true
   708â†’    local incomplete_count=$(jq '[.userStories[] | select(.passes != true)] | length' "$prd_file" 2>/dev/null)
   709â†’
   710â†’    if [ "$incomplete_count" -eq 0 ]; then
   711â†’        return 0  # All complete
   712â†’    else
   713â†’        return 1  # Some incomplete
   714â†’    fi
   715â†’}
   716â†’
   717â†’# Main flow
   718â†’write_header "Maven Flow - Starting"
   719â†’
   720â†’# Check if plan.md exists for context
   721â†’PLAN_CONTEXT=""
   722â†’if [ -f "plan.md" ]; then
   723â†’    echo -e "${CYAN}Found plan.md - using as additional context${NC}"
   724â†’    PLAN_CONTEXT="
   725â†’PLAN CONTEXT:
   726â†’The user has a plan.md file with overall project direction. Use this as context when making decisions about feature interactions and prioritization.
   727â†’"
   728â†’fi
   729â†’
   730â†’# Commit and push any existing changes first
   731â†’commit_and_push_changes
   732â†’
   733â†’# ============================================================================
   734â†’# Main Execution Loop
   735â†’# ============================================================================
   736â†’STORIES_PROCESSED=0
   737â†’
   738â†’for ((iteration=1; iteration<=MAX_ITERATIONS; iteration++)); do
   739â†’    write_iteration_header "$iteration" "$MAX_ITERATIONS"
   740â†’
   741â†’    # Get first incomplete story
   742â†’    local story_result=$(get_first_incomplete_story)
   743â†’
   744â†’    if [ $? -ne 0 ]; then
   745â†’        # No more incomplete stories
   746â†’        current_time=$(date +%s)
   747â†’        duration=$((current_time - START_TIME))
   748â†’        write_complete "$((iteration - 1))" "$duration"
   749â†’
   750â†’        # Final commit and push
   751â†’        commit_and_push_changes
   752â†’
   753â†’        echo -e "${GREEN}${NC}"
   754â†’        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   755â†’        echo -e "${GREEN}  ðŸŽ‰ ALL STORIES COMPLETE! ðŸŽ‰${NC}"
   756â†’        echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
   757â†’        echo ""
   758â†’        exit 0
   759â†’    fi
   760â†’
   761â†’    IFS='|' read -r prd_file story_id story_title story_description <<< "$story_result"
   762â†’    local story_line="$story_id|$story_title|$story_description"
   763â†’
   764â†’    # Process this story
   765â†’    if process_story "$prd_file" "$story_line"; then
   766â†’        STORIES_PROCESSED=$((STORIES_PROCESSED + 1))
   767â†’    fi
   768â†’
   769â†’    # Check if we should continue
   770â†’    stats=$(get_story_stats)
   771â†’    IFS='|' read -r total completed remaining progress <<< "$stats"
   772â†’
   773â†’    if [ $total -gt 0 ] && [ $completed -eq $total ]; then
   774â†’        # All stories complete
   775â†’        current_time=$(date +%s)
   776â†’        duration=$((current_time - START_TIME))
   777â†’        write_complete "$iteration" "$duration"
   778â†’
   779â†’        # Final commit and push
   780â†’        commit_and_push_changes
   781â†’
   782â†’        echo ""
   783â†’        exit 0
   784â†’    fi
   785â†’
   786â†’    # Small pause between stories
   787â†’    if [ $iteration -lt $MAX_ITERATIONS ]; then
   788â†’        echo ""
   789â†’        echo -e "${GRAY}Pausing ${SLEEP_SECONDS}s before next story...${NC}"
   790â†’        sleep "$SLEEP_SECONDS"
   791â†’        echo ""
   792â†’    fi
   793â†’done
   794â†’
   795â†’# Max iterations reached
   796â†’write_max_reached "$MAX_ITERATIONS"
   797â†’
   798â†’# Final commit and push before exiting
   799â†’commit_and_push_changes
   800â†’
   801â†’exit 0
   802â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
