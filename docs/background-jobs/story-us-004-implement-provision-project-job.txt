---
memoryVersion: 1
storyId: US-004
storyTitle: Implement Provision Project Job
completedDate: 2026-01-29
---

STORY: US-004 - Implement Provision Project Job
===============================================

DESCRIPTION:
As a platform operator, I want project provisioning to run as a background job so that failures can be retried automatically.

MAVEN STEPS COMPLETED:
[1, 2, 7, 10]

IMPLEMENTATION SUMMARY:
Created a complete provision_project job handler that provisions tenant infrastructure including PostgreSQL database, schema, service registration (auth, realtime, storage), and API key generation. The handler includes comprehensive security fixes for SQL injection prevention, input validation, and service-to-service authentication. Added comprehensive integration tests (34 test cases, 1,071 lines) and security audit (9.5/10 score).

KEY FILES:
- api-gateway/src/lib/jobs/handlers/provision-project.handler.ts - Main handler (264 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/database.ts - Database/schema creation (137 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/services.ts - Service registration (203 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/api-keys.ts - API key generation (71 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/types.ts - Type definitions (249 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/config.ts - Configuration validation (117 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/__tests__/provision-project.integration.test.ts - Integration tests (1,071 lines)
- api-gateway/src/lib/jobs/handlers/provision-project/INTEGRATION_TEST_SUMMARY.md - Test documentation
- docs/background-jobs/security-audit-us-004.md - Security audit report (9.5/10)

DECISIONS MADE:
- Used PostgreSQL format() function for SQL injection prevention
- Created validateDatabaseName() to sanitize project IDs before database operations
- Implemented service-to-service authentication via Bearer tokens (backward compatible)
- Created ProvisioningError and ServiceRegistrationError for structured error handling
- Retry configuration: max 3 attempts, 5-minute intervals via enqueueProvisionProjectJob

INTEGRATION POINTS:
- Uses JobQueue from api-gateway/src/lib/jobs/queue.ts for job enqueuing
- Uses query() from @nextmavens/audit-logs-database for database operations
- Registers with auth service, realtime service, and storage service via HTTP APIs
- Generates API keys using crypto.randomUUID() and SHA256 hashing

LESSONS LEARNED:
- SQL injection vulnerability was present initially - fixed with format() and input validation
- TypeScript control flow analysis produces false positives for imports in try-catch blocks
- Service authentication should be required in production (tokens via env vars)
- URL encoding required for project IDs in HTTP endpoints
- Generic error messages prevent information leakage
- Security audit: 9.5/10 score - missing caller authorization (HIGH), API key workflow clarification needed
- All tests use mock handlers for external service dependencies
- Integration tests require PostgreSQL database connection
