# Backup Strategy Documentation

## Overview

This document explains the complete backup strategy for the platform, including what data is backed up, how backups are created, how to restore from backups, and the retention policy.

---

## Table of Contents

- [Backup Types](#backup-types)
  - [Database Backups](#database-backups)
  - [Storage Backups](#storage-backups)
  - [Logs Backups](#logs-backups)
- [Backup Architecture](#backup-architecture)
- [Creating Backups](#creating-backups)
- [Backup History](#backup-history)
- [Restoring from Backup](#restoring-from-backup)
- [Retention Policy](#retention-policy)
- [Security Considerations](#security-considerations)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

---

## Backup Types

The platform supports three types of backups, each serving different purposes:

### Database Backups

**What's backed up:** Complete PostgreSQL database dump for your project's tenant schema (`tenant_{slug}`).

**When to use:**
- Before major schema changes
- Before data migrations
- For disaster recovery
- For creating development/testing environments

**Format:** SQL dump generated by `pg_dump`

**Compression:** Gzip compressed by default

**Typical size:** Varies by database size (MBs to GBs)

### Storage Backups

**What's backed up:** Large files stored in Telegram (>2GB automatically handled by Telegram)

**When to use:**
- Automatic for files exceeding 2GB
- Long-term file archival
- Redundant storage for critical assets

**How it works:** Files >2GB are automatically split and stored via Telegram's built-in backup mechanism

**Typical size:** Large files (GBs)

### Logs Backups

**What's backed up:** Application and audit logs from `project_logs` table

**When to use:**
- Compliance requirements
- Security investigations
- Performance analysis
- Historical troubleshooting

**Format:** JSON or plain text

**Typical size:** Varies by logging volume

---

## Backup Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Backup System                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐         ┌──────────────────┐             │
│  │   Manual Export  │         │   Telegram Bot   │             │
│  │     (API)        │────────▶│   Integration    │             │
│  └────────┬─────────┘         └────────┬─────────┘             │
│           │                             │                        │
│           │                             ▼                        │
│           │                    ┌──────────────┐                │
│           │                    │  Telegram    │                │
│           │                    │  Storage     │                │
│           │                    └──────┬───────┘                │
│           │                           │                         │
│           ▼                           ▼                         │
│  ┌──────────────────────────────────────────────┐             │
│  │         Backup History Table                  │             │
│  │    (control_plane.backups)                    │             │
│  │                                                │             │
│  │  • id (UUID)                                   │             │
│  │  • project_id                                  │             │
│  │  • type (database|storage|logs)               │             │
│  │  • file_id (Telegram file reference)          │             │
│  │  • size (bytes)                                │             │
│  │  • created_at                                  │             │
│  │  • expires_at (+30 days)                      │             │
│  └──────────────────────────────────────────────┘             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Key Components:**

1. **Manual Export API** - RESTful endpoint for initiating backups
2. **Telegram Integration** - Secure, long-term backup storage
3. **Job Queue** - Async processing for large backups
4. **Backup History** - Complete audit trail of all backups
5. **Retention Policy** - Automatic cleanup after 30 days

---

## Creating Backups

### Database Backup via API

**Endpoint:** `POST /api/backup/export`

**Authentication:** JWT required

**Request Body:**

```json
{
  "project_id": "your-project-id",
  "format": "sql",
  "compress": true,
  "notify_email": "optional@email.com"
}
```

**Parameters:**

- `project_id` (string, required): Your project identifier
- `format` (string, optional): Backup format - `"sql"` or `"tar"` (default: `"sql"`)
- `compress` (boolean, optional): Compress backup (default: `true`)
- `notify_email` (string, optional): Email notification when backup completes
- `storage_path` (string, optional): Custom storage path

**Response:**

```json
{
  "data": {
    "job_id": "uuid-here",
    "status": "pending",
    "project_id": "your-project-id",
    "created_at": "2026-01-29T12:00:00Z"
  }
}
```

**Example using curl:**

```bash
curl -X POST https://api.example.com/api/backup/export \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "project_id": "my-project",
    "format": "sql",
    "compress": true
  }'
```

**Example using JavaScript:**

```javascript
const response = await fetch('https://api.example.com/api/backup/export', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${jwtToken}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    project_id: 'my-project',
    format: 'sql',
    compress: true,
    notify_email: 'admin@example.com'
  })
});

const { data } = await response.json();
console.log(`Backup job started: ${data.job_id}`);
```

### Logs Backup via API

**Endpoint:** `POST /api/backup/export-logs`

**Authentication:** JWT required

**Request Body:**

```json
{
  "project_id": "your-project-id",
  "format": "json",
  "date_range": {
    "start": "2026-01-01",
    "end": "2026-01-31"
  }
}
```

**Parameters:**

- `project_id` (string, required): Your project identifier
- `format` (string, optional): `"json"` or `"text"` (default: `"json"`)
- `date_range` (object, optional): Date range filter
  - `start` (string): Start date (ISO 8601)
  - `end` (string): End date (ISO 8601)

**Response:**

```json
{
  "data": {
    "job_id": "uuid-here",
    "status": "pending",
    "project_id": "your-project-id",
    "created_at": "2026-01-29T12:00:00Z"
  }
}
```

---

## Backup History

All backups are tracked in the `control_plane.backups` table, providing a complete audit trail.

### Viewing Backup History

**Query Backups for a Project:**

```sql
SELECT
  id,
  type,
  file_id,
  size,
  created_at,
  expires_at
FROM control_plane.backups
WHERE project_id = 'your-project-id'
ORDER BY created_at DESC;
```

**Filter by Backup Type:**

```sql
SELECT * FROM control_plane.backups
WHERE project_id = 'your-project-id'
  AND type = 'database'
ORDER BY created_at DESC;
```

**Get Backup Statistics:**

```sql
SELECT
  COUNT(*) as total_backups,
  SUM(size) as total_size,
  COUNT(*) FILTER (WHERE type = 'database') as database_count,
  COUNT(*) FILTER (WHERE type = 'storage') as storage_count,
  COUNT(*) FILTER (WHERE type = 'logs') as logs_count,
  MIN(created_at) as oldest_backup,
  MAX(created_at) as newest_backup
FROM control_plane.backups
WHERE project_id = 'your-project-id';
```

### Backup Schema

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Unique backup identifier |
| `project_id` | TEXT | Project that owns the backup |
| `type` | TEXT | Backup type: `database`, `storage`, or `logs` |
| `file_id` | TEXT | Telegram file ID or storage reference |
| `size` | BIGINT | Backup size in bytes |
| `created_at` | TIMESTAMPTZ | When backup was created |
| `expires_at` | TIMESTAMPTZ | When backup will be deleted (30 days) |

**Indexes:**

- `idx_backups_project_id` - Query by project
- `idx_backups_created_at` - Date range queries
- `idx_backups_project_created` - Composite index for common queries
- `idx_backups_type` - Filter by type
- `idx_backups_expires_at` - Cleanup queries

---

## Restoring from Backup

### Database Restore

**Endpoint:** `POST /api/backup/restore`

**Authentication:** JWT required

**Request Body:**

```json
{
  "backup_id": "uuid-backup-id",
  "confirm": true
}
```

**Parameters:**

- `backup_id` (string, required): Backup ID from history
- `confirm` (boolean, required): Must be `true` to prevent accidental restores

**Response:**

```json
{
  "data": {
    "job_id": "uuid-here",
    "status": "pending",
    "backup_id": "uuid-backup-id",
    "project_id": "your-project-id",
    "created_at": "2026-01-29T12:00:00Z"
  }
}
```

**Warning:** Restoring from backup will overwrite existing data. This operation cannot be undone.

### Restore Process

1. **Validation** - Verify backup exists and user has permissions
2. **Fetch** - Download backup file from Telegram
3. **Decompress** - Extract backup if compressed
4. **Restore** - Execute SQL dump to database
5. **Verify** - Confirm restore completed successfully

**Typical restore times:**

- Small databases (<100MB): 1-5 minutes
- Medium databases (100MB-1GB): 5-15 minutes
- Large databases (>1GB): 15-60 minutes

### Manual Restore Steps

If you need to restore manually:

1. **Download backup from Telegram:**
   ```bash
   # Use Telegram Bot API to download file
   curl "https://api.telegram.org/bot<BOT_TOKEN>/getFile?file_id=<FILE_ID>"
   ```

2. **Decompress if needed:**
   ```bash
   gunzip backup.sql.gz
   ```

3. **Restore to database:**
   ```bash
   psql -h localhost -U postgres -d your_database -f backup.sql
   ```

---

## Retention Policy

### Default Retention

All backups are retained for **30 days** by default.

- **Created:** Backup timestamp
- **Expires:** Created timestamp + 30 days
- **Cleanup:** Automatic deletion after expiration

### Retention Policy Details

**Automatic Cleanup:**

- Background job runs daily to delete expired backups
- Removes records from `control_plane.backups` table
- Deletes files from Telegram storage
- Sends notification before deletion (7 days warning)

**Expiration Warning:**

Backups expiring within 7 days are flagged:

```sql
SELECT
  id,
  type,
  created_at,
  expires_at
FROM control_plane.backups
WHERE project_id = 'your-project-id'
  AND expires_at <= NOW() + INTERVAL '7 days'
  AND expires_at > NOW();
```

**Custom Retention:**

Contact support to configure custom retention periods for specific projects.

**Permanent Backups:**

For long-term archival requirements:
1. Download backup before expiration
2. Store in your preferred archival solution
3. Re-upload when needed

### Retention Query Examples

**Find expired backups:**

```sql
SELECT * FROM control_plane.backups
WHERE expires_at < NOW();
```

**Find backups expiring soon:**

```sql
SELECT * FROM control_plane.backups
WHERE expires_at <= NOW() + INTERVAL '7 days'
  AND expires_at > NOW();
```

**Count backups by age:**

```sql
SELECT
  type,
  COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '7 days') as last_7_days,
  COUNT(*) FILTER (WHERE created_at > NOW() - INTERVAL '30 days') as last_30_days,
  COUNT(*) as total
FROM control_plane.backups
WHERE project_id = 'your-project-id'
GROUP BY type;
```

---

## Security Considerations

### Access Control

**Authentication Required:**

- All backup endpoints require valid JWT token
- Token must have `backup:read` or `backup:write` scope
- Project-level permissions enforced

**Authorization:**

- Users can only backup their own projects
- Organization admins can backup all projects in org
- Platform operators have system-wide backup access

### Data Protection

**Encryption:**

- Backups transmitted via HTTPS/TLS 1.3
- Telegram storage uses server-side encryption
- At-rest encryption in Telegram cloud

**Data Privacy:**

- Backups contain all project data
- Handle backup files with same security as production database
- Delete local backup files after restore

**Audit Trail:**

- All backup operations logged to `project_logs`
- Backup history table records who created each backup
- Restore operations require explicit confirmation

### Best Practices

**Before Creating Backups:**

- Verify sufficient storage space
- Check for ongoing migrations or deployments
- Notify team members of planned backup
- Document backup purpose and retention need

**After Creating Backups:**

- Verify backup completed successfully
- Check backup size is reasonable
- Confirm backup appears in history
- Test restore on non-production environment

**Backup Security:**

- Never share backup files via unencrypted channels
- Delete local copies after upload to Telegram
- Rotate JWT tokens regularly
- Monitor backup access logs

---

## Best Practices

### Backup Scheduling

**Recommended Backup Frequency:**

- **Critical production:** Daily backups
- **Standard production:** Weekly backups
- **Development/staging:** Before major changes

**Optimal Backup Times:**

- Schedule during low-traffic periods
- Avoid during maintenance windows
- Consider timezone of your users
- Account for automated job schedules

### Backup Testing

**Test Restore Procedure:**

1. Create test backup
2. Restore to staging environment
3. Verify data integrity
4. Test application functionality
5. Document any issues

**Regular Testing:**

- Test quarterly restores
- Verify backup integrity monthly
- Update documentation with lessons learned

### Disaster Recovery Planning

**Recovery Time Objective (RTO):**

- Database restore: 15-60 minutes
- Depends on database size and Telegram download speed

**Recovery Point Objective (RPO):**

- Maximum data loss: Time since last backup
- Plan backup frequency accordingly

**Disaster Recovery Checklist:**

- [ ] Recent backup available (<24 hours)
- [ ] Backup tested via restore
- [ ] JWT tokens valid and accessible
- [ ] Telegram credentials available
- [ ] Team trained on restore procedure
- [ ] Runbook documented and accessible

### Cost Optimization

**Telegram Storage Costs:**

- First 2GB: Free
- Beyond 2GB: Automatic split handling
- No additional cost for backup storage

**Best Practices:**

- Implement proper retention policy
- Clean up old backups regularly
- Monitor backup sizes
- Archive old backups to cheaper storage

---

## Troubleshooting

### Common Issues

#### Backup Job Stuck in "Pending" Status

**Symptoms:** Backup job created but not processing

**Solutions:**

1. Check job queue status:
   ```sql
   SELECT * FROM control_plane.jobs
   WHERE id = 'job-id'
   ORDER BY created_at DESC;
   ```

2. Verify job worker is running:
   ```bash
   ps aux | grep job-worker
   ```

3. Check job worker logs:
   ```bash
   tail -f /var/log/job-worker.log
   ```

#### Backup Download Failed

**Symptoms:** Telegram file download fails

**Solutions:**

1. Verify Telegram bot token is valid
2. Check file_id exists in backup history
3. Test Telegram API connectivity
4. Verify file hasn't expired on Telegram

#### Restore Takes Too Long

**Symptoms:** Restore job running for extended period

**Solutions:**

1. Check database size
2. Verify network bandwidth
3. Check database server resources
4. Consider incremental backup for large databases

#### Backup File Too Large

**Symptoms:** Backup exceeds storage limits

**Solutions:**

1. Enable compression
2. Exclude unnecessary tables/data
3. Use partial backups for specific tables
4. Consider partitioned backup strategy

### Debug Commands

**Check backup job status:**

```sql
SELECT
  id,
  status,
  error_message,
  created_at,
  updated_at
FROM control_plane.jobs
WHERE type = 'export_backup'
  AND project_id = 'your-project-id'
ORDER BY created_at DESC;
```

**Verify backup file in Telegram:**

```bash
# Get file info
curl "https://api.telegram.org/bot<BOT_TOKEN>/getFile?file_id=<FILE_ID>"

# Download file
curl "https://api.telegram.org/file/bot<BOT_TOKEN>/<FILE_PATH>" -o backup.sql.gz
```

**Check backup history integrity:**

```sql
SELECT
  type,
  COUNT(*) as count,
  SUM(size) as total_size,
  MIN(created_at) as oldest,
  MAX(created_at) as newest
FROM control_plane.backups
WHERE project_id = 'your-project-id'
GROUP BY type;
```

### Getting Help

**If issues persist:**

1. Check logs: `/var/log/backup-service.log`
2. Review job errors in database
3. Verify all prerequisites are met
4. Contact support with:
   - Project ID
   - Backup ID or Job ID
   - Error messages
   - Steps to reproduce

**Support Channel:**

- Use the support button in your project dashboard
- Include context from the error
- Attach relevant logs

---

## Additional Resources

### API Documentation

- [Backup API Reference](/api/docs/backup)
- [Jobs API Reference](/api/docs/jobs)
- [Authentication Guide](/docs/authentication)

### Related Documentation

- [Database Schema](/docs/database-schema)
- [Storage Architecture](/docs/storage)
- [Security Best Practices](/docs/security)
- [Disaster Recovery](/docs/disaster-recovery)

### Internal Documentation

- [Backup PRD](/docs/prd-backup-strategy.md)
- [Backup Migration Scripts](/database/migrations/009_create_backups_table.sql)
- [Backup Service Implementation](/api-gateway/src/lib/backups/backups.service.ts)

---

## Changelog

### Version 1.0.0 (2026-01-29)

**Initial Release**

- Database backup via manual export API
- Telegram integration for backup storage
- Backup history tracking
- 30-day retention policy
- Restore from backup functionality

**Planned Features:**

- Automated scheduled backups
- Incremental backups
- Cross-region backup replication
- Backup encryption at rest
- Backup validation and integrity checks

---

## Support

For questions or issues with backups:

1. Check this documentation first
2. Review the troubleshooting section
3. Check existing backup history
4. Use the in-app support button
5. Contact platform support

**Backup Support Response Time:**

- Critical data loss: <1 hour
- Backup creation issues: <4 hours
- General questions: <24 hours

---

*Last Updated: 2026-01-29*
*Document Version: 1.0.0*
*Related PRD: US-007 - Document Backup Strategy*
